<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agregar carga de combustible</title>
  <style>
    body{margin:0;background:#FFD700;font-family:Arial,sans-serif;color:#fff}
    .wrap{max-width:540px;margin:40px auto;background:#000;border-radius:12px;padding:24px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 16px;text-align:center;text-transform:uppercase;text-decoration:underline}
    label{display:block;margin:10px 0 6px;font-weight:bold;text-transform:uppercase}
    input,select{width:100%;padding:10px;border:1px solid #000;border-radius:6px;background:#fff;color:#000;box-sizing:border-box}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    .actions{display:flex;gap:10px;margin-top:14px}
    .btn{flex:1;padding:10px;border:1px solid #000;border-radius:8px;font-weight:bold;cursor:pointer;text-transform:uppercase}
    .btn-naranja{background:orange;color:#000}
    .btn-verde{background:green;color:#fff}
    .note{font-size:12px;opacity:.85;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Agregar carga de combustible</h1>

    <form id="form">
      <label>Fecha de carga</label>
      <input type="date" id="fFecha" required/>

      <label>Cantidad de litros</label>
      <input type="number" id="fLitros" step="0.01" min="0" required/>

      <label>Precio por litro</label>
      <input type="text" id="fPrecio"/>

      <label>Total pagado</label>
      <input type="text" id="fTotal"/>

      <label>Estación de servicio</label>
      <input type="text" id="fEstacion"/>

      <label>Tipo de combustible</label>
      <select id="fTipo">
        <option value="">Seleccionar…</option>
        <option>Nafta</option>
        <option>Gasoil</option>
        <option>Euro</option>
        <option>Otro</option>
      </select>

      <label>Patente del camión</label>
      <input type="text" id="fPatente" placeholder="ABC123 / AB123CD"/>

      <div class="actions">
        <button type="button" class="btn btn-naranja" id="btnVolver">Volver</button>
        <button type="submit" class="btn btn-verde" id="btnGuardar">Guardar carga</button>
      </div>
      <div class="note">Podés completar **Precio** o **Total**; si ambos están, se usa tal cual.</div>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
      authDomain: "transporte-mario-guizzo.firebaseapp.com",
      projectId: "transporte-mario-guizzo",
      storageBucket: "transporte-mario-guizzo.appspot.com",
      messagingSenderId: "465536166890",
      appId: "1:465536166890:web:f658690629b09eca8fa093"
    };

    // ---------- App ----------
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ---------- Routing de retorno ----------
    const qs = new URLSearchParams(location.search);
    const from = qs.get('from') || '';
    const returnUrl = qs.get('return') || (from === 'admin' ? 'ver-combustible-admin.html' : 'index.html');

    // ---------- Helpers ----------
    // Convierte "1.450", "1.450,50", "1450" a número
    const toNum = (v) => {
      if (typeof v === 'number') return v;
      if (typeof v === 'string') {
        const s = v.replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'.');
        const n = Number(s);
        return isNaN(n) ? 0 : n;
      }
      const n = Number(v);
      return isNaN(n) ? 0 : n;
    };

    // Espera un usuario listo antes de permitir guardar
    let currentUser = null;
    onAuthStateChanged(auth, (u) => {
      if (!u) { window.location.href = "login.html"; return; }
      currentUser = u;
      if (!document.getElementById('fFecha').value) {
        document.getElementById('fFecha').value = new Date().toISOString().slice(0,10);
      }
      document.getElementById('btnGuardar').disabled = false;
    });

    const fFecha    = document.getElementById('fFecha');
    const fLitros   = document.getElementById('fLitros');
    const fPrecio   = document.getElementById('fPrecio');
    const fTotal    = document.getElementById('fTotal');
    const fEstacion = document.getElementById('fEstacion');
    const fTipo     = document.getElementById('fTipo');
    const fPatente  = document.getElementById('fPatente');

    // Mayúsculas en patente
    fPatente.addEventListener('input', e => e.target.value = e.target.value.toUpperCase());

    document.getElementById('btnVolver').onclick = () => { window.location.href = returnUrl; };

    document.getElementById('form').addEventListener('submit', async (e)=>{
      e.preventDefault();

      if (!currentUser) { alert("Debés iniciar sesión."); return; }

      // Validación mínima
      if (!fFecha.value || !fLitros.value) { alert('Completá fecha y litros.'); return; }

      const litros = toNum(fLitros.value);
      const precioPorLitro = fPrecio.value === '' ? null : toNum(fPrecio.value);
      const totalPagado    = fTotal.value  === '' ? null : toNum(fTotal.value);
      const patenteNorm    = (fPatente.value||'').trim().toUpperCase();

      const data = {
        fecha: fFecha.value,
        litros,
        precioPorLitro,
        totalPagado,
        estacionServicio: (fEstacion.value||'').trim(),
        tipoCombustible: fTipo.value || '',
        // Guardamos ambas variantes para máxima compatibilidad con las reglas:
        patente: patenteNorm,
        patenteCamion: patenteNorm,
        uidCreador: currentUser.uid,   // <- CLAVE para pasar createdByMe(...)
        creadoPor: currentUser.uid,    // <- redundancia compatible
        timestamp: serverTimestamp()
      };

      try{
        // Usa el MISMO nombre de colección que protegen tus reglas
        await addDoc(collection(db,'cargas-combustible'), data);
        alert('Carga guardada con éxito.');
        window.location.href = returnUrl;
      }catch(err){
        alert('Error al guardar: ' + (err.message || err.code));
      }
    });
  </script>
</body>
</html>
