<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MANTENIMIENTO</title>

<style>
  :root{
    --amarillo:#FFD700;
    --negro:#0b0b0b;
    --gris:#191919;
    --blanco:#fff;
    --verde:#0c8d2b;
    --naranja:#f3a300;
    --azul:#2b6cb0;
    --rojo:#e53935;
  }
  body{margin:0;background:var(--amarillo);font-family:Arial,Helvetica,sans-serif;color:#fff}
  .container{background:#000;max-width:1000px;margin:28px auto;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:18px}
  h1{text-align:center;margin:4px 0 16px;text-transform:uppercase;text-decoration:underline}
  .toolbar{display:grid;grid-template-columns:repeat(5,1fr) 1.2fr 1fr;gap:8px;margin-bottom:10px}
  .toolbar input,.toolbar select{padding:10px;border:1px solid #000;border-radius:6px;background:#fff;color:#000}
  .btn{padding:10px 14px;border:1px solid #000;border-radius:8px;font-weight:700;text-transform:uppercase;cursor:pointer}
  .btn-naranja{background:var(--naranja);color:#000}
  .btn-azul{background:var(--azul);color:#fff}
  .btn-volver{background:var(--naranja);color:#000;margin-top:12px}

  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0 18px}
  .stat{background:#0f0f0f;border-radius:12px;padding:14px;text-align:center}
  .stat b{display:block;font-size:28px;margin-top:4px}

  .lista{display:grid;gap:12px}
  .item{
    background:var(--gris);
    border-radius:10px;
    padding:12px 12px 12px 56px; /* CHANGED: más padding para que no se superponga “Elegir” con “Fecha” */
    position:relative;
  }

  /* CHANGED: radio selector fijo y centrado a la izquierda */
  .pick{
    position:absolute;
    left:16px;
    top:50%;
    transform:translateY(-50%);
    display:flex;
    align-items:center;
    gap:6px;
    color:#bbb;
    font-size:12px;
    user-select:none;
  }
  .pick input{width:18px;height:18px;cursor:pointer}
  /* CHANGED: oculto el texto “Elegir” para que no ocupe ancho. Borrá esta línea si querés verlo */
  .pick span{display:none;}

  .chip{display:inline-block;background:#333;padding:3px 8px;border-radius:999px;font-size:12px;margin-left:8px}
  .chip-adeuda{background:#7a2a2a}
  .chip-pagado{background:#1b6b2a}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .acciones{display:flex;gap:8px;justify-content:flex-end;margin-top:10px} /* CHANGED: botón alineado a la derecha */
  .btn-verde{background:var(--verde);color:#fff;border:1px solid #000;border-radius:8px;padding:8px 10px;font-weight:700;cursor:pointer}
  .rep-toggle{cursor:pointer;color:#bbb}

  /* Modal básico para edición (misma estética que ya venías usando) */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center;z-index:50}
  .modal-content{background:#000;border-radius:12px;padding:16px;width:95%;max-width:680px}
  .modal h2{margin-top:0;text-decoration:underline}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .modal input,.modal select,.modal textarea{padding:10px;border:1px solid #000;border-radius:6px;background:#fff;color:#000}
  .modal textarea{min-height:80px}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .btn-rojo{background:var(--rojo);color:#fff;border:1px solid #000;border-radius:8px;padding:10px 12px;font-weight:700;cursor:pointer}

  @media (max-width: 820px){
    .toolbar{grid-template-columns:1fr 1fr}
    .stats{grid-template-columns:1fr 1fr}
  }
</style>
</head>
<body>
  <div class="container">
    <h1>Mantenimiento</h1>

    <div class="toolbar">
      <input type="date" id="fDesde">
      <input type="date" id="fHasta">
      <select id="fPatente"><option value="">Todas las patentes</option></select>
      <select id="fTipo">
        <option value="">Todos los tipos</option>
        <option>Servicio</option>
        <option>Cambio de aceite</option>
        <option>Filtros</option>
        <option>Cubiertas</option>
        <option>Frenos</option>
        <option>Reparación</option>
        <option>Otro</option>
      </select>
      <select id="fEstado">
        <option value="">Todos (pagado/adeudado)</option>
        <option value="adeudado">Adeudado</option>
        <option value="pagado">Pagado</option>
      </select>
      <input id="fTexto" placeholder="Buscar (proveedor, repuesto)">
      <button class="btn btn-naranja" id="btnLimpiar">Limpiar filtros</button>
      <button class="btn btn-azul" id="btnImprimir">Imprimir</button>
    </div>

    <div class="stats">
      <div class="stat"><div>TOTAL $</div><b id="stTotal">0</b></div>
      <div class="stat"><div>REGISTROS</div><b id="stRegs">0</b></div>
      <div class="stat"><div>ADEUDADOS</div><b id="stAdeu">0</b></div>
      <div class="stat"><div>PRÓX. 7 DÍAS</div><b id="stProx">0</b></div>
    </div>

    <div id="lista" class="lista"></div>

    <button class="btn btn-volver" onclick="location.href='admin.html'">Volver</button>
  </div>

  <!-- Modal edición (resumen igual a tu versión previa) -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2>Editar Mantenimiento</h2>
      <div class="grid-2">
        <div>
          <label>Fecha</label>
          <input type="date" id="m_fecha">
        </div>
        <div>
          <label>Tipo</label>
          <select id="m_tipo">
            <option>Servicio</option>
            <option>Cambio de aceite</option>
            <option>Filtros</option>
            <option>Cubiertas</option>
            <option>Frenos</option>
            <option>Reparación</option>
            <option>Otro</option>
          </select>
        </div>
        <div>
          <label>Patente</label>
          <input id="m_patente">
        </div>
        <div>
          <label>Proveedor/Taller</label>
          <input id="m_proveedor">
        </div>
        <div>
          <label>KM</label>
          <input id="m_km">
        </div>
        <div>
          <label>Pagado</label>
          <select id="m_pagado">
            <option value="false">No (adeudado)</option>
            <option value="true">Sí (pagado)</option>
          </select>
        </div>
        <div>
          <label>Mano de obra ($)</label>
          <input id="m_mano" type="number" step="0.01">
        </div>
        <div>
          <label>Otros ($)</label>
          <input id="m_otros" type="number" step="0.01">
        </div>
        <div>
          <label>Total ($)</label>
          <input id="m_total" type="number" step="0.01">
        </div>
        <div>
          <label>Próximo (fecha)</label>
          <input id="m_proximo" type="date">
        </div>
        <div style="grid-column:1/-1">
          <label>Observaciones</label>
          <textarea id="m_obs"></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-rojo" id="btnEliminar">Eliminar</button>
        <button class="btn btn-azul" id="btnGuardar">Guardar</button>
        <button class="btn btn-naranja" id="btnCerrar">Cerrar</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // TU CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
    authDomain: "transporte-mario-guizzo.firebaseapp.com",
    projectId: "transporte-mario-guizzo",
    storageBucket: "transporte-mario-guizzo.appspot.com",
    messagingSenderId: "465536166890",
    appId: "1:465536166890:web:f658690629b09eca8fa093"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // ---- Estado
  let todos = [];
  let selectedId = null;
  let editId = null;

  // ---- Filtros
  const fDesde   = document.getElementById('fDesde');
  const fHasta   = document.getElementById('fHasta');
  const fPatente = document.getElementById('fPatente');
  const fTipo    = document.getElementById('fTipo');
  const fEstado  = document.getElementById('fEstado');
  const fTexto   = document.getElementById('fTexto');

  const lista    = document.getElementById('lista');
  const stTotal  = document.getElementById('stTotal');
  const stRegs   = document.getElementById('stRegs');
  const stAdeu   = document.getElementById('stAdeu');
  const stProx   = document.getElementById('stProx');

  onSnapshot(collection(db,'mantenimientos'), (qs)=>{
    todos = qs.docs.map(d => ({ id:d.id, ...d.data() }));
    todos.sort((a,b)=> String(b.fecha||'').localeCompare(String(a.fecha||'')));
    poblarPatentes();
    render();
  });

  function poblarPatentes(){
    const set = new Set(todos.map(x => (x.patente||'').trim()).filter(Boolean));
    const sel = fPatente.value;
    fPatente.innerHTML = '<option value="">Todas las patentes</option>' +
      [...set].sort().map(p => `<option value="${p}">${p}</option>`).join('');
    if (sel) fPatente.value = sel;
  }

  function pasaFiltros(v){
    if (fDesde.value && (v.fecha||'') < fDesde.value) return false;
    if (fHasta.value && (v.fecha||'') > fHasta.value) return false;
    if (fPatente.value && (v.patente||'') !== fPatente.value) return false;
    if (fTipo.value && (v.tipo||'') !== fTipo.value) return false;
    if (fEstado.value){
      const adeu = !Boolean(v.pagado);
      if (fEstado.value==='adeudado' && !adeu) return false;
      if (fEstado.value==='pagado' && adeu)  return false;
    }
    const q = fTexto.value.trim().toLowerCase();
    if (q){
      const rep = (v.repuestos||[]).map(r => (r.desc||'')+' '+(r.costo||'')).join(' ');
      const blob = [v.proveedor||'', rep].join(' ').toLowerCase();
      if (!blob.includes(q)) return false;
    }
    return true;
  }

  function totalFrom(v){
    if (v.total!=null) return Number(v.total)||0;
    const rep = (v.repuestos||[]).reduce((a,r)=> a + (Number(r.costo)||0), 0);
    return rep + (Number(v.manoDeObra)||0) + (Number(v.otros)||0);
  }

  function diasHasta(fecha){
    if (!fecha) return 9999;
    const d = ( new Date(fecha) - new Date() ) / (1000*60*60*24);
    return Math.floor(d);
  }

  function render(){
    const datos = todos.filter(pasaFiltros);
    lista.innerHTML = '';

    // stats
    stTotal.textContent = '$ ' + new Intl.NumberFormat('es-AR').format(datos.reduce((a,v)=> a + totalFrom(v), 0));
    stRegs.textContent  = datos.length;
    stAdeu.textContent  = datos.filter(v => !v.pagado).length;
    stProx.textContent  = datos.filter(v => (diasHasta(v.proximoFecha)<=7)).length;

    for (const v of datos){
      const chip = v.pagado ? `<span class="chip chip-pagado">Pagado</span>` :
                               `<span class="chip chip-adeuda">Adeudado</span>`;

      const repCount = (v.repuestos||[]).length;
      const repList  = (v.repuestos||[]).map(r => `<li>${(r.desc||'').trim()} — $ ${new Intl.NumberFormat('es-AR').format(Number(r.costo)||0)}</li>`).join('');

      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <!-- CHANGED: selector de registro fijo, sin superponer “Fecha” -->
        <label class="pick" title="Seleccionar">
          <input type="radio" name="selMant" ${selectedId===v.id?'checked':''}
            onchange="window._select('${v.id}')">
          <span>Elegir</span>
        </label>

        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <div><b>Fecha:</b> ${v.fecha || '-'} ${chip}</div>
            <div><b>Tipo:</b> ${v.tipo||'-'} <b>| Proveedor:</b> ${v.proveedor||'-'} <b>| KM:</b> ${v.km||'-'}</div>
            <div><b>Total:</b> $ ${new Intl.NumberFormat('es-AR').format(totalFrom(v))} <b>| Próximo:</b> ${v.proximoFecha||'-'}</div>
            ${repCount ? `
              <details style="margin-top:6px">
                <summary class="rep-toggle">Ver repuestos (${repCount})</summary>
                <ul style="margin:6px 0 0 12px">${repList}</ul>
              </details>` : ''
            }
          </div>

          <div class="acciones">
            <button class="btn-verde" onclick="window._edit('${v.id}')">Ver / Editar</button>
          </div>
        </div>
      `;
      lista.appendChild(div);
    }
  }

  // listeners
  [fDesde,fHasta,fPatente,fTipo,fEstado,fTexto].forEach(el => el.addEventListener('input', render));
  document.getElementById('btnLimpiar').onclick = () => {
    fDesde.value=''; fHasta.value=''; fPatente.value=''; fTipo.value=''; fEstado.value=''; fTexto.value='';
    render();
  };

  // selección
  window._select = id => { selectedId = id; };

  // imprimir
  document.getElementById('btnImprimir').onclick = () => {
    if (!selectedId){ alert('Elegí un mantenimiento para imprimir.'); return; }
    const v = todos.find(x => x.id===selectedId);
    if (!v){ alert('No se encontró el registro seleccionado.'); return; }

    const rep = (v.repuestos||[]).map(r =>
      `<tr><td>${(r.desc||'').trim()}</td><td style="text-align:right">$ ${new Intl.NumberFormat('es-AR').format(Number(r.costo)||0)}</td></tr>`
    ).join('');

    const html = `
      <html><head>
        <meta charset="utf-8">
        <title>Mantenimiento ${v.patente||''} - ${v.fecha||''}</title>
        <style>
          body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#000}
          h2{margin:0 0 12px;text-align:center}
          table{width:100%;border-collapse:collapse;margin-top:10px}
          td{padding:6px;border-bottom:1px solid #ddd}
          .tot{font-weight:700}
          .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
        </style>
      </head>
      <body>
        <h2>Mantenimiento</h2>
        <div><b>Fecha:</b> ${v.fecha||'-'}</div>
        <div><b>Patente:</b> ${v.patente||'-'}</div>
        <div><b>Tipo:</b> ${v.tipo||'-'}</div>
        <div><b>Proveedor/Taller:</b> ${v.proveedor||'-'}</div>
        <div><b>KM:</b> ${v.km||'-'}</div>
        <div><b>Estado:</b> ${v.pagado ? 'Pagado' : 'Adeudado'}</div>
        <div><b>Próximo:</b> ${v.proximoFecha||'-'}</div>

        <table>
          <tr><td>Mano de obra</td><td style="text-align:right">$ ${new Intl.NumberFormat('es-AR').format(Number(v.manoDeObra)||0)}</td></tr>
          <tr><td>Otros</td><td style="text-align:right">$ ${new Intl.NumberFormat('es-AR').format(Number(v.otros)||0)}</td></tr>
          ${rep}
          <tr class="tot"><td>Total</td><td style="text-align:right">$ ${new Intl.NumberFormat('es-AR').format(totalFrom(v))}</td></tr>
        </table>

        <div style="margin-top:12px"><b>Observaciones:</b><br><div class="mono">${(v.observaciones||'').replaceAll('<','&lt;')}</div></div>
        <script>window.onload=()=>window.print()</script>
      </body></html>
    `;

    const w = window.open('', '_blank');
    w.document.write(html);
    w.document.close();
  };

  // ---- Modal edición (simple)
  const modal = document.getElementById('modal');
  const m = id => document.getElementById(id);
  window._edit = (id)=>{
    const v = todos.find(x => x.id===id); if(!v) return;
    editId = id;
    m('m_fecha').value = v.fecha||'';
    m('m_tipo').value  = v.tipo||'Servicio';
    m('m_patente').value = v.patente||'';
    m('m_proveedor').value = v.proveedor||'';
    m('m_km').value = v.km||'';
    m('m_pagado').value = String(Boolean(v.pagado));
    m('m_mano').value = v.manoDeObra||0;
    m('m_otros').value = v.otros||0;
    m('m_total').value = totalFrom(v);
    m('m_proximo').value = v.proximoFecha||'';
    m('m_obs').value = v.observaciones||'';
    modal.style.display='flex';
  };
  document.getElementById('btnCerrar').onclick = ()=> modal.style.display='none';
  document.getElementById('btnGuardar').onclick = async ()=>{
    if(!editId) return;
    const data = {
      fecha: m('m_fecha').value||null,
      tipo: m('m_tipo').value||'Servicio',
      patente: m('m_patente').value.trim(),
      proveedor: m('m_proveedor').value.trim(),
      km: m('m_km').value.trim(),
      pagado: m('m_pagado').value==='true',
      manoDeObra: Number(m('m_mano').value||0),
      otros: Number(m('m_otros').value||0),
      total: Number(m('m_total').value||0),
      proximoFecha: m('m_proximo').value||'',
      observaciones: m('m_obs').value.trim()
    };
    await updateDoc(doc(db,'mantenimientos',editId), data);
    modal.style.display='none';
  };
  document.getElementById('btnEliminar').onclick = async ()=>{
    if(!editId) return;
    if(!confirm('¿Eliminar este mantenimiento?')) return;
    await deleteDoc(doc(db,'mantenimientos',editId));
    modal.style.display='none';
  };
</script>
</body>
</html>
