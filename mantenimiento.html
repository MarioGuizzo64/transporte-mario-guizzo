<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mantenimiento</title>
  <style>
    :root{
      --amarillo:#FFD700; --negro:#0d0d0d; --panel:#111; --gris:#222;
      --verde:#2e7d32; --naranja:#ffa500; --rojo:#e53935; --blanco:#fff;
    }
    body{margin:0;background:var(--amarillo);font-family:Arial,sans-serif;color:#fff}
    .wrap{max-width:900px;margin:38px auto;background:var(--panel);border-radius:12px;padding:18px}
    h1{text-align:center;margin:4px 0 16px;text-transform:uppercase;text-decoration:underline}
    .filtros{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:12px}
    .filtros input,.filtros select{padding:8px;border:1px solid #000;border-radius:6px;background:#fff;color:#000}
    .btn{padding:10px;border:1px solid #000;border-radius:6px;font-weight:bold;text-transform:uppercase;cursor:pointer}
    .btn-naranja{background:var(--naranja);color:#000}
    .btn-verde{background:var(--verde);color:#fff}
    .btn-rojo{background:var(--rojo);color:#fff}
    .btn-outline{background:#0000;color:#fff;border-color:#333}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:12px 0}
    .stat{background:var(--gris);border-radius:10px;padding:10px;text-align:center}
    .stat b{display:block;font-size:18px;margin-top:2px}
    .lista{display:grid;gap:10px}
    .item{background:#191919;border-radius:10px;padding:12px;position:relative}
    .badge{position:absolute;top:10px;right:10px;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .b-pend{background:#b71c1c} .b-adeuda{background:#ef6c00} .b-pagado{background:#1b5e20}
    .item p{margin:3px 0}
    .acciones{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px}
    .volver{margin-top:14px}
    @media (max-width:800px){
      .filtros{grid-template-columns:1fr 1fr}
      .stats{grid-template-columns:1fr}
    }

    /* Modal simple */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center}
    .modal-content{background:#000;border-radius:12px;padding:16px;width:95%;max-width:600px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .modal-content input,.modal-content select,.modal-content textarea{padding:8px;border:1px solid #000;border-radius:6px;background:#fff;color:#000}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Mantenimiento</h1>

    <!-- FILTROS -->
    <form id="formFiltros" class="filtros">
      <input type="date" id="fDesde">
      <input type="date" id="fHasta">
      <select id="fPatente"><option value="">Todas las patentes</option></select>
      <select id="fTipo">
        <option value="">Todos los tipos</option>
        <option>Servicio</option><option>Cambio de aceite</option><option>Filtros</option>
        <option>Cubiertas</option><option>Frenos</option><option>Reparación</option><option>Otro</option>
      </select>
      <select id="fEstado">
        <option value="">Todos los estados</option>
        <option value="pendiente">Pendiente</option>
        <option value="adeuda">Adeuda</option>
        <option value="pagado">Pagado</option>
      </select>
      <input type="text" id="fQ" placeholder="Buscar (proveedor, repuesto, obs)">
      <button type="button" id="btnLimpiar" class="btn btn-naranja">Limpiar filtros</button>
    </form>

    <!-- RESUMEN -->
    <div class="stats">
      <div class="stat"><small>TOTAL $</small><b id="sTotal">$ 0</b></div>
      <div class="stat"><small>REGISTROS</small><b id="sRegs">0</b></div>
      <div class="stat"><small>PRÓX. 7 DÍAS</small><b id="sProx">0</b></div>
    </div>

    <!-- LISTA -->
    <div id="lista" class="lista"></div>

    <button class="btn btn-naranja volver" onclick="location.href='admin.html'">Volver</button>
  </div>

  <!-- MODAL EDITAR -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2 style="margin-top:0;text-transform:uppercase;text-decoration:underline">Editar mantenimiento</h2>
      <form id="formEdit" class="grid2">
        <label>Fecha
          <input type="date" id="e_fecha">
        </label>
        <label>Próx. fecha
          <input type="date" id="e_prox">
        </label>
        <label>Patente
          <input type="text" id="e_patente">
        </label>
        <label>Tipo
          <select id="e_tipo">
            <option>Servicio</option><option>Cambio de aceite</option><option>Filtros</option>
            <option>Cubiertas</option><option>Frenos</option><option>Reparación</option><option>Otro</option>
          </select>
        </label>
        <label>Proveedor
          <input type="text" id="e_proveedor">
        </label>
        <label>KM
          <input type="number" id="e_km" min="0" step="1">
        </label>
        <label>Repuestos (texto)
          <textarea id="e_repuestos" rows="3"></textarea>
        </label>
        <label>Mano de obra ($)
          <input type="number" id="e_mo" min="0" step="0.01">
        </label>
        <label>Otros ($)
          <input type="number" id="e_otros" min="0" step="0.01">
        </label>
        <label>Total ($)
          <input type="number" id="e_total" min="0" step="0.01">
        </label>
        <label>Estado
          <select id="e_estado">
            <option value="pendiente">Pendiente</option>
            <option value="adeuda">Adeuda</option>
            <option value="pagado">Pagado</option>
          </select>
        </label>
        <label style="grid-column:1/-1">Observaciones
          <textarea id="e_obs" rows="3"></textarea>
        </label>
      </form>
      <div class="modal-actions">
        <button id="btnGuardar" class="btn btn-verde" type="button">Guardar</button>
        <button id="btnCerrar" class="btn btn-naranja" type="button">Cerrar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
      authDomain: "transporte-mario-guizzo.firebaseapp.com",
      projectId: "transporte-mario-guizzo",
      storageBucket: "transporte-mario-guizzo.appspot.com",
      messagingSenderId: "465536166890",
      appId: "1:465536166890:web:f658690629b09eca8fa093"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const col = collection(db,"mantenimientos");

    const $ = (id)=>document.getElementById(id);
    const lista = $("lista");

    const fDesde=$("fDesde"), fHasta=$("fHasta"), fPatente=$("fPatente"), fTipo=$("fTipo"), fEstado=$("fEstado"), fQ=$("fQ");
    const sTotal=$("sTotal"), sRegs=$("sRegs"), sProx=$("sProx");
    const btnLimpiar=$("btnLimpiar");

    let all = [];      // todos los mantenimientos
    let current = null; // item en edición

    // Helpers
    const todayStr = ()=> new Date().toISOString().slice(0,10);
    const inNext7 = (d)=>{
      if(!d) return false;
      const t = new Date(); t.setHours(0,0,0,0);
      const n7= new Date(t); n7.setDate(n7.getDate()+7);
      const dd=new Date(d); dd.setHours(0,0,0,0);
      return dd>=t && dd<=n7;
    };

    // Cargar en tiempo real
    onSnapshot(col,(qs)=>{
      all = qs.docs.map(d=>({id:d.id, ...d.data()}));
      all.sort((a,b)=> String(b.fecha||"").localeCompare(String(a.fecha||"")));
      poblarPatentes();
      render();
    });

    function poblarPatentes(){
      const sel=fPatente.value;
      const pats=[...new Set(all.map(x=>x.patente).filter(Boolean))].sort();
      fPatente.innerHTML='<option value="">Todas las patentes</option>'+pats.map(p=>`<option>${p}</option>`).join('');
      if(sel) fPatente.value=sel;
    }

    function pasaFiltros(it){
      if (fDesde.value && String(it.fecha||"") < fDesde.value) return false;
      if (fHasta.value && String(it.fecha||"") > fHasta.value) return false;
      if (fPatente.value && (it.patente||"") !== fPatente.value) return false;
      if (fTipo.value && (it.tipo||"") !== fTipo.value) return false;
      if (fEstado.value && (it.estado||"") !== fEstado.value) return false;

      const q=fQ.value.trim().toLowerCase();
      if(q){
        const blob=[it.proveedor, it.repuestos && (Array.isArray(it.repuestos)? it.repuestos.join(" "): it.repuestos), it.observaciones, it.tipo, it.patente]
          .map(x=>(x||"")+"").join(" ").toLowerCase();
        if(!blob.includes(q)) return false;
      }
      return true;
    }

    function money(n){ n = Number(n||0); return "$ " + n.toLocaleString("es-AR", {minimumFractionDigits:0}); }

    function render(){
      const data = all.filter(pasaFiltros);
      lista.innerHTML="";

      // Stats
      const total = data.reduce((a,b)=>a+(Number(b.total)||0),0);
      const regs  = data.length;
      const prox7 = data.reduce((a,b)=> a + (inNext7(b.proximoFecha)?1:0), 0);
      sTotal.textContent = money(total);
      sRegs.textContent = regs;
      sProx.textContent = prox7;

      if(!data.length){
        lista.innerHTML='<div class="item"><p>No hay registros para los filtros seleccionados.</p></div>';
        return;
      }

      for(const v of data){
        const div=document.createElement("div");
        div.className="item";

        // badge estado
        let badgeClass="", badgeText="";
        if((v.estado||"") === "pendiente"){ badgeClass="b-pend"; badgeText="PENDIENTE"; }
        else if((v.estado||"") === "adeuda"){ badgeClass="b-adeuda"; badgeText="ADEUDA"; }
        else if((v.estado||"") === "pagado"){ badgeClass="b-pagado"; badgeText="PAGADO"; }
        if(badgeText) div.innerHTML+=`<span class="badge ${badgeClass}">${badgeText}</span>`;

        // detalle
        const repTxt = Array.isArray(v.repuestos) ? v.repuestos.join(", ") : (v.repuestos||"-");

        div.innerHTML += `
          <p><b>Fecha:</b> ${v.fecha||"-"}  |  <b>Patente:</b> ${v.patente||"-"}</p>
          <p><b>Tipo:</b> ${v.tipo||"-"}  |  <b>Proveedor:</b> ${v.proveedor||"-"}  |  <b>KM:</b> ${v.km||0}</p>
          <p><b>Repuestos:</b> ${repTxt}</p>
          <p><b>MO:</b> ${money(v.manoDeObra)}  |  <b>Otros:</b> ${money(v.otros)}  |  <b>Total:</b> <b>${money(v.total)}</b></p>
          <p><b>Próx. fecha:</b> ${v.proximoFecha||"-"}</p>
          <p><i>${v.observaciones||""}</i></p>
        `;

        const acc=document.createElement("div");
        acc.className="acciones";
        acc.innerHTML=`
          <button class="btn btn-verde"  onclick="window._edit('${v.id}')">Editar</button>
          <button class="btn btn-outline" onclick="window._setEstado('${v.id}','pendiente')">Pendiente</button>
          <button class="btn btn-outline" onclick="window._setEstado('${v.id}','adeuda')">Adeuda</button>
          <button class="btn btn-outline" onclick="window._setEstado('${v.id}','pagado')">Pagado</button>
          <button class="btn btn-naranja" onclick="window._print('${v.id}')">Imprimir</button>
        `;
        div.appendChild(acc);
        lista.appendChild(div);
      }
    }

    [fDesde,fHasta,fPatente,fTipo,fEstado,fQ].forEach(el=> el.addEventListener('input', render));
    btnLimpiar.addEventListener('click', ()=>{
      fDesde.value=fHasta.value=fPatente.value=fTipo.value=fEstado.value=fQ.value="";
      render();
    });

    // --- Editar / Guardar
    const modal=$("modal"), formEdit=$("formEdit");
    const e_fecha=$("e_fecha"), e_prox=$("e_prox"), e_patente=$("e_patente"), e_tipo=$("e_tipo"), e_proveedor=$("e_proveedor"),
          e_km=$("e_km"), e_repuestos=$("e_repuestos"), e_mo=$("e_mo"), e_otros=$("e_otros"), e_total=$("e_total"),
          e_estado=$("e_estado"), e_obs=$("e_obs");
    const btnGuardar=$("btnGuardar"), btnCerrar=$("btnCerrar");
    btnCerrar.onclick=()=> modal.style.display="none";

    window._edit=(id)=>{
      const v = all.find(x=>x.id===id); if(!v) return;
      current = v;
      e_fecha.value = v.fecha || "";
      e_prox.value  = v.proximoFecha || "";
      e_patente.value = v.patente || "";
      e_tipo.value = v.tipo || "Otro";
      e_proveedor.value = v.proveedor || "";
      e_km.value = v.km || 0;
      e_repuestos.value = Array.isArray(v.repuestos)? v.repuestos.join("\n"): (v.repuestos||"");
      e_mo.value = Number(v.manoDeObra||0);
      e_otros.value = Number(v.otros||0);
      e_total.value = Number(v.total||0);
      e_estado.value = v.estado || "pendiente";
      e_obs.value = v.observaciones || "";
      modal.style.display="flex";
    };

    btnGuardar.onclick= async ()=>{
      if(!current) return;
      const data={
        fecha: e_fecha.value || "",
        proximoFecha: e_prox.value || "",
        patente: e_patente.value.trim(),
        tipo: e_tipo.value,
        proveedor: e_proveedor.value.trim(),
        km: Number(e_km.value||0),
        repuestos: e_repuestos.value ? e_repuestos.value.split(/\n+/).map(s=>s.trim()).filter(Boolean) : [],
        manoDeObra: Number(e_mo.value||0),
        otros: Number(e_otros.value||0),
        total: Number(e_total.value||0),
        estado: e_estado.value,
        pagado: e_estado.value==="pagado",
        observaciones: e_obs.value.trim()
      };
      try{
        await updateDoc(doc(db,"mantenimientos", current.id), data);
        modal.style.display="none";
      }catch(err){ alert("Error guardando: "+err.message); }
    };

    // --- Cambiar estado rápido
    window._setEstado = async (id, estado)=>{
      try{
        await updateDoc(doc(db,"mantenimientos", id), { estado, pagado: estado==="pagado" });
      }catch(err){ alert("Error cambiando estado: "+err.message); }
    };

    // --- Imprimir un mantenimiento
    window._print = (id)=>{
      const v = all.find(x=>x.id===id); if(!v) return;
      const repTxt = Array.isArray(v.repuestos) ? v.repuestos.join(", ") : (v.repuestos||"-");
      const html = `
        <html>
          <head>
            <meta charset="utf-8">
            <title>Impresión mantenimiento</title>
            <style>
              body{font-family:Arial, sans-serif; margin:24px}
              h2{text-align:center;text-transform:uppercase}
              .box{border:1px solid #000;padding:14px;border-radius:8px}
              .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
              .row p{margin:4px 0}
              .mt{margin-top:8px}
            </style>
          </head>
          <body>
            <h2>Mantenimiento</h2>
            <div class="box">
              <div class="row">
                <p><b>Fecha:</b> ${v.fecha||"-"}</p>
                <p><b>Próx.:</b> ${v.proximoFecha||"-"}</p>
                <p><b>Patente:</b> ${v.patente||"-"}</p>
                <p><b>Tipo:</b> ${v.tipo||"-"}</p>
                <p><b>Proveedor:</b> ${v.proveedor||"-"}</p>
                <p><b>KM:</b> ${v.km||0}</p>
              </div>
              <p class="mt"><b>Repuestos:</b> ${repTxt}</p>
              <p><b>MO:</b> ${v.manoDeObra||0}  |  <b>Otros:</b> ${v.otros||0}  |  <b>Total:</b> ${v.total||0}</p>
              <p><b>Estado:</b> ${v.estado||"-"}</p>
              <p><b>Obs:</b> ${v.observaciones||""}</p>
            </div>
            <script>window.print(); setTimeout(()=>window.close(), 300);<\/script>
          </body>
        </html>`;
      const w = window.open("", "_blank", "width=820,height=900");
      w.document.open(); w.document.write(html); w.document.close();
    };
  </script>
</body>
</html>
