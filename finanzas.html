<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Finanzas</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
  :root{
    --yellow:#FFD700; --black:#0d0d0d; --panel:#111; --white:#fff;
    --green:#2e7d32; --red:#d32f2f; --orange:#ffa000; --blue:#1976d2;
  }
  body{margin:0;background:var(--yellow);font-family:Arial,Helvetica,sans-serif;color:#fff}
  .wrap{max-width:1100px;margin:30px auto;background:#000;border-radius:12px;padding:22px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
  h1{margin:0 0 12px;text-align:center;text-transform:uppercase;text-decoration:underline}
  .tabs{display:flex;gap:8px;justify-content:center;margin-bottom:10px;flex-wrap:wrap}
  .tab{padding:10px 12px;border:1px solid #000;border-radius:8px;background:#111;cursor:pointer}
  .tab.active{background:#1a1a1a;box-shadow:0 0 0 2px #222 inset}
  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-start;margin-bottom:10px}
  .bar input,.bar select{padding:8px;border:1px solid #000;border-radius:6px;background:#fff;color:#000}
  .btn{padding:10px 12px;border:1px solid #000;border-radius:8px;font-weight:bold;text-transform:uppercase;cursor:pointer}
  .btn-verde{background:var(--green);color:#fff}
  .btn-naranja{background:var(--orange);color:#000}
  .btn-azul{background:var(--blue);color:#fff}
  /* 6 o más tarjetas: que se acomoden automáticamente */
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin:10px 0}
  .card{background:#0f0f0f;border:1px solid #222;border-radius:10px;padding:12px;text-align:center}
  .card small{opacity:.8}
  .card b{display:block;margin-top:6px;font-size:18px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .panel{background:#0f0f0f;border:1px solid #222;border-radius:12px;padding:12px}
  canvas{background:#0b0b0b;border-radius:10px;padding:8px}
  .tabla{width:100%;border-collapse:collapse;background:#111;border-radius:10px;overflow:hidden}
  .tabla th,.tabla td{padding:10px;border-bottom:1px solid #222;text-align:left}
  .tabla th{background:#0f0f0f}
  .monto{text-align:right}
  .right{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  .volver{margin-top:14px}
  .note{font-size:12px;opacity:.75}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
  .chip{background:#151515;border:1px solid #333;color:#fff;padding:6px 10px;border-radius:20px;cursor:pointer;font-size:12px}
  .chip.active{background:#1976d2;border-color:#1976d2}
  @media (max-width:1000px){.grid2{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Finanzas</h1>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" data-tab="resumen">Resumen</button>
    <button class="tab" data-tab="chofer">Por chofer</button>
    <button class="tab" data-tab="tabla">Tabla</button>
  </div>

  <!-- FILTROS -->
  <div class="bar">
    <input type="date" id="fDesde">
    <input type="date" id="fHasta">

    <select id="fChofer"><option value="">Todos los choferes</option></select>
    <select id="fPatente"><option value="">Todas las patentes</option></select>

    <select id="fEstadoMant">
      <option value="">Mantenimiento (todos)</option>
      <option value="pagado">Mantenimiento pagado</option>
      <option value="adeudado">Mantenimiento adeudado</option>
    </select>

    <input id="fQ" placeholder="Buscar (estación, proveedor, obs)">
    <button id="btnLimpiar" class="btn btn-naranja">Limpiar</button>

    <div class="right" style="margin-left:auto">
      <button id="btnCSV" class="btn btn-azul">Exportar CSV</button>
      <button id="btnPrintTabla" class="btn btn-verde">Imprimir tabla</button>
      <button id="btnPrintLiq" class="btn btn-verde">Imprimir liquidación</button>
    </div>
  </div>

  <!-- CARDS -->
  <div id="cards" class="cards panel">
    <div class="card"><small>Ingresos</small>        <b id="kIng">$ 0</b></div>
    <div class="card"><small>Combustible</small>     <b id="kComb">$ 0</b></div>
    <div class="card"><small>Mantenimiento</small>   <b id="kMant">$ 0</b></div>
    <div class="card"><small>Peajes</small>          <b id="kPeaje">$ 0</b></div>
    <div class="card"><small>Adelantos</small>       <b id="kAdel">$ 0</b></div>
    <div class="card"><small>Entradas</small>        <b id="kEntrada">$ 0</b></div>
    <div class="card"><small>Comisión chofer</small> <b id="kComis">$ 0</b></div>
  </div>
  <div class="cards">
    <div class="card" style="grid-column: span 3"><small>TOTAL GASTOS</small><b id="kGastos">$ 0</b></div>
    <div class="card" style="grid-column: span 3"><small>MARGEN (Ingresos – Gastos)</small><b id="kMargen">$ 0</b></div>
  </div>

  <!-- RESUMEN -->
  <section id="tab-resumen">
    <div id="chipsPat" class="chips"></div>

    <div class="grid2">
      <div class="panel">
        <h3 style="margin:6px 0 12px">Ingresos vs Egresos <span id="titPatente"></span></h3>
        <canvas id="chartPatentes" height="180"></canvas>
        <div class="note">Columna “Ingresos” vs “Egresos” del rango y camión seleccionado.</div>
      </div>
      <div class="panel">
        <h3 style="margin:6px 0 12px">Composición de egresos <span id="titPatente2"></span></h3>
        <canvas id="chartEgresos" height="180"></canvas>
        <div class="note">Combustible + Mantenimiento + Peajes + Adelantos + Entradas + Comisión.</div>
      </div>
    </div>
  </section>

  <!-- POR CHOFER -->
  <section id="tab-chofer" style="display:none">
    <div class="panel">
      <h3 style="margin:6px 0 12px">Liquidación por Chofer</h3>
      <div class="note" style="margin-bottom:8px">
        Comisión = Ingreso × %  ·  Liquidación = Comisión − Adelantos + Peajes + Entradas.
        (Click en el % para editarlo).
      </div>
      <table class="tabla">
        <thead>
          <tr>
            <th style="width:120px">Chofer</th>
            <th>Viajes</th>
            <th class="monto" style="width:140px">Ingreso</th>
            <th class="monto" style="width:100px">% Comis.</th>
            <th class="monto" style="width:140px">Comisión</th>
            <th class="monto" style="width:120px">Peajes</th>
            <th class="monto" style="width:120px">Entradas</th>
            <th class="monto" style="width:120px">Adelantos</th>
            <th class="monto" style="width:140px">Liquidación</th>
          </tr>
        </thead>
        <tbody id="tbodyChofer"></tbody>
      </table>
    </div>

    <div class="panel" style="margin-top:12px">
      <h3 style="margin:6px 0 12px">Liquidación por Chofer y Patente</h3>
      <table class="tabla">
        <thead>
          <tr>
            <th style="width:120px">Chofer</th>
            <th style="width:120px">Patente</th>
            <th>Viajes</th>
            <th class="monto" style="width:140px">Ingreso</th>
            <th class="monto" style="width:100px">% Comis.</th>
            <th class="monto" style="width:140px">Comisión</th>
            <th class="monto" style="width:120px">Peajes</th>
            <th class="monto" style="width:120px">Entradas</th>
            <th class="monto" style="width:120px">Adelantos</th>
            <th class="monto" style="width:140px">Liquidación</th>
          </tr>
        </thead>
        <tbody id="tbodyChoferPat"></tbody>
      </table>
    </div>
  </section>

  <!-- TABLA -->
  <section id="tab-tabla" style="display:none">
    <div class="panel">
      <h3 style="margin:6px 0 12px">Movimientos (Ingresos + Egresos)</h3>
      <table class="tabla" id="tabla">
        <thead>
          <tr>
            <th style="width:120px">Fecha</th>
            <th style="width:140px">Tipo</th>
            <th>Detalle</th>
            <th style="width:140px">Chofer</th>
            <th style="width:120px">Patente</th>
            <th class="monto" style="width:140px">Importe</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <button class="btn btn-naranja volver" onclick="location.href='admin.html'">Volver</button>
</div>

<script type="module">
/* ==================== CONFIG ==================== */
const DEFAULT_COMMISSION = 0.18; // tu valor actual por defecto

/* ==================== Firebase ==================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
  authDomain: "transporte-mario-guizzo.firebaseapp.com",
  projectId: "transporte-mario-guizzo",
  storageBucket: "transporte-mario-guizzo.appspot.com",
  messagingSenderId: "465536166890",
  appId: "1:465536166890:web:f658690629b09eca8fa093"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ==================== Estado ==================== */
let viajes = [], combustible = [], mant = [], usuarios = [];
let movs = [];
let patSet = new Set(), choSet = new Set();
let activeTab = 'resumen';
let selectedPatChip = ''; // '' = Total

/* ==================== Refs UI ==================== */
const fDesde   = document.getElementById('fDesde');
const fHasta   = document.getElementById('fHasta');
const fChofer  = document.getElementById('fChofer');
const fPatente = document.getElementById('fPatente');
const fEstadoMant = document.getElementById('fEstadoMant');
const fQ       = document.getElementById('fQ');

const kIng = document.getElementById('kIng');
const kComb = document.getElementById('kComb');
const kMant = document.getElementById('kMant');
const kPeaje = document.getElementById('kPeaje');
const kAdel = document.getElementById('kAdel');
const kEntrada = document.getElementById('kEntrada');
const kComis = document.getElementById('kComis');
const kGastos = document.getElementById('kGastos');
const kMargen = document.getElementById('kMargen');

const tbody = document.getElementById('tbody');
const tbodyChofer = document.getElementById('tbodyChofer');
const tbodyChoferPat = document.getElementById('tbodyChoferPat');
const chipsPat = document.getElementById('chipsPat');
const titPat1 = document.getElementById('titPatente');
const titPat2 = document.getElementById('titPatente2');

const fmtCur = (n)=> '$ ' + (Number(toNum(n)||0)).toLocaleString('es-AR',{maximumFractionDigits:0});
const fmt    = (n)=> (Number(toNum(n)||0)).toLocaleString('es-AR',{maximumFractionDigits:0});

/* ===== Debug visible ===== */
let dbg = document.getElementById('dbg');
if (!dbg){
  dbg = document.createElement('div');
  dbg.id = 'dbg';
  dbg.className = 'note';
  dbg.style.margin = '6px 0 10px';
  document.querySelector('.wrap').insertBefore(dbg, document.querySelector('.tabs'));
}
const showDbg = (extra='')=>{
  dbg.textContent = `docs → viajes:${viajes.length} · combustible:${combustible.length} · mant:${mant.length} · choferes:${usuarios.length} ${extra?'· '+extra:''}`;
};

/* ==================== Normalizadores ==================== */
// 1) Números robustos: "1.450,50" → 1450.5  |  "282.750" → 282750
function toNum(v){
  if (typeof v === 'number') return v;
  if (typeof v === 'string'){
    const s = v.replace(/\s/g,'').replace(/\./g,'').replace(/,/g,'.');
    const n = Number(s);
    return isNaN(n) ? 0 : n;
  }
  const n = Number(v);
  return isNaN(n) ? 0 : n;
}
// Fecha → 'YYYY-MM-DD'
function fechaStr(x){
  if (!x) return '';
  if (typeof x === 'string') return x.slice(0,10);
  if (x instanceof Date) return x.toISOString().slice(0,10);
  if (typeof x === 'object'){
    if (typeof x.toDate === 'function') return x.toDate().toISOString().slice(0,10);
    if (typeof x.seconds === 'number') return new Date(x.seconds*1000).toISOString().slice(0,10);
  }
  return String(x).slice(0,10);
}
const fechaViaje = (v) => fechaStr(v.fecha || v.fechaViaje || v.fechaSalida || v.fechaCarga || v.createdAt || null);

// Combustible
const combPatente  = (c) => (c.patenteCamion || c.patente || '').trim().toUpperCase();
const combEstacion = (c) => c.estacionServicio || c.estacion || '';
const combMetodo   = (c) => c.metodoPago || c.metodo || '';
const combTipo     = (c) => c.tipoCombustible || c.tipo || '';
const combFecha    = (c) => fechaStr(c.fecha || c.fechaCarga || c.fechaCompra || null);
const combTotal    = (c) => {
  const L = toNum(c.litros);
  const P = toNum(c.precioPorLitro);
  const T = c.totalPagado!=null && c.totalPagado!=='' ? toNum(c.totalPagado) : 0;
  if (L>0 && P>0) return L*P;
  if (T>0) return T;
  return 0;
};

// Ingreso de viaje (siempre por kg descargados × tarifa por tonelada si está)
function ingresoViaje(v){
  const kg = toNum(v.kgDescargados || v.kg || v.kgLlevados || v.peso || 0);
  const tarifaTon = toNum(v.tarifaPorTon || v.tarifaTn || v.tarifa || 0);
  if (tarifaTon>0 && kg>0) return (kg/1000)*tarifaTon; // kg → toneladas
  // fallback a campos anteriores (si existieran)
  const cand = [v.importeCobrado, v.totalCobrado, v.importe, v.ingreso, v.total];
  for (const val of cand){
    const n = toNum(val);
    if (n>0) return n;
  }
  return 0;
}

/* Validar patente real (ABC123 o AB123CD) */
function isValidPat(p){
  return /^(?:[A-Z]{3}\s?\d{3}|[A-Z]{2}\d{3}[A-Z]{2})$/i.test((p||'').trim());
}

/* ==================== Lectura de colecciones ==================== */
const onErr = (col) => (err)=>{ console.error(col, err); showDbg(`ERROR ${col}: ${err.code||''}`); };

onSnapshot(collection(db,'usuarios'), qs=>{
  usuarios = qs.docs.map(d => ({id:d.id, ...d.data()}))
    .filter(u => (u.rol||'').toLowerCase()==='chofer');
  choSet.clear();
  usuarios.forEach(u => choSet.add( (u.nombre||u.displayName||u.email||'').trim() ));
  poblarChoferes(); showDbg(); render();
}, onErr('usuarios'));

onSnapshot(collection(db,'viajes'), qs=>{
  viajes = qs.docs.map(d => ({id:d.id, ...d.data()}));
  viajes.forEach(v=>{
    const p = (v.patente||'').trim().toUpperCase();
    if (p) patSet.add(p);
    if (v.chofer)  choSet.add((v.chofer||'').trim());
  });
  poblarPatentes(); poblarChoferes(); showDbg(); render();
}, onErr('viajes'));

onSnapshot(collection(db,'cargas-combustible'), qs=>{
  combustible = qs.docs.map(d => ({id:d.id, ...d.data()}));
  combustible.forEach(c=> { const p = combPatente(c); if (p) patSet.add(p); });
  poblarPatentes(); showDbg(); render();
}, onErr('cargas-combustible'));

onSnapshot(collection(db,'mantenimientos'), qs=>{
  mant = qs.docs.map(d => ({id:d.id, ...d.data()}));
  mant.forEach(m=> { if (m.patente) patSet.add((m.patente||'').trim().toUpperCase()); });
  poblarPatentes(); showDbg(); render();
}, onErr('mantenimientos'));

/* ==================== Helpers UI ==================== */
function poblarPatentes(){
  const prev = fPatente.value.toUpperCase();
  const arr = Array.from(patSet).filter(Boolean).filter(isValidPat).sort();
  fPatente.innerHTML = '<option value="">Todas las patentes</option>' + arr.map(p=>`<option>${p}</option>`).join('');
  if (arr.includes(prev)) fPatente.value = prev;
  buildChips(arr);
}
function poblarChoferes(){
  const prev = fChofer.value;
  const arr = Array.from(choSet).filter(Boolean).sort();
  fChofer.innerHTML = '<option value="">Todos los choferes</option>' + arr.map(c=>`<option>${c}</option>`).join('');
  if (arr.includes(prev)) fChofer.value = prev;
}
function buildChips(arr){
  const pats = arr.slice(0,20);
  let html = `<button class="chip ${selectedPatChip===''?'active':''}" data-pt="">Total</button>`;
  html += pats.map(p => `<button class="chip ${selectedPatChip===p?'active':''}" data-pt="${p}">${p}</button>`).join('');
  chipsPat.innerHTML = html;
  chipsPat.querySelectorAll('.chip').forEach(b=>{
    b.onclick = ()=>{
      selectedPatChip = b.dataset.pt || '';
      chipsPat.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      renderCharts(movs);
    };
  });
}
function inRangeFechaStr(fstr, d, h){
  if (!d && !h) return true;
  if (!fstr) return false;
  if (d && fstr < d) return false;
  if (h && fstr > h) return false;
  return true;
}
function pasaTexto(q, ...campos){
  q = (q||'').trim().toLowerCase();
  if (!q) return true;
  return campos.some(c => ((c||'')+'').toLowerCase().includes(q));
}
function getPctChofer(nombre, patente){
  const n = (nombre||'').trim();
  const p = (patente||'').trim().toUpperCase();
  const u = usuarios.find(u => (u.nombre||u.displayName||'').trim() === n)
       || usuarios.find(u => Array.isArray(u.patentes) && u.patentes.map(x=>String(x).toUpperCase()).includes(p));
  if (u && Number(u.porcentaje)>=0) return Number(u.porcentaje)/100;
  return DEFAULT_COMMISSION;
}

/* ==================== Render principal ==================== */
function render(){
  const d = fDesde.value||'', h = fHasta.value||'';
  const ch = fChofer.value||'', pt = (fPatente.value||'').toUpperCase();
  const est = fEstadoMant.value||'', q = fQ.value||'';

  movs = [];

  // VIAJES
  const viajesFiltrados = viajes.filter(v=>{
    const f = fechaViaje(v);
    if (!inRangeFechaStr(f, d, h)) return false;
    if (ch && (v.chofer||'') !== ch) return false;
    if (pt && (String(v.patente||'').toUpperCase()) !== pt) return false;
    if (!pasaTexto(q, v.origen, v.destino, v.cuitOrigen, v.observaciones, v.chofer, v.patente)) return false;
    return true;
  });

  for (const v of viajesFiltrados){
    const ingreso = toNum(ingresoViaje(v));
    const f = fechaViaje(v);
    if (ingreso>0){
      movs.push({fecha:f, tipo:'Ingreso', detalle:`${v.origen||''} → ${v.destino||''}`, chofer:v.chofer||'', patente:String(v.patente||'').toUpperCase(), importe:ingreso});
      // Comisión chofer (gasto)
      const pct = getPctChofer(v.chofer, v.patente);
      const com = ingreso * pct;
      if (com>0){
        movs.push({fecha:f, tipo:'Comision', detalle:`Comisión chofer ${v.chofer||''}`, chofer:v.chofer||'', patente:String(v.patente||'').toUpperCase(), importe:com});
      }
    }
    if (v.peajeAplica && toNum(v.peajeMonto)>0){
      movs.push({fecha:f, tipo:'Peaje', detalle:'Peaje', chofer:v.chofer||'', patente:String(v.patente||'').toUpperCase(), importe:toNum(v.peajeMonto)});
    }
    if (v.entradaAplica && toNum(v.entradaMonto)>0){
      movs.push({fecha:f, tipo:'Entrada', detalle:'Entrada', chofer:v.chofer||'', patente:String(v.patente||'').toUpperCase(), importe:toNum(v.entradaMonto)});
    }
    if (v.adelantoAplica && toNum(v.adelantoMonto)>0){
      movs.push({fecha:f, tipo:'Adelanto', detalle:'Adelanto chofer', chofer:v.chofer||'', patente:String(v.patente||'').toUpperCase(), importe:toNum(v.adelantoMonto)});
    }
  }

  // COMBUSTIBLE
  combustible.filter(c=>{
    const f = combFecha(c);
    if (!inRangeFechaStr(f, d, h)) return false;
    if (pt && (combPatente(c) !== pt)) return false;
    if (ch && (c.chofer||'') !== ch) return false;
    if (!pasaTexto(q, combEstacion(c), combTipo(c), combMetodo(c), combPatente(c))) return false;
    return true;
  }).forEach(c=>{
    const tot = toNum(combTotal(c));
    if (tot>0) movs.push({
      fecha: combFecha(c),
      tipo: 'Combustible',
      detalle: `${combEstacion(c) || '-'} — ${combTipo(c) || ''}`,
      chofer: c.chofer || '',
      patente: combPatente(c),
      importe: tot
    });
  });

  // MANTENIMIENTO
  mant.filter(m=>{
    const f = fechaStr(m.fecha);
    if (!inRangeFechaStr(f, d, h)) return false;
    if (pt && (String(m.patente||'').toUpperCase()) !== pt) return false;
    if (est==='pagado'   && !(m.pagado===true || m.pagado==='si')) return false;
    if (est==='adeudado' &&  (m.pagado===true || m.pagado==='si')) return false;
    if (!pasaTexto(q, m.proveedor, m.tipo, m.observaciones, m.patente)) return false;
    return true;
  }).forEach(m=>{
    const tot = toNum(m.total||0);
    if (tot>0) movs.push({
      fecha: fechaStr(m.fecha),
      tipo:'Mantenimiento',
      detalle:`${m.tipo||''} — ${m.proveedor||''}`,
      chofer:'',
      patente:String(m.patente||'').toUpperCase(),
      importe:tot
    });
  });

  movs.sort((a,b)=> b.fecha.localeCompare(a.fecha));

  const sum = (tipo) => movs.filter(x=>x.tipo===tipo).reduce((a,b)=>a+toNum(b.importe||0),0);
  const ingresos   = sum('Ingreso');
  const combTotal$ = sum('Combustible');
  const mantTotal  = sum('Mantenimiento');
  const peajeTotal = sum('Peaje');
  const adelTotal  = sum('Adelanto');
  const entTotal   = sum('Entrada');
  const comisTotal = sum('Comision');

  const gastos     = combTotal$ + mantTotal + peajeTotal + adelTotal + entTotal + comisTotal;
  const margen     = ingresos - gastos;

  kIng.textContent     = fmtCur(ingresos);
  kComb.textContent    = fmtCur(combTotal$);
  kMant.textContent    = fmtCur(mantTotal);
  kPeaje.textContent   = fmtCur(peajeTotal);
  kAdel.textContent    = fmtCur(adelTotal);
  kEntrada.textContent = fmtCur(entTotal);
  kComis.textContent   = fmtCur(comisTotal);
  kGastos.textContent  = fmtCur(gastos);
  kMargen.textContent  = fmtCur(margen);

  // Tabla
  tbody.innerHTML = movs.length ? movs.map(m=>`
    <tr>
      <td>${m.fecha}</td>
      <td>${m.tipo}</td>
      <td>${m.detalle||''}</td>
      <td>${m.chofer||''}</td>
      <td>${m.patente||''}</td>
      <td class="monto">${fmtCur(m.importe||0)}</td>
    </tr>`).join('') : `<tr><td colspan="6" style="padding:18px;opacity:.85">Sin movimientos.</td></tr>`;

  renderChofer(viajesFiltrados);
  renderCharts(movs);
  showDbg();
}

/* ---- Liquidación por chofer (con edición de %) ---- */
function renderChofer(viajesFiltrados){
  const map = new Map();
  for (const v of viajesFiltrados){
    const key = v.chofer||'(Sin chofer)';
    if (!map.has(key)) map.set(key, {viajes:0, ingreso:0, peaje:0, entrada:0, adelanto:0, pct:getPctChofer(v.chofer, v.patente)});
    const o = map.get(key);
    o.viajes++;
    o.ingreso += toNum(ingresoViaje(v));
    if (v.peajeAplica)   o.peaje   += toNum(v.peajeMonto||0);
    if (v.entradaAplica) o.entrada += toNum(v.entradaMonto||0);
    if (v.adelantoAplica)o.adelanto+= toNum(v.adelantoMonto||0);
  }
  const rows = [...map.entries()].map(([cho, o])=>{
    const comision = o.ingreso * (o.pct ?? DEFAULT_COMMISSION);
    const liq = comision - o.adelanto + o.peaje + o.entrada;
    const uid = (usuarios.find(u => (u.nombre||u.displayName||'').trim()===cho) || {}).id || '';
    return {uid, chofer:cho, viajes:o.viajes, ingreso:o.ingreso, pct:o.pct, comision, peaje:o.peaje, entrada:o.entrada, adelanto:o.adelanto, liquidacion:liq};
  }).sort((a,b)=> a.chofer.localeCompare(b.chofer));

  const fmtPct = (p)=> `${Math.round(((p ?? DEFAULT_COMMISSION) * 100))}%`;

  tbodyChofer.innerHTML = rows.length ? rows.map(r=>`
    <tr>
      <td>${r.chofer}</td>
      <td>${r.viajes}</td>
      <td class="monto">${fmtCur(r.ingreso)}</td>
      <td class="monto pct-cell" data-uid="${r.uid}" data-chofer="${r.chofer}"><u>${fmtPct(r.pct)}</u></td>
      <td class="monto">${fmtCur(r.comision)}</td>
      <td class="monto">${fmtCur(r.peaje)}</td>
      <td class="monto">${fmtCur(r.entrada)}</td>
      <td class="monto">${fmtCur(r.adelanto)}</td>
      <td class="monto"><b>${fmtCur(r.liquidacion)}</b></td>
    </tr>`).join('') : `<tr><td colspan="9" style="padding:14px;opacity:.85">Sin viajes en el rango.</td></tr>`;

  // por Chofer y Patente
  const map2 = new Map();
  for (const v of viajesFiltrados){
    const key = (v.chofer||'(Sin chofer)') + '||' + (String(v.patente||'(sin patente)').toUpperCase());
    if (!map2.has(key)) map2.set(key, {chofer:v.chofer||'(Sin chofer)', patente:String(v.patente||'(sin patente)').toUpperCase(), viajes:0, ingreso:0, peaje:0, entrada:0, adelanto:0, pct:getPctChofer(v.chofer, v.patente)});
    const o = map2.get(key);
    o.viajes++;
    o.ingreso += toNum(ingresoViaje(v));
    if (v.peajeAplica)   o.peaje   += toNum(v.peajeMonto||0);
    if (v.entradaAplica) o.entrada += toNum(v.entradaMonto||0);
    if (v.adelantoAplica)o.adelanto+= toNum(v.adelantoMonto||0);
  }
  const rows2 = [...map2.values()].map(o=>{
    const comision = o.ingreso * (o.pct ?? DEFAULT_COMMISSION);
    const liq = comision - o.adelanto + o.peaje + o.entrada;
    return {...o, comision, liquidacion:liq};
  }).sort((a,b)=> a.chofer.localeCompare(b.chofer) || a.patente.localeCompare(b.patente));

  tbodyChoferPat.innerHTML = rows2.length ? rows2.map(r=>`
    <tr>
      <td>${r.chofer}</td>
      <td>${r.patente}</td>
      <td>${r.viajes}</td>
      <td class="monto">${fmtCur(r.ingreso)}</td>
      <td class="monto">${Math.round(((r.pct ?? DEFAULT_COMMISSION) * 100))}%</td>
      <td class="monto">${fmtCur(r.comision)}</td>
      <td class="monto">${fmtCur(r.peaje)}</td>
      <td class="monto">${fmtCur(r.entrada)}</td>
      <td class="monto">${fmtCur(r.adelanto)}</td>
      <td class="monto"><b>${fmtCur(r.liquidacion)}</b></td>
    </tr>`).join('') : `<tr><td colspan="10" style="padding:14px;opacity:.85">Sin viajes en el rango.</td></tr>`;

  // click-to-edit del porcentaje
  tbodyChofer.onclick = async (e)=>{
    const td = e.target.closest('.pct-cell');
    if (!td) return;
    const uid = td.dataset.uid;
    const cho = td.dataset.chofer;
    if (!uid){ alert('No encuentro el usuario para ' + cho); return; }
    const val = prompt(`Nuevo % de comisión para "${cho}" (0–100):`);
    if (val===null) return;
    const p = Number(val);
    if (isNaN(p) || p<0 || p>100){ alert('Valor inválido'); return; }
    try{
      await updateDoc(doc(db,'usuarios', uid), { porcentaje: p });
      alert('Porcentaje actualizado');
    }catch(err){
      alert('Error al actualizar: ' + err.message);
    }
  };

  window.__rowsChofer = rows;
  window.__rowsChoferPat = rows2;
}

/* ---- Charts ---- */
function renderCharts(movsAll){
  if (!window.Chart){ return; }
  const mm = selectedPatChip ? movsAll.filter(m=>m.patente===selectedPatChip) : movsAll;
  titPat1.textContent = selectedPatChip ? `— ${selectedPatChip}` : '— Total';
  titPat2.textContent = selectedPatChip ? `— ${selectedPatChip}` : '— Total';

  const pats = [...new Set(mm.map(m=>m.patente).filter(Boolean))].sort();
  const ing = pats.map(p=> mm.filter(m=>m.patente===p && m.tipo==='Ingreso').reduce((a,b)=>a+toNum(b.importe||0),0));
  const egr = pats.map(p=> mm.filter(m=>m.patente===p && m.tipo!=='Ingreso').reduce((a,b)=>a+toNum(b.importe||0),0));
  const labels = pats.length ? pats : [ selectedPatChip || 'Total' ];
  const ingV   = pats.length ? ing : [ mm.filter(m=>m.tipo==='Ingreso').reduce((a,b)=>a+toNum(b.importe||0),0) ];
  const egrV   = pats.length ? egr : [ mm.filter(m=>m.tipo!=='Ingreso').reduce((a,b)=>a+toNum(b.importe||0),0) ];

  const ctx1 = document.getElementById('chartPatentes').getContext('2d');
  window.chrtPat && window.chrtPat.destroy();
  window.chrtPat = new window.Chart(ctx1,{
    type:'bar',
    data:{labels, datasets:[
      {label:'Ingresos', data:ingV, backgroundColor:'#4FC3F7', borderColor:'#4FC3F7', borderWidth:1},
      {label:'Egresos',  data:egrV, backgroundColor:'#EF5350', borderColor:'#EF5350', borderWidth:1}
    ]},
    options:{
      responsive:true,
      plugins:{ legend:{position:'bottom', labels:{color:'#fff'}}, tooltip:{bodyColor:'#111', titleColor:'#111'} },
      scales:{ x:{ticks:{color:'#eee'}, grid:{color:'#333'}}, y:{ticks:{color:'#eee'}, grid:{color:'#333'}} }
    }
  });

  const comp = ['Combustible','Mantenimiento','Peaje','Adelanto','Entrada','Comision'];
  const vals = comp.map(t=> mm.filter(m=>m.tipo===t).reduce((a,b)=>a+toNum(b.importe||0),0));
  const ctx2 = document.getElementById('chartEgresos').getContext('2d');
  window.chrtEgr && window.chrtEgr.destroy();
  window.chrtEgr = new window.Chart(ctx2,{
    type:'doughnut',
    data:{ labels:comp, datasets:[{ data:vals,
      backgroundColor:['#42A5F5','#EC407A','#FFB300','#66BB6A','#AB47BC','#8D6E63'],
      borderColor:['#42A5F5','#EC407A','#FFB300','#66BB6A','#AB47BC','#8D6E63'], borderWidth:1 }] },
    options:{ responsive:true, cutout:'55%', plugins:{ legend:{position:'bottom', labels:{color:'#fff'}} } }
  });
}

/* ==================== Eventos ==================== */
[fDesde,fHasta,fChofer,fPatente,fEstadoMant,fQ].forEach(el => el.addEventListener('input', render));
document.getElementById('btnLimpiar').addEventListener('click', ()=>{
  fDesde.value=''; fHasta.value=''; fChofer.value=''; fPatente.value=''; fEstadoMant.value=''; fQ.value='';
  render();
});

/* Tabs */
const tabs = document.querySelectorAll('.tab');
tabs.forEach(b=>{
  b.onclick = ()=>{
    tabs.forEach(x=>x.classList.remove('active')); b.classList.add('active');
    document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.style.display='none');
    document.getElementById('tab-'+b.dataset.tab).style.display='block';
    activeTab = b.dataset.tab;
  };
});

/* CSV */
document.getElementById('btnCSV').addEventListener('click', ()=>{
  if (!movs.length){ alert('No hay datos.'); return; }
  const head = ['Fecha','Tipo','Detalle','Chofer','Patente','Importe'];
  const rows = movs.map(m => [ m.fecha, m.tipo, (m.detalle||'').replace(/[\r\n]+/g,' '), m.chofer||'', m.patente||'', String(Math.round(toNum(m.importe||0))).replace('.',',') ]);
  const csv = [head, ...rows].map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(';')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'finanzas.csv'; a.click();
  URL.revokeObjectURL(url);
});

/* Print tabla */
document.getElementById('btnPrintTabla').addEventListener('click', ()=>{
  if (activeTab !== 'tabla'){ document.querySelector('.tab[data-tab="tabla"]').click(); return; }
  const rows = movs.map(m => `
    <tr><td>${m.fecha}</td><td>${m.tipo}</td><td>${m.detalle||''}</td><td>${m.chofer||''}</td><td>${m.patente||''}</td><td class="r">${fmtCur(m.importe||0)}</td></tr>
  `).join('');
  const html = `
<!DOCTYPE html><html><head><meta charset="utf-8"><title>Movimientos</title>
<style>body{font-family:Arial;margin:28px;color:#111}table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}th{background:#f5f5f5}.r{text-align:right}</style></head>
<body onload="window.print()"><h2>Movimientos</h2>
<table><thead><tr><th>Fecha</th><th>Tipo</th><th>Detalle</th><th>Chofer</th><th>Patente</th><th class="r">Importe</th></tr></thead><tbody>${rows||'<tr><td colspan="6">Sin datos</td></tr>'}</tbody></table></body></html>`;
  const w = window.open('', '_blank', 'width=900,height=1000'); w.document.write(html); w.document.close(); w.focus();
});

/* Print liquidación */
document.getElementById('btnPrintLiq').addEventListener('click', ()=>{
  if (activeTab !== 'chofer'){ document.querySelector('.tab[data-tab="chofer"]').click(); return; }
  const rows  = (window.__rowsChofer||[]);
  const rows2 = (window.__rowsChoferPat||[]);
  const fmtPct = (p)=> `${Math.round((p ?? DEFAULT_COMMISSION)*100)}%`;
  const tr1 = rows.map(r=>`
    <tr><td>${r.chofer}</td><td class="r">${r.viajes}</td><td class="r">${fmtCur(r.ingreso)}</td><td class="r">${fmtPct(r.pct)}</td><td class="r">${fmtCur(r.comision)}</td><td class="r">${fmtCur(r.peaje)}</td><td class="r">${fmtCur(r.entrada)}</td><td class="r">${fmtCur(r.adelanto)}</td><td class="r"><b>${fmtCur(r.liquidacion)}</b></td></tr>`).join('');
  const tr2 = rows2.map(r=>`
    <tr><td>${r.chofer}</td><td>${r.patente}</td><td class="r">${r.viajes}</td><td class="r">${fmtCur(r.ingreso)}</td><td class="r">${fmtPct(r.pct)}</td><td class="r">${fmtCur(r.comision)}</td><td class="r">${fmtCur(r.peaje)}</td><td class="r">${fmtCur(r.entrada)}</td><td class="r">${fmtCur(r.adelanto)}</td><td class="r"><b>${fmtCur(r.liquidacion)}</b></td></tr>`).join('');
  const html = `
<!DOCTYPE html><html><head><meta charset="utf-8"><title>Liquidaciones</title>
<style>body{font-family:Arial;margin:28px;color:#111}h3{margin:20px 0 8px}table{width:100%;border-collapse:collapse;margin-top:4px}th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}th{background:#f5f5f5}.r{text-align:right}.note{font-size:12px;color:#555;margin-bottom:10px}</style></head>
<body onload="window.print()">
  <h2>Liquidaciones</h2>
  <div class="note">Rango: ${fDesde.value||'—'} a ${fHasta.value||'—'} · Chofer: ${fChofer.value||'Todos'} · Patente: ${fPatente.value||'Todas'}</div>
  <h3>Por Chofer</h3><table><thead><tr><th>Chofer</th><th class="r">Viajes</th><th class="r">Ingreso</th><th class="r">% Comis.</th><th class="r">Comisión</th><th class="r">Peajes</th><th class="r">Entradas</th><th class="r">Adelantos</th><th class="r">Liquidación</th></tr></thead><tbody>${tr1 || '<tr><td colspan="9">Sin datos</td></tr>'}</tbody></table>
  <h3>Por Chofer y Patente</h3><table><thead><tr><th>Chofer</th><th>Patente</th><th class="r">Viajes</th><th class="r">Ingreso</th><th class="r">% Comis.</th><th class="r">Comisión</th><th class="r">Peajes</th><th class="r">Entradas</th><th class="r">Adelantos</th><th class="r">Liquidación</th></tr></thead><tbody>${tr2 || '<tr><td colspan="10">Sin datos</td></tr>'}</tbody></table>
</body></html>`;
  const w = window.open('', '_blank', 'width=900,height=1000'); w.document.write(html); w.document.close(); w.focus();
});
</script>

</body>
</html>
