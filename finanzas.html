<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FINANZAS</title>
<style>
  :root{
    --amarillo:#FFD700; --negro:#0d0d0d; --panel:#111; --blanco:#fff;
    --verde:#2e7d32; --rojo:#d32f2f; --naranja:#ffa000; --azul:#1976d2;
  }
  body{margin:0;background:var(--amarillo);font-family:Arial,Helvetica,sans-serif;color:#fff}
  .wrap{max-width:980px;margin:36px auto;background:#000;border-radius:12px;padding:22px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
  h1{margin:0 0 16px;text-align:center;text-transform:uppercase;text-decoration:underline}
  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .bar input,.bar select{padding:8px;border:1px solid #000;border-radius:6px;background:#fff;color:#000}
  .btn{padding:10px 12px;border:1px solid #000;border-radius:8px;font-weight:bold;text-transform:uppercase;cursor:pointer}
  .btn-verde{background:var(--verde);color:#fff}
  .btn-naranja{background:var(--naranja);color:#000}
  .btn-azul{background:var(--azul);color:#fff}
  .cards{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin:14px 0}
  .card{background:#0f0f0f;border:1px solid #222;border-radius:10px;padding:12px;text-align:center}
  .card small{opacity:.8}
  .card b{display:block;margin-top:6px;font-size:18px}
  .tabla{width:100%;border-collapse:collapse;background:#111;border-radius:10px;overflow:hidden}
  .tabla th,.tabla td{padding:10px;border-bottom:1px solid #222;text-align:left}
  .tabla th{background:#0f0f0f}
  .monto{text-align:right}
  .foot{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .volver{margin-top:14px}
  @media (max-width:900px){
    .cards{grid-template-columns:1fr 1fr 1fr}
  }
  @media (max-width:580px){
    .cards{grid-template-columns:1fr 1fr}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Finanzas</h1>

  <!-- FILTROS -->
  <div class="bar">
    <input type="date" id="fDesde">
    <input type="date" id="fHasta">

    <select id="fPatente">
      <option value="">Todas las patentes</option>
    </select>

    <select id="fEstadoMant">
      <option value="">Mantenimiento (todos)</option>
      <option value="pagado">Mantenimiento pagado</option>
      <option value="adeudado">Mantenimiento adeudado</option>
    </select>

    <input id="fQ" placeholder="Buscar (estación, proveedor, notas)">
    <button id="btnLimpiar" class="btn btn-naranja">Limpiar</button>
    <button id="btnCSV" class="btn btn-azul">Exportar CSV</button>
    <button id="btnPrint" class="btn btn-verde">Imprimir</button>
  </div>

  <!-- CARDS -->
  <div class="cards">
    <div class="card"><small>Combustible</small><b id="kComb">$ 0</b></div>
    <div class="card"><small>Mantenimiento</small><b id="kMant">$ 0</b></div>
    <div class="card"><small>Peajes</small><b id="kPeaje">$ 0</b></div>
    <div class="card"><small>Adelantos</small><b id="kAdel">$ 0</b></div>
    <div class="card"><small>Entradas</small><b id="kEntrada">$ 0</b></div>
    <div class="card"><small>TOTAL GASTOS</small><b id="kTotal">$ 0</b></div>
  </div>

  <!-- LISTA MOVIMIENTOS -->
  <table class="tabla" id="tabla">
    <thead>
      <tr>
        <th style="width:120px">Fecha</th>
        <th style="width:140px">Tipo</th>
        <th>Detalle</th>
        <th style="width:120px">Patente</th>
        <th class="monto" style="width:140px">Importe</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <button class="btn btn-naranja volver" onclick="location.href='admin.html'">Volver</button>
</div>

<script type="module">
/* ---------------------- Firebase ---------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
  authDomain: "transporte-mario-guizzo.firebaseapp.com",
  projectId: "transporte-mario-guizzo",
  storageBucket: "transporte-mario-guizzo.appspot.com",
  messagingSenderId: "465536166890",
  appId: "1:465536166890:web:f658690629b09eca8fa093"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ---------------------- Estado ---------------------- */
let viajes = [];           // peajes / adelantos / entradas
let combustible = [];      // total combustible
let mant = [];             // total mantenimiento
let movs = [];             // movimientos combinados (para tabla/CSV)
let patentesSet = new Set();

/* ---------------------- UI ---------------------- */
const fDesde = document.getElementById('fDesde');
const fHasta = document.getElementById('fHasta');
const fPatente = document.getElementById('fPatente');
const fEstadoMant = document.getElementById('fEstadoMant');
const fQ = document.getElementById('fQ');

const tbody = document.getElementById('tbody');
const kComb = document.getElementById('kComb');
const kMant = document.getElementById('kMant');
const kPeaje = document.getElementById('kPeaje');
const kAdel  = document.getElementById('kAdel');
const kEntrada = document.getElementById('kEntrada');
const kTotal = document.getElementById('kTotal');

const fmt = n => new Intl.NumberFormat('es-AR', {style:'currency', currency:'ARS', maximumFractionDigits:0}).format(Number(n||0));

/* ---------------------- Subscripciones ---------------------- */
onSnapshot(collection(db,'viajes'), qs=>{
  viajes = qs.docs.map(d => ({id:d.id, ...d.data()}));
  viajes.forEach(v => { if (v.patente) patentesSet.add(v.patente.trim()); });
  poblarPatentes(); render();
});
onSnapshot(collection(db,'cargas-combustible'), qs=>{
  combustible = qs.docs.map(d => ({id:d.id, ...d.data()}));
  combustible.forEach(c => { if (c.patente) patentesSet.add((c.patente||'').trim()); });
  poblarPatentes(); render();
});
onSnapshot(collection(db,'mantenimientos'), qs=>{
  mant = qs.docs.map(d => ({id:d.id, ...d.data()}));
  mant.forEach(m => { if (m.patente) patentesSet.add((m.patente||'').trim()); });
  poblarPatentes(); render();
});

/* ---------------------- Helpers ---------------------- */
function poblarPatentes(){
  const selPrev = fPatente.value;
  const arr = Array.from(patentesSet).filter(Boolean).sort();
  fPatente.innerHTML = '<option value="">Todas las patentes</option>' +
    arr.map(p => `<option value="${p}">${p}</option>`).join('');
  if (arr.includes(selPrev)) fPatente.value = selPrev;
}
function inRange(fecha, d, h){
  if (!fecha) return false;
  const f = String(fecha).slice(0,10);
  if (d && f < d) return false;
  if (h && f > h) return false;
  return true;
}
function pasaTexto(q, ...campos){
  q = (q||'').trim().toLowerCase();
  if (!q) return true;
  return campos.some(c => ((c||'')+'').toLowerCase().includes(q));
}

/* ---------------------- Render ---------------------- */
function render(){
  const d = fDesde.value || '';
  const h = fHasta.value || '';
  const p = fPatente.value || '';
  const est = fEstadoMant.value || '';
  const q = fQ.value || '';

  movs = [];

  // --- Viajes: peajes / adelantos / entradas ---
  for (const v of viajes){
    if (!inRange(v.fecha, d, h)) continue;
    if (p && (v.patente||'') !== p) continue;
    if (!pasaTexto(q, v.origen, v.destino, v.cuitOrigen, v.observaciones, v.patente)) continue;

    if (v.peajeAplica && Number(v.peajeMonto)>0){
      movs.push({fecha:v.fecha, tipo:'Peaje', detalle:`Viaje ${v.origen||''} → ${v.destino||''}`, patente:v.patente||'', importe: Number(v.peajeMonto||0)});
    }
    if (v.adelantoAplica && Number(v.adelantoMonto)>0){
      movs.push({fecha:v.fecha, tipo:'Adelanto', detalle:`Adelanto chofer`, patente:v.patente||'', importe: Number(v.adelantoMonto||0)});
    }
    if (v.entradaAplica && Number(v.entradaMonto)>0){
      movs.push({fecha:v.fecha, tipo:'Entrada', detalle:`Entrada`, patente:v.patente||'', importe: Number(v.entradaMonto||0)});
    }
  }

  // --- Combustible ---
  for (const c of combustible){
    // se asume campos: fecha, total, patente, estacion, tipo
    if (!inRange(c.fecha, d, h)) continue;
    if (p && (c.patente||'') !== p) continue;
    if (!pasaTexto(q, c.estacion, c.tipo, c.metodo, c.patente)) continue;

    const total = Number(c.total ?? (Number(c.litros||0) * Number(c.sl||c.precioLitro||0)));
    if (total>0){
      movs.push({fecha:c.fecha, tipo:'Combustible', detalle:`${c.estacion||'-'} — ${c.tipo||''}`, patente:c.patente||'', importe: total});
    }
  }

  // --- Mantenimiento ---
  for (const m of mant){
    if (!inRange(m.fecha, d, h)) continue;
    if (p && (m.patente||'') !== p) continue;
    if (est==='pagado'   && !(m.pagado===true || m.pagado==='si')) continue;
    if (est==='adeudado' &&  (m.pagado===true || m.pagado==='si')) continue;
    if (!pasaTexto(q, m.proveedor, m.tipo, m.observaciones, m.patente)) continue;

    const tot = Number(m.total ?? 0);
    if (tot>0){
      movs.push({fecha:m.fecha, tipo:'Mantenimiento', detalle:`${m.tipo||''} — ${m.proveedor||''}`, patente:m.patente||'', importe: tot});
    }
  }

  // Ordenar por fecha ↓
  movs.sort((a,b)=> String(b.fecha).localeCompare(String(a.fecha)));

  // Subtotales por tipo
  const s = (tipo) => movs.filter(x=>x.tipo===tipo).reduce((a,b)=>a+Number(b.importe||0),0);
  const comb = s('Combustible');
  const mantT= s('Mantenimiento');
  const peaj = s('Peaje');
  const adel = s('Adelanto');
  const entr = s('Entrada');
  const total = comb + mantT + peaj + adel + entr;

  kComb.textContent = fmt(comb);
  kMant.textContent = fmt(mantT);
  kPeaje.textContent= fmt(peaj);
  kAdel.textContent = fmt(adel);
  kEntrada.textContent = fmt(entr);
  kTotal.textContent = fmt(total);

  // Render tabla
  tbody.innerHTML = '';
  if (!movs.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="5" style="padding:18px;opacity:.85">No hay movimientos para los filtros seleccionados.</td>`;
    tbody.appendChild(tr);
    return;
  }
  for (const m of movs){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${(m.fecha||'').slice(0,10)}</td>
      <td>${m.tipo}</td>
      <td>${m.detalle||''}</td>
      <td>${m.patente||''}</td>
      <td class="monto">${fmt(m.importe||0)}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* ---------------------- Eventos filtros ---------------------- */
[fDesde,fHasta,fPatente,fEstadoMant,fQ].forEach(el => el.addEventListener('input', render));
document.getElementById('btnLimpiar').addEventListener('click', ()=>{
  fDesde.value=''; fHasta.value=''; fPatente.value=''; fEstadoMant.value=''; fQ.value='';
  render();
});

/* ---------------------- CSV & Print ---------------------- */
document.getElementById('btnCSV').addEventListener('click', ()=>{
  if (!movs.length){ alert('No hay datos para exportar.'); return; }
  const head = ['Fecha','Tipo','Detalle','Patente','Importe'];
  const rows = movs.map(m => [ (m.fecha||'').slice(0,10), m.tipo, (m.detalle||'').replace(/[\r\n]+/g,' '), m.patente||'', String(m.importe||0).replace('.',',') ]);
  const csv = [head, ...rows].map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(';')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'finanzas.csv'; a.click();
  URL.revokeObjectURL(url);
});

document.getElementById('btnPrint').addEventListener('click', ()=>{
  const rows = movs.map(m => `
    <tr>
      <td>${(m.fecha||'').slice(0,10)}</td>
      <td>${m.tipo}</td>
      <td>${m.detalle||''}</td>
      <td>${m.patente||''}</td>
      <td class="r">${fmt(m.importe||0)}</td>
    </tr>`).join('');

  const html = `
<!DOCTYPE html><html lang="es"><head><meta charset="utf-8">
<title>Finanzas</title>
<style>
  body{font-family:Arial,Segoe UI,Tahoma,sans-serif;margin:28px;color:#111}
  h1{margin:0 0 8px}
  .cards{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin:10px 0}
  .card{border:1px solid #bbb;border-radius:8px;padding:8px;text-align:center}
  .card small{display:block;opacity:.8}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  th{background:#f5f5f5}
  .r{text-align:right}
  @media print {.no-print{display:none}}
</style></head><body>
  <h1>Finanzas</h1>
  <div class="cards">
    <div class="card"><small>Combustible</small><b>${kComb.textContent}</b></div>
    <div class="card"><small>Mantenimiento</small><b>${kMant.textContent}</b></div>
    <div class="card"><small>Peajes</small><b>${kPeaje.textContent}</b></div>
    <div class="card"><small>Adelantos</small><b>${kAdel.textContent}</b></div>
    <div class="card"><small>Entradas</small><b>${kEntrada.textContent}</b></div>
    <div class="card"><small>Total Gastos</small><b>${kTotal.textContent}</b></div>
  </div>
  <table>
    <thead><tr><th>Fecha</th><th>Tipo</th><th>Detalle</th><th>Patente</th><th class="r">Importe</th></tr></thead>
    <tbody>${rows || `<tr><td colspan="5">Sin datos</td></tr>`}</tbody>
  </table>
  <button class="no-print" onclick="window.print()">Imprimir</button>
</body></html>`;
  const w = window.open('', '_blank', 'width=900,height=1000');
  w.document.open(); w.document.write(html); w.document.close(); w.focus();
  setTimeout(()=>w.print(), 300);
});
</script>
</body>
</html>
