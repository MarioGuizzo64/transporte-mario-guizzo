<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Finanzas</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
  :root{
    --yellow:#FFD700; --black:#0d0d0d; --panel:#111; --white:#fff;
    --green:#2e7d32; --red:#d32f2f; --orange:#ffa000; --blue:#1976d2;
  }
  body{margin:0;background:var(--yellow);font-family:Arial,Helvetica,sans-serif;color:#fff}
  .wrap{max-width:1100px;margin:30px auto;background:#000;border-radius:12px;padding:22px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
  h1{margin:0 0 12px;text-align:center;text-transform:uppercase;text-decoration:underline}
  .tabs{display:flex;gap:8px;justify-content:center;margin-bottom:10px;flex-wrap:wrap}
  .tab{padding:10px 12px;border:1px solid #000;border-radius:8px;background:#111;cursor:pointer}
  .tab.active{background:#1a1a1a;box-shadow:0 0 0 2px #222 inset}
  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-start;margin-bottom:10px}
  .bar input,.bar select{padding:8px;border:1px solid #000;border-radius:6px;background:#fff;color:#000}
  .btn{padding:10px 12px;border:1px solid #000;border-radius:8px;font-weight:bold;text-transform:uppercase;cursor:pointer}
  .btn-verde{background:var(--green);color:#fff}
  .btn-naranja{background:var(--orange);color:#000}
  .btn-azul{background:var(--blue);color:#fff}
  .cards{display:grid;grid-template-columns:repeat(8,1fr);gap:10px;margin:10px 0}
  .card{background:#0f0f0f;border:1px solid #222;border-radius:10px;padding:12px;text-align:center}
  .card small{opacity:.8}
  .card b{display:block;margin-top:6px;font-size:18px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .panel{background:#0f0f0f;border:1px solid #222;border-radius:12px;padding:12px}
  canvas{background:#0b0b0b;border-radius:10px;padding:8px}
  .tabla{width:100%;border-collapse:collapse;background:#111;border-radius:10px;overflow:hidden}
  .tabla th,.tabla td{padding:10px;border-bottom:1px solid #222;text-align:left}
  .tabla th{background:#0f0f0f}
  .monto{text-align:right}
  .right{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  .volver{margin-top:14px}
  .note{font-size:12px;opacity:.75}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
  .chip{background:#151515;border:1px solid #333;color:#fff;padding:6px 10px;border-radius:20px;cursor:pointer;font-size:12px}
  .chip.active{background:#1976d2;border-color:#1976d2}
  @media (max-width:1100px){.cards{grid-template-columns:repeat(4,1fr)}}
  @media (max-width:780px){.cards{grid-template-columns:repeat(2,1fr)} .grid2{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Finanzas</h1>

  <div class="tabs">
    <button class="tab active" data-tab="resumen">Resumen</button>
    <button class="tab" data-tab="chofer">Por chofer</button>
    <button class="tab" data-tab="tabla">Tabla</button>
  </div>

  <div class="bar">
    <input type="date" id="fDesde">
    <input type="date" id="fHasta">
    <select id="fChofer"><option value="">Todos los choferes</option></select>
    <select id="fPatente"><option value="">Todas las patentes</option></select>
    <select id="fEstadoMant">
      <option value="">Mantenimiento (todos)</option>
      <option value="pagado">Mantenimiento pagado</option>
      <option value="adeudado">Mantenimiento adeudado</option>
    </select>
    <input id="fQ" placeholder="Buscar (estación, proveedor, obs)">
    <button id="btnLimpiar" class="btn btn-naranja">Limpiar</button>
    <div class="right" style="margin-left:auto">
      <button id="btnCSV" class="btn btn-azul">Exportar CSV</button>
      <button id="btnPrintTabla" class="btn btn-verde">Imprimir tabla</button>
      <!-- NUEVO: selector de orientación -->
      <select id="selOrient">
        <option value="portrait">Vertical (A4)</option>
        <option value="landscape">Horizontal (A4)</option>
      </select>
      <button id="btnPrintLiq" class="btn btn-verde">Imprimir liquidación</button>
    </div>
  </div>

  <!-- Tarjetas -->
  <div id="cards" class="cards panel">
    <div class="card"><small>Subtotal (Ingresos)</small> <b id="kIngSub">$ 0</b></div>
    <div class="card"><small>IVA 21%</small>             <b id="kIVA">$ 0</b></div>
    <div class="card"><small>Total (c/ IVA)</small>      <b id="kIngTot">$ 0</b></div>
    <div class="card"><small>Combustible</small>         <b id="kComb">$ 0</b></div>
    <div class="card"><small>Mantenimiento</small>       <b id="kMant">$ 0</b></div>
    <div class="card"><small>Peajes</small>              <b id="kPeaje">$ 0</b></div>
    <div class="card"><small>Entradas</small>            <b id="kEntrada">$ 0</b></div>
    <div class="card"><small>Adelantos</small>           <b id="kAdel">$ 0</b></div>
  </div>
  <div class="cards">
    <div class="card" style="grid-column: span 2"><small>Comisión chofer (18% por defecto)</small><b id="kComision">$ 0</b></div>
    <div class="card" style="grid-column: span 3"><small>A pagar choferes (Comisión − Adelantos + Peajes + Entradas)</small><b id="kAPagarChofer">$ 0</b></div>
    <div class="card" style="grid-column: span 3"><small>MARGEN (Subtotal – Gastos)</small><b id="kMargen">$ 0</b></div>
  </div>

  <section id="tab-resumen">
    <div id="chipsPat" class="chips"></div>
    <div class="grid2">
      <div class="panel">
        <h3 style="margin:6px 0 12px">Ingresos vs Egresos <span id="titPatente"></span></h3>
        <canvas id="chartPatentes" height="180"></canvas>
        <div class="note">Comparación con <b>Subtotal</b> (sin IVA) vs Egresos del rango y camión seleccionado.</div>
      </div>
      <div class="panel">
        <h3 style="margin:6px 0 12px">Composición de egresos <span id="titPatente2"></span></h3>
        <canvas id="chartEgresos" height="180"></canvas>
        <div class="note">Combustible + Mantenimiento + Peajes + Adelantos + Entradas + Comisión.</div>
      </div>
    </div>
  </section>

  <section id="tab-chofer" style="display:none">
    <div class="panel">
      <h3 style="margin:6px 0 12px">Liquidación por Chofer</h3>
      <div class="note" style="margin-bottom:8px">
        Comisión = Ingreso × %  ·  Liquidación = Comisión − Adelantos + Peajes + Entradas.
        Si en <code>usuarios</code> no hay <code>porcentaje</code>, se usa <b>18%</b>.
      </div>
      <table class="tabla">
        <thead>
          <tr>
            <th style="width:120px">Chofer</th>
            <th>Viajes</th>
            <th class="monto" style="width:140px">Ingreso</th>
            <th class="monto" style="width:100px">% Comis.</th>
            <th class="monto" style="width:140px">Comisión</th>
            <th class="monto" style="width:120px">Peajes</th>
            <th class="monto" style="width:120px">Entradas</th>
            <th class="monto" style="width:120px">Adelantos</th>
            <th class="monto" style="width:140px">Liquidación</th>
          </tr>
        </thead>
        <tbody id="tbodyChofer"></tbody>
      </table>
    </div>

    <div class="panel" style="margin-top:12px">
      <h3 style="margin:6px 0 12px">Liquidación por Chofer y Patente</h3>
      <table class="tabla">
        <thead>
          <tr>
            <th style="width:120px">Chofer</th>
            <th style="width:120px">Patente</th>
            <th>Viajes</th>
            <th class="monto" style="width:140px">Ingreso</th>
            <th class="monto" style="width:100px">% Comis.</th>
            <th class="monto" style="width:140px">Comisión</th>
            <th class="monto" style="width:120px">Peajes</th>
            <th class="monto" style="width:120px">Entradas</th>
            <th class="monto" style="width:120px">Adelantos</th>
            <th class="monto" style="width:140px">Liquidación</th>
          </tr>
        </thead>
        <tbody id="tbodyChoferPat"></tbody>
      </table>
    </div>
  </section>

  <section id="tab-tabla" style="display:none">
    <div class="panel">
      <h3 style="margin:6px 0 12px">Movimientos (Ingresos + Egresos)</h3>
      <table class="tabla" id="tabla">
        <thead>
          <tr>
            <th style="width:120px">Fecha</th>
            <th style="width:140px">Tipo</th>
            <th>Detalle</th>
            <th style="width:140px">Chofer</th>
            <th style="width:120px">Patente</th>
            <th class="monto" style="width:140px">Importe</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <button class="btn btn-naranja volver" onclick="location.href='admin.html'">Volver</button>
</div>

<script type="module">
/* ======= CONFIG ======= */
const DEFAULT_COMMISSION = 0.18;  // 18%
const IVA_RATE = 0.21;

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
  authDomain: "transporte-mario-guizzo.firebaseapp.com",
  projectId: "transporte-mario-guizzo",
  storageBucket: "transporte-mario-guizzo.appspot.com",
  messagingSenderId: "465536166890",
  appId: "1:465536166890:web:f658690629b09eca8fa093"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db  = getFirestore(app);

onAuthStateChanged(auth, (u) => {
  if (!u) { location.href = "login.html"; return; }
  start();
});

/* ======= STATE ======= */
let viajes = [], _comb1 = [], _comb2 = [], combustible = [], mant = [], usuarios = [];
let movs = [];
let patSet = new Set(), choSet = new Set();
let activeTab = 'resumen';
let selectedPatChip = '';

/* ======= UI refs ======= */
const fDesde   = document.getElementById('fDesde');
const fHasta   = document.getElementById('fHasta');
const fChofer  = document.getElementById('fChofer');
const fPatente = document.getElementById('fPatente');
const fEstadoMant = document.getElementById('fEstadoMant');
const fQ       = document.getElementById('fQ');

const kIngSub = document.getElementById('kIngSub');
const kIVA    = document.getElementById('kIVA');
const kIngTot = document.getElementById('kIngTot');
const kComb   = document.getElementById('kComb');
const kMant   = document.getElementById('kMant');
const kPeaje  = document.getElementById('kPeaje');
const kAdel   = document.getElementById('kAdel');
const kEntrada= document.getElementById('kEntrada');
const kComision = document.getElementById('kComision');
const kAPagarChofer = document.getElementById('kAPagarChofer');
const kMargen = document.getElementById('kMargen');

const tbody = document.getElementById('tbody');
const tbodyChofer = document.getElementById('tbodyChofer');
const tbodyChoferPat = document.getElementById('tbodyChoferPat');
const chipsPat = document.getElementById('chipsPat');
const titPat1 = document.getElementById('titPatente');
const titPat2 = document.getElementById('titPatente2');

const fmt = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0));

/* ======= DEBUG ======= */
let dbg = document.getElementById('dbg');
if (!dbg){
  dbg = document.createElement('div');
  dbg.id = 'dbg';
  dbg.className = 'note';
  dbg.style.margin = '6px 0 10px';
  document.querySelector('.wrap').insertBefore(dbg, document.querySelector('.tabs'));
}
const showDbg = (extra='')=>{
  dbg.textContent = `docs → viajes:${viajes.length} · combustible:${combustible.length} · mant:${mant.length} · choferes:${usuarios.length} ${extra?'· '+extra:''}`;
};

/* ======= Helpers ======= */
function parseARS(x){
  if (typeof x === 'number') return isFinite(x)?x:0;
  if (x == null) return 0;
  let s = String(x).trim().replace(/[^\d,.\-]/g,'');
  if (!s) return 0;
  s = s.replace(/\./g,'').replace(',', '.');
  const n = Number(s);
  return isNaN(n) ? 0 : n;
}
function fechaStr(x){
  if (!x) return '';
  if (typeof x === 'string') return x.slice(0,10);
  if (x instanceof Date) return x.toISOString().slice(0,10);
  if (typeof x === 'object'){
    if (typeof x.toDate === 'function') return x.toDate().toISOString().slice(0,10);
    if (typeof x.seconds === 'number') return new Date(x.seconds*1000).toISOString().slice(0,10);
  }
  return String(x).slice(0,10);
}
function inRangeFechaStr(fstr, d, h){
  if (!d && !h) return true;
  if (!fstr) return false;
  if (d && fstr < d) return false;
  if (h && fstr > h) return false;
  return true;
}
function pasaTexto(q, ...campos){
  q = (q||'').trim().toLowerCase();
  if (!q) return true;
  return campos.some(c => ((c||'')+'').toLowerCase().includes(q));
}

function ingresoViaje(v){
  const cand = [v.importeCobrado, v.totalCobrado, v.importe, v.ingreso, v.total];
  for (const val of cand){
    const n = parseARS(val);
    if (n>0) return n;
  }
  const kg = parseARS(v.kgDescargados ?? v.kg ?? v.kgDesc ?? 0);
  const tTon = parseARS(v.tarifaPorTon ?? v.tarifa ?? 0);
  const tKg  = parseARS(v.tarifaPorKg ?? 0);
  if (tTon>0 && kg>0){ return (kg>1000 ? (kg/1000)*tTon : kg*tTon); }
  if (tKg>0 && kg>0) return kg*tKg;
  return 0;
}
function getPctChofer(nombre, patente){
  const byName = usuarios.find(u => (u.nombre||u.displayName||'').trim() === (nombre||'').trim());
  if (byName && Number(byName.porcentaje) >= 0) return Number(byName.porcentaje)/100;

  const byArray = usuarios.find(u => Array.isArray(u.patentes) && u.patentes.map(p=>String(p).toUpperCase()).includes(String(patente||'').toUpperCase()));
  if (byArray && Number(byArray.porcentaje) >= 0) return Number(byArray.porcentaje)/100;

  const bySingle = usuarios.find(u => typeof u.patente === 'string' && String(u.patente).toUpperCase() === String(patente||'').toUpperCase());
  if (bySingle && Number(bySingle.porcentaje) >= 0) return Number(bySingle.porcentaje)/100;

  return DEFAULT_COMMISSION; // 18%
}
const fechaViaje = (v) => fechaStr(v.fecha || v.fechaViaje || v.fechaSalida || v.fechaCarga || v.createdAt || null);

/* Combustible helpers */
const combPatente  = (c) => (c.patenteCamion || c.patente || '').trim().toUpperCase();
const combEstacion = (c) => c.estacionServicio || c.estacion || '';
const combMetodo   = (c) => c.metodoPago || c.metodo || '';
const combTipo     = (c) => c.tipoCombustible || c.tipo || '';
const combFecha    = (c) => fechaStr(c.fecha || c.fechaCarga || c.fechaCompra || null);
const combTotal    = (c) => {
  const litros = parseARS(c.litros);
  const precio = parseARS(c.precioPorLitro ?? c.sl);
  if (litros>0 && precio>0) return litros*precio;
  const cand = [c.totalPagado, c.total];
  for (const v of cand){ const n = parseARS(v); if (n>0) return n; }
  return 0;
};

/* ======= Data listeners ======= */
function start(){
  onSnapshot(collection(db,'usuarios'), qs=>{
    usuarios = qs.docs.map(d => ({id:d.id, ...d.data()}));
    choSet.clear();
    usuarios.forEach(u => choSet.add( (u.nombre||u.displayName||u.email||'').trim() ));
    poblarChoferes(); showDbg(); render();
  });

  onSnapshot(collection(db,'viajes'), qs=>{
    viajes = qs.docs.map(d => ({id:d.id, ...d.data()}));
    viajes.forEach(v=>{
      const p = (v.patente||'').trim().toUpperCase();
      if (p) patSet.add(p);
      if (v.chofer)  choSet.add((v.chofer||'').trim());
    });
    poblarPatentes(); poblarChoferes(); showDbg(); render();
  });

  onSnapshot(collection(db,'cargas-combustible'), qs=>{
    _comb1 = qs.docs.map(d => ({id:d.id, ...d.data()}));
    recomputeCombustible();
  });

  onSnapshot(collection(db,'cargasCombustible'), qs=>{
    _comb2 = qs.docs.map(d => ({id:d.id, ...d.data()}));
    recomputeCombustible();
  });

  onSnapshot(collection(db,'mantenimientos'), qs=>{
    mant = qs.docs.map(d => ({id:d.id, ...d.data()}));
    mant.forEach(m=> { const p = (m.patente||'').trim().toUpperCase(); if (p) patSet.add(p); });
    poblarPatentes(); showDbg(); render();
  });
}
function recomputeCombustible(){
  combustible = [..._comb1, ..._comb2];
  combustible.forEach(c=> { const p = combPatente(c); if (p) patSet.add(p); });
  poblarPatentes(); showDbg(); render();
}

/* ======= UI builders ======= */
function poblarPatentes(){
  const prev = (fPatente.value||'').toUpperCase();
  const arr = Array.from(patSet).filter(Boolean).sort();
  fPatente.innerHTML = '<option value="">Todas las patentes</option>' + arr.map(p=>`<option>${p}</option>`).join('');
  if (arr.includes(prev)) fPatente.value = prev;
  buildChips(arr);
}
function poblarChoferes(){
  const prev = fChofer.value;
  const arr = Array.from(choSet).filter(Boolean).sort();
  fChofer.innerHTML = '<option value="">Todos los choferes</option>' + arr.map(c=>`<option>${c}</option>`).join('');
  if (arr.includes(prev)) fChofer.value = prev;
}
function buildChips(arr){
  const pats = arr.slice(0,20);
  let html = `<button class="chip ${selectedPatChip===''?'active':''}" data-pt="">Total</button>`;
  html += pats.map(p => `<button class="chip ${selectedPatChip===p?'active':''}" data-pt="${p}">${p}</button>`).join('');
  chipsPat.innerHTML = html;
  chipsPat.querySelectorAll('.chip').forEach(b=>{
    b.onclick = ()=>{
      selectedPatChip = b.dataset.pt || '';
      chipsPat.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      renderCharts(movs);
    };
  });
}

/* ======= Render principal ======= */
function render(){
  const d = fDesde.value||'', h = fHasta.value||'';
  const ch = fChofer.value||'', pt = (fPatente.value||'').toUpperCase();
  const est = fEstadoMant.value||'', q = fQ.value||'';

  movs = [];

  const viajesFiltrados = viajes.filter(v=>{
    const f = fechaViaje(v);
    if (!inRangeFechaStr(f, d, h)) return false;
    if (ch && (v.chofer||'') !== ch) return false;
    if (pt && (String(v.patente||'').toUpperCase() !== pt)) return false;
    if (!pasaTexto(q, v.origen, v.destino, v.cuitOrigen, v.observaciones, v.chofer, v.patente)) return false;
    return true;
  });

  // Ingresos + extras por viaje
  for (const v of viajesFiltrados){
    const ingreso = ingresoViaje(v);
    const f = fechaViaje(v);
    const patenteUp = String(v.patente||'').toUpperCase();
    if (Number(ingreso)>0){
      movs.push({fecha:f, tipo:'Ingreso', detalle:`${v.origen||''} → ${v.destino||''}`, chofer:v.chofer||'', patente:patenteUp, importe:ingreso});
      const pct = getPctChofer(v.chofer, patenteUp);
      const comi = ingreso * pct; // 18% por defecto
      if (Number(comi)>0){
        movs.push({fecha:f, tipo:'Comisión', detalle:`Comisión chofer ${Math.round(pct*100)}%`, chofer:v.chofer||'', patente:patenteUp, importe:comi});
      }
    }
    if (v.peajeAplica && parseARS(v.peajeMonto)>0){
      movs.push({fecha:f, tipo:'Peaje', detalle:'Peaje', chofer:v.chofer||'', patente:patenteUp, importe:parseARS(v.peajeMonto)});
    }
    if (v.entradaAplica && parseARS(v.entradaMonto)>0){
      movs.push({fecha:f, tipo:'Entrada', detalle:'Entrada', chofer:v.chofer||'', patente:patenteUp, importe:parseARS(v.entradaMonto)});
    }
    if (v.adelantoAplica && parseARS(v.adelantoMonto)>0){
      movs.push({fecha:f, tipo:'Adelanto', detalle:'Adelanto chofer', chofer:v.chofer||'', patente:patenteUp, importe:parseARS(v.adelantoMonto)});
    }
  }

  // Combustible
  combustible.filter(c=>{
    const f = combFecha(c);
    if (!inRangeFechaStr(f, d, h)) return false;
    if (pt && (combPatente(c).toUpperCase() !== pt)) return false;
    if (ch && (c.chofer||'') !== ch) return false;
    if (!pasaTexto(q, combEstacion(c), combTipo(c), combMetodo(c), combPatente(c))) return false;
    return true;
  }).forEach(c=>{
    const tot = combTotal(c);
    if (tot>0) movs.push({
      fecha: combFecha(c),
      tipo: 'Combustible',
      detalle: `${combEstacion(c) || '-'} — ${combTipo(c) || ''}`,
      chofer: c.chofer || '',
      patente: combPatente(c).toUpperCase(),
      importe: tot
    });
  });

  // Mantenimiento
  mant.filter(m=>{
    const f = fechaStr(m.fecha);
    if (!inRangeFechaStr(f, d, h)) return false;
    if (pt && (String(m.patente||'').toUpperCase() !== pt)) return false;
    if (est==='pagado'   && !(m.pagado===true || String(m.pagado).toLowerCase()==='si')) return false;
    if (est==='adeudado' &&  (m.pagado===true || String(m.pagado).toLowerCase()==='si')) return false;
    if (!pasaTexto(q, m.proveedor, m.tipo, m.observaciones, m.patente)) return false;
    return true;
  }).forEach(m=>{
    const tot = parseARS(m.total||0);
    if (tot>0) movs.push({
      fecha: fechaStr(m.fecha),
      tipo:'Mantenimiento',
      detalle:`${m.tipo||''} — ${m.proveedor||''}`,
      chofer:'',
      patente:String(m.patente||'').toUpperCase(),
      importe:tot
    });
  });

  movs.sort((a,b)=> b.fecha.localeCompare(a.fecha));

  const sum = (tipo) => movs.filter(x=>x.tipo===tipo).reduce((a,b)=>a+Number(b.importe||0),0);
  const subtotal   = sum('Ingreso');          // sin IVA
  const iva        = subtotal * IVA_RATE;     // 21%
  const totalIng   = subtotal + iva;          // con IVA

  const combTotal$ = sum('Combustible');
  const mantTotal  = sum('Mantenimiento');
  const peajeTotal = sum('Peaje');
  const adelTotal  = sum('Adelanto');
  const entTotal   = sum('Entrada');
  const comiTotal  = sum('Comisión');

  const gastos     = combTotal$ + mantTotal + peajeTotal + adelTotal + entTotal + comiTotal;
  const margen     = subtotal - gastos;       // Margen sobre ingresos netos (sin IVA)

  // A pagar choferes: Comisión − Adelantos + Peajes + Entradas
  const aPagarChofer = comiTotal - adelTotal + peajeTotal + entTotal;

  // Cards
  kIngSub.textContent = fmt(subtotal);
  kIVA.textContent    = fmt(iva);
  kIngTot.textContent = fmt(totalIng);
  kComb.textContent   = fmt(combTotal$);
  kMant.textContent   = fmt(mantTotal);
  kPeaje.textContent  = fmt(peajeTotal);
  kAdel.textContent   = fmt(adelTotal);
  kEntrada.textContent= fmt(entTotal);
  kComision.textContent=fmt(comiTotal);
  kAPagarChofer.textContent = fmt(aPagarChofer);
  kMargen.textContent  = fmt(margen);

  // Tabla movimientos
  tbody.innerHTML = movs.length ? movs.map(m=>`
    <tr>
      <td>${m.fecha}</td>
      <td>${m.tipo}</td>
      <td>${m.detalle||''}</td>
      <td>${m.chofer||''}</td>
      <td>${m.patente||''}</td>
      <td class="monto">${fmt(m.importe||0)}</td>
    </tr>`).join('') : `<tr><td colspan="6" style="padding:18px;opacity:.85">Sin movimientos.</td></tr>`;

  renderChofer(viajesFiltrados);
  renderCharts(movs);
  showDbg();
}

/* ======= Render por chofer ======= */
function renderChofer(viajesFiltrados){
  const map = new Map();
  for (const v of viajesFiltrados){
    const key = v.chofer||'(Sin chofer)';
    const pct = getPctChofer(v.chofer, v.patente);
    if (!map.has(key)) map.set(key, {viajes:0, ingreso:0, peaje:0, entrada:0, adelanto:0, pct});
    const o = map.get(key);
    o.viajes++;
    o.ingreso += ingresoViaje(v);
    if (v.peajeAplica)   o.peaje   += parseARS(v.peajeMonto||0);
    if (v.entradaAplica) o.entrada += parseARS(v.entradaMonto||0);
    if (v.adelantoAplica)o.adelanto+= parseARS(v.adelantoMonto||0);
  }
  const rows = [...map.entries()].map(([cho, o])=>{
    const comision = o.ingreso * (o.pct ?? DEFAULT_COMMISSION);
    const liq = comision - o.adelanto + o.peaje + o.entrada;
    return {chofer:cho, viajes:o.viajes, ingreso:o.ingreso, pct:o.pct, comision, peaje:o.peaje, entrada:o.entrada, adelanto:o.adelanto, liquidacion:liq};
  }).sort((a,b)=> a.chofer.localeCompare(b.chofer));

  tbodyChofer.innerHTML = rows.length ? rows.map(r=>`
    <tr>
      <td>${r.chofer}</td>
      <td>${r.viajes}</td>
      <td class="monto">${fmt(r.ingreso)}</td>
      <td class="monto">${Math.round(((r.pct ?? DEFAULT_COMMISSION) * 100))}%</td>
      <td class="monto">${fmt(r.comision)}</td>
      <td class="monto">${fmt(r.peaje)}</td>
      <td class="monto">${fmt(r.entrada)}</td>
      <td class="monto">${fmt(r.adelanto)}</td>
      <td class="monto"><b>${fmt(r.liquidacion)}</b></td>
    </tr>`).join('') : `<tr><td colspan="9" style="padding:14px;opacity:.85">Sin viajes en el rango.</td></tr>`;

  const map2 = new Map();
  for (const v of viajesFiltrados){
    const key = (v.chofer||'(Sin chofer)') + '||' + (String(v.patente||'(sin patente)').toUpperCase());
    const pct = getPctChofer(v.chofer, v.patente);
    if (!map2.has(key)) map2.set(key, {chofer:v.chofer||'(Sin chofer)', patente:String(v.patente||'(sin patente)').toUpperCase(), viajes:0, ingreso:0, peaje:0, entrada:0, adelanto:0, pct});
    const o = map2.get(key);
    o.viajes++;
    o.ingreso += ingresoViaje(v);
    if (v.peajeAplica)   o.peaje   += parseARS(v.peajeMonto||0);
    if (v.entradaAplica) o.entrada += parseARS(v.entradaMonto||0);
    if (v.adelantoAplica)o.adelanto+= parseARS(v.adelantoMonto||0);
  }
  const rows2 = [...map2.values()].map(o=>{
    const comision = o.ingreso * (o.pct ?? DEFAULT_COMMISSION);
    const liq = comision - o.adelanto + o.peaje + o.entrada;
    return {...o, comision, liquidacion:liq};
  }).sort((a,b)=> a.chofer.localeCompare(b.chofer) || a.patente.localeCompare(b.patente));

  tbodyChoferPat.innerHTML = rows2.length ? rows2.map(r=>`
    <tr>
      <td>${r.chofer}</td>
      <td>${r.patente}</td>
      <td>${r.viajes}</td>
      <td class="monto">${fmt(r.ingreso)}</td>
      <td class="monto">${Math.round(((r.pct ?? DEFAULT_COMMISSION) * 100))}%</td>
      <td class="monto">${fmt(r.comision)}</td>
      <td class="monto">${fmt(r.peaje)}</td>
      <td class="monto">${fmt(r.entrada)}</td>
      <td class="monto">${fmt(r.adelanto)}</td>
      <td class="monto"><b>${fmt(r.liquidacion)}</b></td>
    </tr>`).join('') : `<tr><td colspan="10" style="padding:14px;opacity:.85">Sin viajes en el rango.</td></tr>`;

  window.__rowsChofer = rows;
  window.__rowsChoferPat = rows2;
}

/* ======= Charts ======= */
function renderCharts(movsAll){
  if (!window.Chart){ return; }
  const mm = selectedPatChip ? movsAll.filter(m=>m.patente===selectedPatChip) : movsAll;
  titPat1.textContent = selectedPatChip ? `— ${selectedPatChip}` : '— Total';
  titPat2.textContent = selectedPatChip ? `— ${selectedPatChip}` : '— Total';

  const pats = [...new Set(mm.map(m=>m.patente).filter(Boolean))].sort();
  const ing = pats.map(p=> mm.filter(m=>m.patente===p && m.tipo==='Ingreso').reduce((a,b)=>a+Number(b.importe||0),0));
  const egr = pats.map(p=> mm.filter(m=>m.patente===p && m.tipo!=='Ingreso').reduce((a,b)=>a+Number(b.importe||0),0));
  const labels = pats.length ? pats : [ selectedPatChip || 'Total' ];
  const ingV   = pats.length ? ing : [ mm.filter(m=>m.tipo==='Ingreso').reduce((a,b)=>a+Number(b.importe||0),0) ];
  const egrV   = pats.length ? egr : [ mm.filter(m=>m.tipo!=='Ingreso').reduce((a,b)=>a+Number(b.importe||0),0) ];

  const ctx1 = document.getElementById('chartPatentes').getContext('2d');
  window.chrtPat && window.chrtPat.destroy();
  window.chrtPat = new window.Chart(ctx1,{
    type:'bar',
    data:{labels, datasets:[
      {label:'Ingresos (subtotal)', data:ingV, backgroundColor:'#4FC3F7', borderColor:'#4FC3F7', borderWidth:1},
      {label:'Egresos',            data:egrV, backgroundColor:'#EF5350', borderColor:'#EF5350', borderWidth:1}
    ]},
    options:{
      responsive:true,
      plugins:{
        legend:{position:'bottom', labels:{color:'#fff'}},
        tooltip:{bodyColor:'#fff', titleColor:'#fff'} /* blanco */
      },
      scales:{ x:{ticks:{color:'#eee'}, grid:{color:'#333'}}, y:{ticks:{color:'#eee'}, grid:{color:'#333'}} }
    }
  });

  const comp = ['Combustible','Mantenimiento','Peaje','Adelanto','Entrada','Comisión'];
  const vals = comp.map(t=> mm.filter(m=>m.tipo===t).reduce((a,b)=>a+Number(b.importe||0),0));
  const ctx2 = document.getElementById('chartEgresos').getContext('2d');
  window.chrtEgr && window.chrtEgr.destroy();
  window.chrtEgr = new window.Chart(ctx2,{
    type:'doughnut',
    data:{ labels:comp, datasets:[{ data:vals,
      backgroundColor:['#42A5F5','#EC407A','#FFB300','#66BB6A','#AB47BC','#8D6E63'],
      borderColor:['#42A5F5','#EC407A','#FFB300','#66BB6A','#AB47BC','#8D6E63'], borderWidth:1 }] },
    options:{ responsive:true, cutout:'55%',
      plugins:{ legend:{position:'bottom', labels:{color:'#fff'}}, tooltip:{bodyColor:'#fff', titleColor:'#fff'} }
    }
  });
}

/* ======= Export/impresión ======= */
[fDesde,fHasta,fChofer,fPatente,fEstadoMant,fQ].forEach(el => el.addEventListener('input', render));
document.getElementById('btnLimpiar').addEventListener('click', ()=>{
  fDesde.value=''; fHasta.value=''; fChofer.value=''; fPatente.value=''; fEstadoMant.value=''; fQ.value='';
  render();
});
document.querySelectorAll('.tab').forEach(b=>{
  b.onclick = ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active');
    document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.style.display='none');
    document.getElementById('tab-'+b.dataset.tab).style.display='block';
    activeTab = b.dataset.tab;
  };
});
document.getElementById('btnCSV').addEventListener('click', ()=>{
  if (!movs.length){ alert('No hay datos.'); return; }
  const head = ['Fecha','Tipo','Detalle','Chofer','Patente','Importe'];
  const rows = movs.map(m => [ m.fecha, m.tipo, (m.detalle||'').replace(/[\r\n]+/g,' '), m.chofer||'', m.patente||'', String(m.importe||0).replace('.',',') ]);
  const csv = [head, ...rows].map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(';')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'finanzas.csv'; a.click();
  URL.revokeObjectURL(url);
});
document.getElementById('btnPrintTabla').addEventListener('click', ()=>{
  if (activeTab !== 'tabla'){ document.querySelector('.tab[data-tab="tabla"]').click(); return; }
  const rows = movs.map(m => `
    <tr><td>${m.fecha}</td><td>${m.tipo}</td><td>${m.detalle||''}</td><td>${m.chofer||''}</td><td>${m.patente||''}</td><td class="r">${fmt(m.importe||0)}</td></tr>
  `).join('');
  const html = `
<!DOCTYPE html><html><head><meta charset="utf-8"><title>Movimientos</title>
<style>body{font-family:Arial;margin:28px;color:#111}table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}th{background:#f5f5f5}.r{text-align:right}</style></head>
<body onload="window.print()"><h2>Movimientos</h2>
<table><thead><tr><th>Fecha</th><th>Tipo</th><th>Detalle</th><th>Chofer</th><th>Patente</th><th class="r">Importe</th></tr></thead><tbody>${rows||'<tr><td colspan="6">Sin datos</td></tr>'}</tbody></table></body></html>`;
  const w = window.open('', '_blank', 'width=900,height=1000'); w.document.write(html); w.document.close(); w.focus();
});

/* ======= NUEVO: imprimir liquidación con detalle de viajes por patente ======= */
document.getElementById('btnPrintLiq').addEventListener('click', ()=>{
  const patenteSel = (fPatente.value||'').toUpperCase();
  if (!patenteSel){
    alert('Elegí una patente para imprimir la liquidación con detalle.');
    return;
  }
  const orient = document.getElementById('selOrient').value; // 'portrait' | 'landscape'

  // Filtrado igual que en pantalla
  const d = fDesde.value||'', h = fHasta.value||'';
  const ch = fChofer.value||'', q = fQ.value||'';
  const fechaDMY = (f)=>{ if(!f) return '—'; const d=new Date(f); return isNaN(d)? String(f).slice(0,10) : `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`; };
  const fmtAR = (n)=> new Intl.NumberFormat('es-AR',{maximumFractionDigits:0}).format(Number(n||0));
  const getCTG = (v)=> v.ctg || v.nroCTG || v.numeroCTG || v.CTG || v.ctgNumero || '';

  const viajesDet = viajes.filter(v=>{
    const f = fechaViaje(v);
    if (!inRangeFechaStr(f, d, h)) return false;
    if ((String(v.patente||'').toUpperCase()) !== patenteSel) return false;
    if (ch && (v.chofer||'') !== ch) return false;
    if (!pasaTexto(q, v.origen, v.destino, v.observaciones, v.ctg, v.nroCTG, v.numeroCTG)) return false;
    return true;
  }).sort((a,b)=> (fechaViaje(a)||'').localeCompare(fechaViaje(b)));

  const getTarifa = (v)=>{
    if (v.tarifaPorTon) return `$ ${fmtAR(parseARS(v.tarifaPorTon))}/tn`;
    if (v.tarifaPorKg)  return `$ ${fmtAR(parseARS(v.tarifaPorKg))}/kg`;
    if (v.tarifa)       return `$ ${fmtAR(parseARS(v.tarifa))}`;
    return '';
  };

  // Kg cargados y descargados: probá múltiples nombres de campos, devolvé string tal cual (no lo reformateo para respetar coma/punto).
  const kgCarg = (v)=> {
    const cand = [
      v.kgCargadosRaw, v.kgCargados, v.kgCargado, v.kgC, v.kgCarga, v.kilosCargados, v.kilosCarga
    ];
    let val = cand.find(x => x!=null && String(x).trim()!=='');
    if (val==null || String(val).trim()==='') val = ''; // no “heredo” descargados, así detectás si falta
    return (val==null)? '' : String(val);
  };
  const kgDesc = (v)=> {
    const cand = [v.kgDescargadosRaw, v.kgDescargados, v.kgDesc, v.kilosDescargados, v.kg];
    const val = cand.find(x => x!=null && String(x).trim()!=='');
    return (val==null)? '' : String(val);
  };

  const adel    = (v)=> (v.adelantoAplica ? parseARS(v.adelantoMonto||0) : 0);
  const peaje   = (v)=> (v.peajeAplica   ? parseARS(v.peajeMonto  ||0) : 0);
  const entrada = (v)=> (v.entradaAplica ? parseARS(v.entradaMonto||0) : 0);

  // Totales
  let tViajes = viajesDet.length, tComi = 0, tPeaje = 0, tEnt = 0, tAdel = 0, tLiq = 0;
  let tKgCarg = 0, tKgDesc = 0;
  viajesDet.forEach(v=>{
    const ingreso = ingresoViaje(v);
    const pct = getPctChofer(v.chofer, v.patente);
    const comi = ingreso * pct;
    const liq  = comi - adel(v) + peaje(v) + entrada(v);
    tComi += comi; tPeaje += peaje(v); tEnt += entrada(v); tAdel += adel(v); tLiq += liq;
    tKgCarg += parseARS(kgCarg(v)); tKgDesc += parseARS(kgDesc(v));
  });

  // Resumen superior (sin columnas de chofer/ingreso)
  const resumenHTML = `
    <table class="t resumen">
      <thead><tr>
        <th>Viajes</th><th>Comisión</th><th>Peajes</th><th>Entradas</th><th>Adelantos</th><th>Liquidación</th>
      </tr></thead>
      <tbody><tr>
        <td class="r">${fmtAR(tViajes)}</td>
        <td class="r">$ ${fmtAR(tComi)}</td>
        <td class="r">$ ${fmtAR(tPeaje)}</td>
        <td class="r">$ ${fmtAR(tEnt)}</td>
        <td class="r">$ ${fmtAR(tAdel)}</td>
        <td class="r"><b>$ ${fmtAR(tLiq)}</b></td>
      </tr></tbody>
    </table>`;

  // Filas detalle
  const rowsDet = viajesDet.map((v,i)=>`
    <tr>
      <td class="c">${i+1}</td>
      <td class="c nowrap">${fechaDMY(fechaViaje(v))}</td>
      <td class="c nowrap">${getCTG(v)}</td>
      <td class="wrap">${(v.origen||'')} → ${(v.destino||'')}</td>
      <td class="r nowrap">${getTarifa(v)}</td>
      <td class="r nowrap">${kgCarg(v)}</td>
      <td class="r nowrap">${kgDesc(v)}</td>
      <td class="r nowrap">${adel(v) ? '$ '+fmtAR(adel(v)) : ''}</td>
      <td class="r nowrap">${peaje(v) ? '$ '+fmtAR(peaje(v)) : ''}</td>
      <td class="r nowrap">${entrada(v) ? '$ '+fmtAR(entrada(v)) : ''}</td>
      <td class="wrap">${(v.observaciones||'').toString().replace(/[\r\n]+/g,' ')}</td>
    </tr>`).join('');

  const totDet = `
    <tfoot><tr>
      <td colspan="5" class="r"><b>Totales</b></td>
      <td class="r nowrap"><b>${fmtAR(tKgCarg)}</b></td>
      <td class="r nowrap"><b>${fmtAR(tKgDesc)}</b></td>
      <td class="r nowrap"><b>$ ${fmtAR(tAdel)}</b></td>
      <td class="r nowrap"><b>$ ${fmtAR(tPeaje)}</b></td>
      <td class="r nowrap"><b>$ ${fmtAR(tEnt)}</b></td>
      <td></td>
    </tr></tfoot>`;

  // Colgroup por orientación (porcentajes suman 100)
  const colgroup = (orient==='landscape')
    ? `<colgroup>
         <col style="width:4%"><col style="width:8%"><col style="width:12%"><col style="width:22%">
         <col style="width:10%"><col style="width:7%"><col style="width:7%"><col style="width:9%">
         <col style="width:6%"><col style="width:6%"><col style="width:9%">
       </colgroup>`
    : `<colgroup>
         <col style="width:4%"><col style="width:8%"><col style="width:12%"><col style="width:20%">
         <col style="width:9%"><col style="width:7%"><col style="width:7%"><col style="width:9%">
         <col style="width:6%"><col style="width:6%"><col style="width:12%">
       </colgroup>`;

  const html = `
<!DOCTYPE html><html><head><meta charset="utf-8"><title>Liquidación ${patenteSel}</title>
<style>
  @page{size:A4 ${orient};margin:0}
  body{font-family:Arial,Helvetica,sans-serif;margin:0}
  .page{position:relative;min-height:${orient==='landscape'?'210mm':'297mm'}}
  .frame{position:absolute;inset:5mm;border:2px solid #666}
  .frame::after{content:"";position:absolute;inset:3mm;border:1px solid #999}
  .content{position:relative;padding:${orient==='landscape'?'14mm':'18mm'} 12mm 12mm 12mm;color:#111}
  .head{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;margin-bottom:6mm}
  .head img{height:${orient==='landscape'?'18mm':'22mm'};object-fit:contain}
  h1{margin:0;text-align:center;text-transform:uppercase;letter-spacing:1px;font-size:${orient==='landscape'?'18px':'20px'}}
  .muted{color:#666;font-size:${orient==='landscape'?'10px':'11px'};text-align:center;margin-top:2mm}
  .badge{background:#e8f0ff;border:1px solid #c8d8ff;color:#003366;padding:3px 8px;border-radius:999px;font-size:12px}
  .t{width:100%;border-collapse:collapse;table-layout:fixed;margin-top:2mm}
  .t th,.t td{border-bottom:1px solid #ddd;padding:${orient==='landscape'?'5px 6px':'6px 8px'};vertical-align:top;font-size:${orient==='landscape'?'11px':'12px'}}
  .t thead th{background:#f3f6ff;border-bottom:1px solid #cfd8ff}
  .resumen thead th{background:#eef7ee;border-bottom:1px solid #cfe3cf}
  .r{text-align:right} .c{text-align:center}
  .nowrap{white-space:nowrap}
  .wrap{white-space:normal;word-break:break-word;overflow-wrap:anywhere}
</style></head>
<body onload="window.print()">
<div class="page">
  <div class="frame"></div>
  <div class="content">
    <div class="head">
      <img src="/logo.png" alt="Logo" onerror="this.style.display='none'">
      <div>
        <h1>LIQUIDACIÓN — PATENTE ${patenteSel}</h1>
        <div class="muted">Rango: ${fDesde.value||'—'} a ${fHasta.value||'—'} · Chofer: ${fChofer.value||'Todos'} · Búsqueda: ${fQ.value||'—'}</div>
      </div>
      <div class="badge">Detalle de viajes</div>
    </div>

    ${resumenHTML}

    <table class="t" style="margin-top:6mm">
      ${colgroup}
      <thead>
        <tr>
          <th>#</th>
          <th>Fecha</th>
          <th>CTG</th>
          <th>Origen y destino</th>
          <th class="r">Tarifa</th>
          <th class="r">Kg cargados</th>
          <th class="r">Kg descargados</th>
          <th class="r">Adelanto</th>
          <th class="r">Peaje</th>
          <th class="r">Entrada</th>
          <th>Observaciones</th>
        </tr>
      </thead>
      <tbody>${rowsDet || '<tr><td colspan="11" class="c">Sin viajes para los filtros seleccionados.</td></tr>'}</tbody>
      ${rowsDet ? totDet : ''}
    </table>

    <div class="muted" style="margin-top:4mm">
      Liquidación = Comisión – Adelantos + Peajes + Entradas. Comisión por viaje según % del chofer (18% por defecto).
    </div>
  </div>
</div>
</body></html>`;

  const w = window.open('', '_blank', 'width=1100,height=800');
  w.document.write(html); w.document.close(); w.focus();
});
</script>

</body>
</html>
