<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agregar Viaje</title>
  <style>
    :root{
      --amarillo:#FFD700;
      --negro:#000;
      --naranja:#ffa500;
      --verde:#0a8f2f;
      --rojo:#e53935;
      --blanco:#fff;
      --gris:#222;
    }

    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background: var(--amarillo);
      color: var(--blanco);
    }

    .container{
      background: var(--negro);
      max-width: 520px;
      margin: 40px auto;
      padding: 28px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
    }

    h2{
      margin: 0 0 18px;
      text-align:center;
      text-transform:uppercase;
      text-decoration: underline;
      letter-spacing:.4px;
    }

    label{
      display:block;
      font-size:12px;
      font-weight:700;
      margin: 10px 0 6px;
      text-transform:uppercase;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea{
      width:100%;
      box-sizing: border-box;
      padding:8px 10px;
      border:1px solid #000;
      border-radius:4px;
      background:#fff;
      color:#000;
      font-size:14px;
    }

    /* Misma altura para controles de una sola línea */
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select{
      height: 36px;
      line-height: 36px;
    }

    textarea{
      min-height:80px;
      resize: vertical;
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .small-note{
      font-size:12px;
      opacity:.9;
    }

    .btns{
      display:flex;
      gap:10px;
      margin-top:18px;
    }

    .btn{
      flex:1;
      padding:12px;
      border:1px solid #000;
      border-radius:6px;
      font-weight:700;
      text-transform:uppercase;
      cursor:pointer;
    }
    .btn-naranja{ background: var(--naranja); color:#000; }
    .btn-verde{ background: var(--verde); color:#fff; }

    /* caja de mantenimiento */
    .mant-box{
      border:1px dashed #444;
      background:#0f0f0f;
      border-radius:8px;
      padding:12px;
      margin-top:10px;
    }
    .mant-title{
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    /* Fila Tipo / Descripción perfectamente alineada */
    .mant-fields{
      display:flex;
      gap:10px;
      align-items:flex-end;   /* <- clave para que queden al ras */
    }
    .mant-fields > div{ flex:1; }

    /* Modal de éxito a pantalla completa */
    .overlay{
      position:fixed;
      inset:0;
      display:none;
      background: rgba(0,0,0,.7);
      align-items:center;
      justify-content:center;
      z-index: 9999;
    }
    .ok-card{
      background:#fff;
      color:#111;
      border-radius:12px;
      padding:24px 20px;
      width:min(480px, 92vw);
      text-align:center;
      box-shadow:0 10px 30px rgba(0,0,0,.5);
    }
    .ok-card h3{
      margin:0 0 8px;
      text-transform:uppercase;
    }
    .ok-card p{ margin:0; color:#444; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Agregar viaje</h2>

    <form id="formViaje" autocomplete="off">
      <label for="fecha">Fecha</label>
      <input type="date" id="fecha" required>

      <div class="row2">
        <div>
          <label for="cuitOrigen">CUIT origen</label>
          <input type="text" id="cuitOrigen" placeholder="CUIT / Origen" required>
        </div>
        <div>
          <label for="destino">Destino</label>
          <input type="text" id="destino" required>
        </div>
      </div>

      <div class="row2">
        <div>
          <label for="patente">Patente</label>
          <input type="text" id="patente" required>
        </div>
        <div>
          <label for="tipoCereal">Tipo de cereal</label>
          <input type="text" id="tipoCereal" required>
        </div>
      </div>

      <div class="row2">
        <div>
          <label for="kgLlevados">Kg llevados</label>
          <input type="number" id="kgLlevados" min="0" step="1" required>
        </div>
        <div>
          <label for="kgDescargados">Kg descargados</label>
          <input type="number" id="kgDescargados" min="0" step="1" required>
        </div>
      </div>

      <label>¿Cargó combustible?</label>
      <div class="row2">
        <select id="cargoCombustible">
          <option value="no">No</option>
          <option value="si">Sí</option>
        </select>
        <input type="text" id="comentarioComb" placeholder="(opcional) estación / comentario" disabled>
      </div>

      <label>¿Adelanto?</label>
      <div class="row2">
        <select id="tieneAdelanto">
          <option value="no">No</option>
          <option value="si">Sí</option>
        </select>
        <input type="number" id="montoAdelanto" placeholder="$ monto" min="0" step="0.01" disabled>
      </div>

      <label>¿Gastos en peajes?</label>
      <div class="row2">
        <select id="tienePeaje">
          <option value="no">No</option>
          <option value="si">Sí</option>
        </select>
        <input type="number" id="montoPeaje" placeholder="$ monto" min="0" step="0.01" disabled>
      </div>

      <label>¿Entrada?</label>
      <div class="row2">
        <select id="tieneEntrada">
          <option value="no">No</option>
          <option value="si">Sí</option>
        </select>
        <input type="number" id="montoEntrada" placeholder="$ monto" min="0" step="0.01" disabled>
      </div>

      <label for="observaciones">Observaciones</label>
      <textarea id="observaciones" placeholder="Notas generales..."></textarea>

      <!-- Mantenimiento solicitado desde el viaje -->
      <div class="mant-box">
        <div class="mant-title">
          <label style="margin:0;cursor:pointer;">
            <input type="checkbox" id="mantRequiere" style="transform:translateY(2px); margin-right:6px;">
            ¿Requiere mantenimiento?
          </label>
        </div>

        <div class="mant-fields">
          <div>
            <label for="mantTipo">Tipo</label>
            <select id="mantTipo" disabled>
              <option value="">Seleccionar…</option>
              <option>Servicio</option>
              <option>Cambio de aceite</option>
              <option>Filtros</option>
              <option>Cubiertas</option>
              <option>Frenos</option>
              <option>Reparación</option>
              <option>Otro</option>
            </select>
          </div>
          <div>
            <label for="mantDesc">Descripción</label>
            <input type="text" id="mantDesc" placeholder="Breve descripción del problema" disabled>
          </div>
        </div>

        <div class="small-note" style="margin-top:6px;opacity:.8;">
          * Al guardar el viaje, si marcás esta opción, se crea un pendiente en Mantenimiento.
        </div>
      </div>

      <div class="btns">
        <button type="button" class="btn btn-naranja" onclick="location.href='index.html'">Volver</button>
        <button type="submit" class="btn btn-verde">Guardar viaje</button>
      </div>
    </form>
  </div>

  <!-- Modal de éxito -->
  <div class="overlay" id="okOverlay">
    <div class="ok-card">
      <h3>¡Viaje guardado!</h3>
      <p>Redirigiendo…</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Tu config
    const firebaseConfig = {
      apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
      authDomain: "transporte-mario-guizzo.firebaseapp.com",
      projectId: "transporte-mario-guizzo",
      storageBucket: "transporte-mario-guizzo.appspot.com",
      messagingSenderId: "465536166890",
      appId: "1:465536166890:web:f658690629b09eca8fa093"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // helpers de habilitar/deshabilitar
    const byId = (x)=>document.getElementById(x);
    const toggleMoney = (selId, inputId) => {
      const sel = byId(selId);
      const inp = byId(inputId);
      const update = () => {
        const si = sel.value === 'si';
        inp.disabled = !si;
        if (!si){ inp.value = ''; }
      };
      sel.addEventListener('change', update);
      update();
    };

    // Combustible: comentario sólo si "Sí"
    (() => {
      const sel = byId('cargoCombustible');
      const txt = byId('comentarioComb');
      const run = () => {
        const si = sel.value === 'si';
        txt.disabled = !si;
        if (!si){ txt.value = ''; }
      };
      sel.addEventListener('change', run);
      run();
    })();

    // Montos condicionales
    toggleMoney('tieneAdelanto','montoAdelanto');
    toggleMoney('tienePeaje','montoPeaje');
    toggleMoney('tieneEntrada','montoEntrada');

    // Mantenimiento condicional
    (() => {
      const chk = byId('mantRequiere');
      const tipo= byId('mantTipo');
      const des = byId('mantDesc');
      const run = ()=>{
        const on = chk.checked;
        tipo.disabled = !on;
        des.disabled  = !on;
        if (!on){ tipo.value=''; des.value=''; }
      };
      chk.addEventListener('change', run);
      run();
    })();

    // Guardar
    byId('formViaje').addEventListener('submit', async (e)=>{
      e.preventDefault();

      // Campos obligatorios básicos
      const fecha           = byId('fecha').value;
      const cuitOrigen      = byId('cuitOrigen').value.trim();
      const destino         = byId('destino').value.trim();
      const patente         = byId('patente').value.trim();
      const tipoCereal      = byId('tipoCereal').value.trim();
      const kgLlevados      = Number(byId('kgLlevados').value || 0);
      const kgDescargados   = Number(byId('kgDescargados').value || 0);

      if (!fecha || !cuitOrigen || !destino || !patente || !tipoCereal){
        alert('Completá fecha, CUIT origen, destino, patente y tipo de cereal.');
        return;
      }

      // Opcionales / condicionales
      const cargoCombustible   = byId('cargoCombustible').value === 'si';
      const comentarioComb     = byId('comentarioComb').value.trim();

      const adelanto           = (byId('tieneAdelanto').value === 'si') ? Number(byId('montoAdelanto').value || 0) : 0;
      const peaje              = (byId('tienePeaje').value   === 'si') ? Number(byId('montoPeaje').value   || 0) : 0;
      const entrada            = (byId('tieneEntrada').value === 'si') ? Number(byId('montoEntrada').value || 0) : 0;

      const observaciones      = byId('observaciones').value.trim();

      const mantRequiere       = byId('mantRequiere').checked;
      const mantTipo           = byId('mantTipo').value;
      const mantDesc           = byId('mantDesc').value.trim();

      const data = {
        fecha,
        cuitOrigen,
        destino,
        patente,
        tipoCereal,
        kgCargados:     kgLlevados,      // nombre usado en ver-viajes-admin
        kgDescargados,
        cargoCombustible,
        comentarioComb: cargoCombustible ? comentarioComb : "",
        adelanto,                         // num (0 si no)
        peaje,                            // num (0 si no)
        entrada,                          // num (0 si no)
        observaciones,
        mantRequiere,
        mantTipo: mantRequiere ? mantTipo : "",
        mantDesc: mantRequiere ? mantDesc : "",
        timestamp: serverTimestamp()
      };

      try{
        await addDoc(collection(db,'viajes'), data);

        // Si pidió mantenimiento, dejamos un pendiente inicial en 'mantenimientos'
        if (mantRequiere && mantTipo){
          await addDoc(collection(db,'mantenimientos'), {
            fechaSolicitud: fecha,
            patente,
            tipo: mantTipo,
            descripcion: mantDesc || "",
            origenViaje: cuitOrigen + " → " + destino,
            estado: "pendiente",
            timestamp: serverTimestamp()
          });
        }

        const ov = byId('okOverlay');
        ov.style.display = 'flex';
        setTimeout(()=>{ location.href = 'index.html'; }, 1800);

      }catch(err){
        alert('Error al guardar: ' + err.message);
      }
    });
  </script>
</body>
</html>
