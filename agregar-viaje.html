<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agregar Viaje</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://kit.fontawesome.com/a2e0e6ad65.js" crossorigin="anonymous"></script>
  <style>
    body{margin:0;font-family:'Roboto',Arial,sans-serif;background:#FFD700;color:#fff}
    .container{background:#000;max-width:520px;margin:40px auto;padding:28px;border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,.5)}
    h2{text-align:center;font-size:22px;text-transform:uppercase;text-decoration:underline;font-weight:bold;color:#fff;margin:0 0 20px}
    form{display:flex;flex-direction:column;gap:12px}
    label{font-weight:bold;text-transform:uppercase}
    input,textarea,select{padding:8px;border:1px solid #000;background:#fff;color:#000;border-radius:4px;width:100%;box-sizing:border-box}
    textarea{min-height:80px;resize:vertical}
    .fila{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grupo-monto{display:none}
    .botones{display:flex;justify-content:space-between;gap:10px;margin-top:12px}
    .btn-volver,.btn-guardar{flex:1;padding:10px;border:1px solid #000;border-radius:4px;cursor:pointer;font-weight:bold;text-transform:uppercase}
    .btn-volver{background:orange;color:#000}
    .btn-guardar{background:green;color:#fff}
    .mant-box{border:1px dashed #444;border-radius:8px;padding:12px;margin-top:4px}
    .mant-extra{display:none;margin-top:8px}
    .mant-extra.show{display:block}
    #modalExito{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;color:green;padding:18px 22px;border:2px solid green;border-radius:10px;z-index:1000;text-align:center;font-weight:bold}
    .ayuda{font-size:12px;color:#bbb;margin-top:-4px;text-transform:none}

    /* DEBUG (puedes quitarlo cuando funcione) */
    #dbg{
      position:fixed;left:8px;right:8px;bottom:8px;background:#000;border:1px solid #333;border-radius:8px;
      padding:8px 10px;color:#9ee;font:12px/1.3 monospace;opacity:.9
    }
    #dbg b{color:#fff}
    #dbg .bad{color:#ff9e9e}
    #dbg .ok{color:#9effa3}
  </style>
</head>
<body>
  <div class="container">
    <h2>Agregar viaje</h2>

    <form id="formViaje">
      <label for="fecha">Fecha</label>
      <input type="date" id="fecha" required>

      <label for="cuitOrigen">CUIT Origen</label>
      <input type="text" id="cuitOrigen" placeholder="Ej: 20-12345678-9" required>

      <label for="destino">Destino</label>
      <input type="text" id="destino" required>

      <label for="patente">Patente</label>
      <input type="text" id="patente" placeholder="ABC123 / AB123CD" required>

      <label for="tipoCereal">Tipo de cereal</label>
      <input type="text" id="tipoCereal" placeholder="Soja, Ma√≠z, Trigo..." required>

      <div class="fila">
        <div>
          <label for="kgLlevados">Kg llevados</label>
          <input type="number" id="kgLlevados" step="0.01" min="0" required>
        </div>
        <div>
          <label for="kgDescargados">Kg descargados</label>
          <input type="number" id="kgDescargados" step="0.01" min="0" required>
        </div>
      </div>

      <label for="cargoCombustible">¬øCarg√≥ combustible?</label>
      <select id="cargoCombustible">
        <option value="no" selected>No</option>
        <option value="si">S√≠</option>
      </select>

      <!-- Adelanto -->
      <label for="adelantoAplica">Adelanto</label>
      <select id="adelantoAplica">
        <option value="no" selected>No</option>
        <option value="si">S√≠</option>
      </select>
      <div id="adelantoMontoGrupo" class="grupo-monto">
        <label for="adelantoMonto">Monto adelanto ($)</label>
        <input type="number" id="adelantoMonto" step="0.01" min="0">
      </div>

      <!-- Peajes -->
      <label for="peajeAplica">Gastos en peajes</label>
      <select id="peajeAplica">
        <option value="no" selected>No</option>
        <option value="si">S√≠</option>
      </select>
      <div id="peajeMontoGrupo" class="grupo-monto">
        <label for="peajeMonto">Monto peajes ($)</label>
        <input type="number" id="peajeMonto" step="0.01" min="0">
      </div>

      <!-- Entrada -->
      <label for="entradaAplica">Entrada</label>
      <select id="entradaAplica">
        <option value="no" selected>No</option>
        <option value="si">S√≠</option>
      </select>
      <div id="entradaMontoGrupo" class="grupo-monto">
        <label for="entradaMonto">Monto entrada ($)</label>
        <input type="number" id="entradaMonto" step="0.01" min="0">
      </div>

      <label for="observaciones">Observaciones</label>
      <textarea id="observaciones" placeholder="Notas adicionales..."></textarea>

      <!-- Secci√≥n mantenimiento -->
      <div class="mant-box">
        <label><input type="checkbox" id="reqMant"> ¬øRequiere mantenimiento?</label>
        <div id="mantExtra" class="mant-extra">
          <div class="fila">
            <div>
              <label for="mantTipo">Tipo</label>
              <select id="mantTipo">
                <option value="">Seleccionar‚Ä¶</option>
                <option>Servicio</option>
                <option>Cambio de aceite</option>
                <option>Filtros</option>
                <option>Cubiertas</option>
                <option>Frenos</option>
                <option>Reparaci√≥n</option>
                <option>Otro</option>
              </select>
            </div>
            <div>
              <label for="mantDesc">Descripci√≥n</label>
              <input type="text" id="mantDesc" placeholder="Breve descripci√≥n del problema">
            </div>
          </div>
        </div>
      </div>
      <!-- FIN mantenimiento -->

      <div class="botones">
        <button type="button" class="btn-volver" onclick="window.location.href='index.html'">Volver</button>
        <button type="submit" class="btn-guardar">Guardar viaje</button>
      </div>
      <div class="ayuda">* Los montos s√≥lo son obligatorios si eleg√≠s ‚ÄúS√≠‚Äù.</div>
    </form>
  </div>

  <div id="modalExito">¬°Guardado correctamente!</div>

  <!-- DEBUG PANEL -->
  <div id="dbg">
    <div><b>UID:</b> <span id="d_uid" class="bad">‚Äî</span> ¬∑ <b>email:</b> <span id="d_mail">‚Äî</span></div>
    <div><b>projectId:</b> <span id="d_pid">‚Äî</span> ¬∑ <b>write test:</b> <span id="d_probe" class="bad">pendiente‚Ä¶</span></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    // IMPORT EXTRA solo para el test de permisos (no toca tu l√≥gica)
    import { setDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // üîé logs Firestore
    setLogLevel('debug');

    const firebaseConfig = {
      apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
      authDomain: "transporte-mario-guizzo.firebaseapp.com",
      projectId: "transporte-mario-guizzo",
      storageBucket: "transporte-mario-guizzo.appspot.com",
      messagingSenderId: "465536166890",
      appId: "1:465536166890:web:f658690629b09eca8fa093"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

// ---- DEBUG de proyecto (para confirmar que est√°s en el proyecto correcto)
console.log('[DEBUG] projectId', app.options.projectId);
console.log('[DEBUG] authDomain', app.options.authDomain);

// ---- Guard de sesi√≥n: no env√≠es nada a Firestore si Auth todav√≠a no carg√≥
let currentUser = null;
let authReady = false;

onAuthStateChanged(auth, (u) => {
  console.log('[DEBUG] onAuthStateChanged =>', u?.uid, u?.email);
  if (!u) {
    // si no hay sesi√≥n, redirigimos al login
    window.location.href = "login.html";
    return;
  }
  currentUser = u;
  authReady = true;

  // Fecha por defecto (si quer√©s)
  const f = document.getElementById('fecha');
  if (f && !f.value) f.value = new Date().toISOString().slice(0,10);
});

// Bloqueo ‚Äúsuave‚Äù del submit si Auth no est√° listo a√∫n
document.getElementById("formViaje").addEventListener("submit", (ev) => {
  if (!authReady || !currentUser) {
    ev.preventDefault();
    alert("Esper√° un segundo que se cargue tu sesi√≥n‚Ä¶");
  }
}, { capture:false });

// Llamalo desde la consola del navegador con: await window._permTest()
window._permTest = async () => {
  try {
    const id = 'TEST_' + Math.random().toString(36).slice(2,8);
    await setDoc(doc(db, 'viajes', id), {
      _probe: true,
      at: serverTimestamp(),
      page: 'agregar-viaje'
    });
    alert('OK: se escribi√≥ viajes/' + id);
  } catch (e) {
    console.error('[DEBUG] _permTest', e.code, e.message, e);
    alert('DENEGADO: ' + e.code + ' ‚Äî ' + e.message);
  }
};
    
    // DEBUG view
    document.getElementById('d_pid').textContent = firebaseConfig.projectId;
    const dUID   = document.getElementById('d_uid');
    const dMail  = document.getElementById('d_mail');
    const dProbe = document.getElementById('d_probe');

    // ---- Guard de sesi√≥n y TEST de permisos
    let currentUser = null;
    onAuthStateChanged(auth, async (u) => {
      console.log('[AUTH] user =', u?.uid || null);
      if (!u) {
        dUID.textContent = 'sin sesi√≥n';
        dUID.className = 'bad';
        window.location.href = "login.html";
        return;
      }
      currentUser = u;
      dUID.textContent = u.uid;
      dUID.className = 'ok';
      dMail.textContent = u.email || '(sin email)';

      // Fecha por defecto
      if (!document.getElementById('fecha').value) {
        document.getElementById('fecha').value = new Date().toISOString().slice(0,10);
      }

      // üî• TEST: escribir un doc de prueba
      try {
        console.log('[PROBE] intentando escribir en _perms_probe‚Ä¶');
        const r = await addDoc(collection(db, "_perms_probe"), {
          at: serverTimestamp(),
          uid: u.uid,
          page: "agregar-viaje"
        });
        console.log('[PROBE] OK id=', r.id);
        dProbe.textContent = 'OK';
        dProbe.className = 'ok';
      } catch (e) {
        console.error('[PROBE] FAIL', e.code, e.message);
        dProbe.textContent = `FAIL ${e.code||''}`;
        dProbe.className = 'bad';
        alert("‚ö†Ô∏è No tengo permisos para escribir (test). C√≥digo: " + (e.code||e.message));
      }
    });

    // ----- UI helpers: mostrar/ocultar montos seg√∫n "S√≠/No"
    const mapToggles = [
      { sel: 'adelantoAplica', grupo: 'adelantoMontoGrupo', input: 'adelantoMonto' },
      { sel: 'peajeAplica',    grupo: 'peajeMontoGrupo',    input: 'peajeMonto'    },
      { sel: 'entradaAplica',  grupo: 'entradaMontoGrupo',  input: 'entradaMonto'  }
    ];
    function toggleMonto(selId, grupoId, inputId) {
      const sel = document.getElementById(selId);
      const box = document.getElementById(grupoId);
      const inp = document.getElementById(inputId);
      const on  = (sel.value === 'si');
      box.style.display = on ? 'block' : 'none';
      inp.required = on;
      if (!on) inp.value = '';
    }
    mapToggles.forEach(t => {
      document.getElementById(t.sel).addEventListener('change', () => toggleMonto(t.sel, t.grupo, t.input));
      toggleMonto(t.sel, t.grupo, t.input);
    });

    // Mostrar/ocultar extras de mantenimiento
    const reqMant   = document.getElementById('reqMant');
    const mantExtra = document.getElementById('mantExtra');
    reqMant.addEventListener('change', ()=> mantExtra.classList.toggle('show', reqMant.checked));

    // Patente siempre en may√∫sculas
    const patenteInput = document.getElementById('patente');
    patenteInput.addEventListener('input', e => e.target.value = e.target.value.toUpperCase());

    // ----- Guardar
    const form = document.getElementById("formViaje");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!currentUser) {
        alert("No hay sesi√≥n. Volv√© a iniciar sesi√≥n.");
        window.location.href = "login.html";
        return;
      }

      // Validaci√≥n b√°sica
      const obligatorios = ["fecha","cuitOrigen","destino","patente","tipoCereal","kgLlevados","kgDescargados"];
      for (const id of obligatorios) {
        if (!document.getElementById(id).value) {
          alert("Por favor, complete todos los campos obligatorios.");
          return;
        }
      }
      // Montos si aplica
      for (const t of mapToggles) {
        const aplica = document.getElementById(t.sel).value === 'si';
        const val    = document.getElementById(t.input).value;
        if (aplica && (val === "" || isNaN(parseFloat(val)))) {
          alert("Complete correctamente el monto en: " + t.input.replace('Monto',''));
          return;
        }
      }

      const cargoCombustible = document.getElementById("cargoCombustible").value === "si";

      // Datos mantenimiento (si se marc√≥)
      const mantRequiere     = reqMant.checked;
      const mantTipoSugerido = (document.getElementById("mantTipo").value || "").trim();
      const mantDescripcion  = (document.getElementById("mantDesc").value || "").trim();

      const viaje = {
        fecha: document.getElementById("fecha").value,
        cuitOrigen: document.getElementById("cuitOrigen").value.trim(),
        destino: document.getElementById("destino").value.trim(),
        patente: document.getElementById("patente").value.trim(),
        tipoCereal: document.getElementById("tipoCereal").value.trim(),
        kgLlevados: parseFloat(document.getElementById("kgLlevados").value) || 0,
        kgDescargados: parseFloat(document.getElementById("kgDescargados").value) || 0,
        cargoCombustible,

        adelantoAplica: document.getElementById("adelantoAplica").value === "si",
        adelantoMonto:  parseFloat(document.getElementById("adelantoMonto").value || 0),

        peajeAplica:    document.getElementById("peajeAplica").value === "si",
        peajeMonto:     parseFloat(document.getElementById("peajeMonto").value || 0),

        entradaAplica:  document.getElementById("entradaAplica").value === "si",
        entradaMonto:   parseFloat(document.getElementById("entradaMonto").value || 0),

        observaciones: document.getElementById("observaciones").value.trim(),

        // mantenimiento
        reqMantenimiento: mantRequiere,
        mantTipoSugerido,
        mantDescripcion,

        timestamp: serverTimestamp()
      };

      try {
        console.log('[WRITE] uid=', currentUser.uid, 'colecci√≥n=viajes');
        const ref = await addDoc(collection(db, "viajes"), viaje);

        if (mantRequiere) {
          const mant = {
            creadoDesdeViaje: true,
            viajeId: ref.id,
            fecha: viaje.fecha,
            patente: viaje.patente,
            tipo: mantTipoSugerido || "Otro",
            proveedor: "",
            km: 0, repuestos: [], manoDeObra: 0, otros: 0, total: 0,
            pagado: false, estado: "pendiente", proximoFecha: "",
            observaciones: mantDescripcion || viaje.observaciones || "",
            timestamp: serverTimestamp()
          };
          await addDoc(collection(db, "mantenimientos"), mant);
        }

        const modal = document.getElementById("modalExito");
        modal.style.display = "block";
        setTimeout(() => {
          modal.style.display = "none";
          if (cargoCombustible) {
            const q = new URLSearchParams({ patente: viaje.patente, fecha: viaje.fecha });
            window.location.href = "agregar-combustible.html?" + q.toString();
          } else {
            window.location.href = "index.html";
          }
        }, 3000);
      } catch (e) {
        console.error('[WRITE] ERROR', e.code, e.message);
        alert("Error al guardar: " + (e.code || e.message));
      }
    });
  </script>
</body>
</html>
