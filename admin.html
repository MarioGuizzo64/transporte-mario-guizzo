<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Transporte Mario Güizzo — Admin</title>
  <style>
    :root { --amarillo:#FFD700; --negro:#0d0d0d; --naranja:#ffa500; --rojo:#e53935; --blanco:#ffffff; }
    body{
      margin:0;background:var(--negro);color:var(--blanco);
      font-family:Arial,Helvetica,sans-serif;min-height:100vh;
      display:flex;flex-direction:column;align-items:center;
    }
    header{text-align:center;padding:24px 12px 0;}
    header h1{margin:0 0 16px;text-transform:uppercase;letter-spacing:.5px;}
    .logo{width:260px;max-width:80vw;display:block;margin:0 auto 12px;}
    .panel{
      width:100%;max-width:520px;margin:24px auto 48px;background:#111;border-radius:12px;
      padding:24px 18px;box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .panel h2{ text-align:center;margin:0 0 16px;text-transform:uppercase;text-decoration:underline;font-size:18px; }
    .btn{
      width:100%;display:block;border:1px solid #000;border-radius:8px;
      padding:12px 14px;margin:10px 0;font-weight:700;text-transform:uppercase;
      cursor:pointer;transition:transform .05s ease;
    }
    .btn:active{ transform:translateY(1px); }
    .btn-naranja{ background:var(--amarillo);color:#000; }
    .btn-rojo{ background:var(--rojo);color:#fff;margin-top:8px; }
    .footer{ color:#888;font-size:12px;margin-bottom:20px; }

    #loading{ margin-top:40px;color:#bbb;font-size:14px; }
    #app{ display:none; }       /* contenedor del panel admin */
    #denied{ display:none; text-align:center; max-width:520px; margin:50px 16px; }
    #denied .card{ background:#111; border-radius:12px; padding:20px; }
    .row{ display:flex; gap:10px; margin-top:12px; }
    .row .btn{ flex:1; }
    .debug{ color:#bbb; font-size:12px; margin-top:10px; word-break:break-word; }
  </style>
</head>
<body>
  <!-- Cargando -->
  <div id="loading">Cargando permisos…</div>

  <!-- Denegado -->
  <div id="denied">
    <div class="card">
      <h2 style="text-transform:uppercase;text-decoration:underline;margin-top:0">Acceso restringido</h2>
      <p>No tenés permisos de administrador para este panel.</p>
      <div class="row">
        <button class="btn btn-naranja" id="goChofer">Ir al panel de chofer</button>
        <button class="btn btn-rojo" id="doLogout">Cerrar sesión</button>
      </div>
      <div class="debug" id="why"></div>
    </div>
  </div>

  <!-- Panel admin -->
  <div id="app">
    <header>
      <h1>Transporte Mario Güizzo</h1>
      <img src="logo.png" alt="Logo Transporte Mario Güizzo" class="logo" />
    </header>

    <div class="panel">
      <h2>¿Qué desea hacer?</h2>
      <button class="btn btn-naranja" id="btnUsuarios">Usuarios</button>
      <button class="btn btn-naranja" id="btnViajes">Viajes</button>
      <button class="btn btn-naranja" id="btnCombustible">Combustible</button>
      <button class="btn btn-naranja" id="btnMantenimiento">Mantenimiento</button>
      <button class="btn btn-naranja" id="btnFinanzas">Finanzas</button>
      <button class="btn btn-naranja" id="btnDocumentos">Documentos de choferes y camiones</button>
      <button class="btn btn-rojo" id="btnLogout">Cerrar sesión</button>
    </div>

    <div class="footer">Panel de administración</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
      authDomain: "transporte-mario-guizzo.firebaseapp.com",
      projectId: "transporte-mario-guizzo",
      storageBucket: "transporte-mario-guizzo.appspot.com",
      messagingSenderId: "465536166890",
      appId: "1:465536166890:web:f658690629b09eca8fa093",
      measurementId: "G-187MCQ2XPW"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loading = document.getElementById('loading');
    const denied  = document.getElementById('denied');
    const appDiv  = document.getElementById('app');
    const why     = document.getElementById('why');

    // Cambiá esta lista si tus correos admin son otros:
    const ADMIN_WHITELIST = ["admin@guizzo.com", "admin2@guizzo.com"].map(e => e.toLowerCase());

    function showLoading(v){ loading.style.display = v ? 'block' : 'none'; }
    function showApp(){ appDiv.style.display = 'block'; denied.style.display = 'none'; showLoading(false); }
    function showDenied(msg){
      why.textContent = msg || '';
      denied.style.display = 'block';
      appDiv.style.display = 'none';
      showLoading(false);
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // no hay sesión
        window.location.replace("login.html");
        return;
      }
      try {
        const email = (user.email || '').toLowerCase();
        const uid   = user.uid;

        // 1) Intento leer doc por UID (usuarios/<uid>)
        const ref = doc(db, "usuarios", uid);
        const snap = await getDoc(ref);

        let rol = '';
        if (snap.exists()) {
          const d = snap.data() || {};
          rol = (d.rol || '').toLowerCase();
        }

        // 2) Si no hay rol admin pero el correo está en la whitelist,
        //    creo/actualizo el doc con rol admin (autocuración).
        if (rol !== 'admin' && ADMIN_WHITELIST.includes(email)) {
          await setDoc(ref, {
            uid,
            email,
            rol: 'admin',
            updatedAt: new Date().toISOString()
          }, { merge: true });
          rol = 'admin';
        }

        if (rol === 'admin') {
          showApp();
        } else {
          showDenied(`Usuario autenticado: ${email} (uid: ${uid}). Rol actual: "${rol || 'N/D'}".`);
        }

      } catch (err) {
        console.error('Error verificando permisos:', err);
        showDenied('Error verificando permisos: ' + err.message);
      }
    });

    // Navegación
    document.getElementById("btnUsuarios").onclick      = () => location.href = "usuarios.html";
    document.getElementById("btnViajes").onclick        = () => location.href = "ver-viajes-admin.html";
    document.getElementById("btnCombustible").onclick   = () => location.href = "ver-combustible-admin.html";
    document.getElementById("btnMantenimiento").onclick = () => location.href = "mantenimiento.html";
    document.getElementById("btnFinanzas").onclick      = () => location.href = "finanzas.html";
    document.getElementById("btnDocumentos").onclick    = () => location.href = "documentos.html";

    // Acciones denegado
    document.getElementById('goChofer').onclick = () => location.href = "index.html";
    document.getElementById('doLogout').onclick = async () => { await signOut(auth); location.replace("login.html"); };

    // Cerrar sesión dentro del panel
    document.getElementById("btnLogout").onclick = async () => {
      try { await signOut(auth); location.replace("login.html"); }
      catch(e){ alert("No se pudo cerrar sesión: " + e.message); }
    };
  </script>
</body>
</html>
