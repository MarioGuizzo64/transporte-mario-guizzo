<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ver viajes</title>
  <style>
    :root{ --yellow:#FFD700; --panel:#000; --card:#181818; --mut:#a9b0b6; --green:#2e7d32; --red:#c62828; --orange:#ffa000; }
    body{margin:0;background:var(--yellow);font-family:Arial,Helvetica,sans-serif;color:#fff}
    .wrap{max-width:900px;margin:40px auto;background:var(--panel);border-radius:12px;padding:20px;box-shadow:0 12px 28px rgba(0,0,0,.35)}
    h1{margin:0 0 12px;text-align:center;text-transform:uppercase;text-decoration:underline}
    .bar{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center}
    .bar input,.bar select{padding:10px;border:1px solid #000;border-radius:8px;background:#fff;color:#000;font-weight:600}
    .btn{padding:10px 12px;border:1px solid #000;border-radius:8px;font-weight:bold;cursor:pointer;text-transform:uppercase}
    .btn-volver{background:var(--orange);color:#000}

    /* Un solo contador (viajes) */
    .stats{display:grid;grid-template-columns:1fr;gap:10px;margin:12px 0 6px}
    .card{background:#101010;border:1px solid #222;border-radius:10px;padding:10px;text-align:center}
    .card .label{font-size:12px;color:#b7f1c4;text-transform:uppercase;letter-spacing:.4px}
    .card .value{font-weight:bold;font-size:18px}

    .lista{display:grid;gap:10px}
    .item{background:var(--card);border:1px solid #222;border-radius:12px;padding:12px}
    .row{display:flex;gap:8px;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-block;background:#222;border:1px solid #333;border-radius:999px;padding:2px 8px;margin-right:6px;font-size:12px}
    .acciones{display:flex;gap:8px;margin-top:8px}
    .btn-edit{background:var(--green);color:#fff}
    .btn-del{background:var(--red);color:#fff}
    .empty{padding:16px;background:#121212;border:1px dashed #333;border-radius:8px;text-align:center;color:#ddd}

    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center;z-index:10}
    .modal .box{background:#000;border-radius:12px;padding:16px;max-width:700px;width:95%}
    .modal h2{margin:0 0 10px;text-transform:uppercase;text-decoration:underline}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid label{font-weight:bold;text-transform:uppercase}
    .grid input,.grid textarea{padding:8px;border:1px solid #000;border-radius:6px;background:#fff;color:#000}
    .grid textarea{grid-column:span 2;height:70px;resize:vertical}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    @media (max-width:760px){ .bar{grid-template-columns:1fr} .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Viajes cargados</h1>

    <div class="bar">
      <input id="q" placeholder="buscar: origen, destino, patente, CUIT, obs">
      <select id="orden">
        <option value="fecha_desc">Fecha ↓</option>
        <option value="fecha_asc">Fecha ↑</option>
        <option value="ts_desc">Creación ↓</option>
        <option value="ts_asc">Creación ↑</option>
      </select>
      <button class="btn btn-volver" onclick="location.href='index.html'">Volver</button>
    </div>

    <!-- Solo contador de viajes -->
    <div class="stats">
      <div class="card"><div class="label">Viajes</div><div class="value" id="kViajes">0</div></div>
    </div>

    <div id="lista" class="lista"></div>
    <div id="msg" class="empty" style="display:none">Cargando…</div>
  </div>

  <!-- MODAL EDITAR (agrego CTG) -->
  <div id="modal" class="modal">
    <div class="box">
      <h2>Editar / Eliminar viaje</h2>
      <div class="grid">
        <label>Fecha</label><input type="date" id="e_fecha"/>
        <label>Patente</label><input id="e_patente"/>

        <label>CTG</label><input id="e_ctg"/>
        <label>Titular carta de porte (CUIT)</label><input id="e_cuitTitular"/>

        <label>CUIT origen</label><input id="e_cuitOrigen"/>
        <label>Origen</label><input id="e_origen"/>

        <label>Destino</label><input id="e_destino"/>
        <label>Tipo de cereal</label><input id="e_tipoCereal"/>

        <label>Tns cargadas</label><input type="number" step="0.01" id="e_kgCarg"/>
        <label>Tns descargadas</label><input type="number" step="0.01" id="e_kgDesc"/>

        <label>Tarifa ($/tn)</label><input type="number" step="0.01" id="e_tarifa"/>
        <label>Adelanto ($)</label><input type="number" step="0.01" id="e_adelanto"/>

        <label>Peaje ($)</label><input type="number" step="0.01" id="e_peaje"/>
        <label>Entrada ($)</label><input type="number" step="0.01" id="e_entrada"/>

        <label>Observaciones</label><textarea id="e_obs"></textarea>
      </div>
      <div class="actions">
        <button class="btn btn-edit" id="btnGuardar">Guardar</button>
        <button class="btn btn-del" id="btnEliminar">Eliminar</button>
        <button class="btn btn-volver" id="btnCerrar">Cerrar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, where, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
      authDomain: "transporte-mario-guizzo.firebaseapp.com",
      projectId: "transporte-mario-guizzo",
      storageBucket: "transporte-mario-guizzo.appspot.com",
      messagingSenderId: "465536166890",
      appId: "1:465536166890:web:f658690629b09eca8fa093"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = id => document.getElementById(id);
    const lista = $('lista'), msg = $('msg'), kViajes = $('kViajes');

    const fechaAR = x => {
      if (!x) return '-';
      if (typeof x === 'string'){
        if (x.includes('/')) return x;
        if (x.includes('-')){ const [y,m,d]=x.split('-'); return `${d}/${m}/${y}`; }
      }
      try{ const d=(x?.seconds)?new Date(x.seconds*1000):new Date(x); return d.toLocaleDateString('es-AR',{timeZone:'UTC'}); }
      catch{ return '-'; }
    };
    const toISO = x => {
      const d = (typeof x==='string')? new Date(x) : (x?.seconds? new Date(x.seconds*1000): new Date(x));
      return isNaN(d)? '' : d.toISOString().slice(0,10);
    };
    const up=s=> (s??'').toString().toUpperCase();
    const safe=s=> (s??'').toString();

    // Normalizadores
    const N = {
      id: v => v.__id, fecha:v=>v.fecha||v.fechaViaje||v.createdAt||null,
      patente:v=>(v.patente||'').toUpperCase(),
      ctg:v=>v.ctg||v.nroCTG||v.ctgNumero||'',
      cuitTitular:v=>v.cuitTitularCartaPorte||v.cuitTitular||'',
      cuitOrigen:v=>v.cuitOrigen||v.cuit||'',
      origen:v=>v.origenViaje||v.origen||'',
      destino:v=>v.destino||'',
      tipoCereal:v=>v.tipoCereal||v.tipoCarga||'',
      kgCarg:v=>Number(v.kgLlevados??v.peso??0),
      kgDesc:v=>Number(v.kgDescargados??0),
      tarifa:v=>Number(v.tarifaPorTonelada??v.tarifa??0),
      adelanto:v=>Number(v.adelanto??0), peaje:v=>Number(v.peaje??0), entrada:v=>Number(v.entrada??0),
      uid:v=>v.uidCreador||v.uid||v.creadoPor||''
    };

    let esAdmin=false, miUid=null, misPatentes=[], datos=[], unsub=null;

    function ordenarMem(clave, arr){
      const a=[...arr], f=x=>(safe(x.fecha)||''), t=x=>(x.timestamp?.seconds||0);
      if (clave==='fecha_asc') a.sort((x,y)=>f(x).localeCompare(f(y)));
      if (clave==='fecha_desc') a.sort((x,y)=>f(y).localeCompare(f(x)));
      if (clave==='ts_asc') a.sort((x,y)=>t(x)-t(y));
      if (clave==='ts_desc') a.sort((x,y)=>t(y)-t(x));
      return a;
    }

    function render(){
      const q = up($('q').value.trim());
      const ord = $('orden').value;
      const base = ordenarMem(ord, datos);
      const fil = q ? base.filter(v=>{
        const blob = [N.origen(v),N.destino(v),N.patente(v),N.cuitOrigen(v),N.ctg(v)].join(' ').toUpperCase();
        return blob.includes(q);
      }) : base;

      kViajes.textContent = String(fil.length);
      lista.innerHTML='';
      if (!fil.length){ msg.style.display='block'; msg.textContent='Sin viajes para mostrar.'; return; }
      msg.style.display='none';

      for (const v of fil){
        const el = document.createElement('div');
        el.className='item';
        el.innerHTML = `
          <div class="row">
            <div><b>Fecha:</b> ${fechaAR(N.fecha(v))}<br><small style="color:#bbb">CTG: ${safe(N.ctg(v)) || '-'}</small></div>
            <div><b>Patente:</b> ${N.patente(v) || '-'}</div>
          </div>
          <div><b>Origen → Destino:</b> ${N.origen(v) || '-'} → ${N.destino(v) || '-'}</div>
          <div style="margin-top:4px">
            <span class="pill">Tns carg.: ${N.kgCarg(v).toLocaleString('es-AR')}</span>
            <span class="pill">Tns desc.: ${N.kgDesc(v).toLocaleString('es-AR')}</span>
            <span class="pill">Cereal: ${N.tipoCereal(v) || '-'}</span>
            ${N.cuitOrigen(v) ? `<span class="pill">CUIT origen: ${N.cuitOrigen(v)}</span>` : ''}
          </div>
          <div class="acciones">
            <button class="btn btn-edit" data-e="${v.__id}">Editar</button>
            <button class="btn btn-del" data-d="${v.__id}">Eliminar</button>
          </div>
        `;
        el.querySelector('[data-e]').onclick = ()=> abrirModal(v);
        el.querySelector('[data-d]').onclick = ()=> eliminar(v.__id);
        lista.appendChild(el);
      }
    }

    function escuchar(){
      if (unsub){ try{unsub();}catch{} unsub=null; }
      const ref = collection(db,'viajes');

      if (esAdmin){
        let qy;
        switch($('orden').value){
          case 'fecha_asc': qy=query(ref,orderBy('fecha','asc')); break;
          case 'ts_asc':    qy=query(ref,orderBy('timestamp','asc')); break;
          case 'ts_desc':   qy=query(ref,orderBy('timestamp','desc')); break;
          default:          qy=query(ref,orderBy('fecha','desc'));
        }
        unsub = onSnapshot(qy,s=>{ datos=s.docs.map(d=>({__id:d.id,...d.data()})); render(); }, err=>{msg.style.display='block'; msg.textContent='Error: '+(err.code||err.message);});
        return;
      }

      // Chofer: por uid + por patente(s)
      const qUid = query(ref, where('uidCreador','==',miUid));
      let qPat=null;
      if (misPatentes.length===1) qPat=query(ref, where('patente','==',misPatentes[0]));
      else if (misPatentes.length>1 && misPatentes.length<=10) qPat=query(ref, where('patente','in',misPatentes));

      let a=[],b=[];
      const merge=()=>{ const m=new Map(); [...a,...b].forEach(v=>m.set(v.__id,v)); datos=[...m.values()]; render(); };

      const u1 = onSnapshot(qUid, s=>{ a=s.docs.map(d=>({__id:d.id,...d.data()})); merge(); });
      const u2 = qPat ? onSnapshot(qPat, s=>{ b=s.docs.map(d=>({__id:d.id,...d.data()})); merge(); }) : null;
      unsub = ()=>{ try{u1();}catch{} if(u2) try{u2();}catch{} };
    }

    // Modal
    const modal = $('modal');
    $('btnCerrar').onclick = ()=> modal.style.display='none';
    let actualId=null;

    function abrirModal(v){
      actualId = v.__id;
      $('e_fecha').value      = toISO(N.fecha(v)) || '';
      $('e_patente').value    = N.patente(v);
      $('e_ctg').value        = N.ctg(v);
      $('e_cuitTitular').value= N.cuitTitular(v);
      $('e_cuitOrigen').value = N.cuitOrigen(v);
      $('e_origen').value     = N.origen(v);
      $('e_destino').value    = N.destino(v);
      $('e_tipoCereal').value = N.tipoCereal(v);
      $('e_kgCarg').value     = N.kgCarg(v) || '';
      $('e_kgDesc').value     = N.kgDesc(v) || '';
      $('e_tarifa').value     = N.tarifa(v) || '';
      $('e_adelanto').value   = N.adelanto(v) || '';
      $('e_peaje').value      = N.peaje(v) || '';
      $('e_entrada').value    = N.entrada(v) || '';
      $('e_obs').value        = v.observaciones || '';
      modal.style.display='flex';
    }

    $('btnGuardar').onclick = async ()=>{
      if (!actualId) return;
      const data = {
        fecha: $('e_fecha').value || null,
        patente: up($('e_patente').value.trim()),
        ctg: $('e_ctg').value.trim(),
        cuitTitularCartaPorte: $('e_cuitTitular').value.trim(),
        cuitOrigen: $('e_cuitOrigen').value.trim(),
        origenViaje: $('e_origen').value.trim(),
        origen: $('e_origen').value.trim(),
        destino: $('e_destino').value.trim(),
        tipoCereal: $('e_tipoCereal').value.trim(),
        tipoCarga: $('e_tipoCereal').value.trim(),
        kgLlevados: Number($('e_kgCarg').value || 0),
        peso: Number($('e_kgCarg').value || 0),
        kgDescargados: Number($('e_kgDesc').value || 0),
        tarifaPorTonelada: Number($('e_tarifa').value || 0),
        tarifa: Number($('e_tarifa').value || 0),
        adelanto: Number($('e_adelanto').value || 0),
        peaje: Number($('e_peaje').value || 0),
        entrada: Number($('e_entrada').value || 0),
        observaciones: $('e_obs').value.trim()
      };
      try{ await updateDoc(doc(db,'viajes',actualId), data); alert('Viaje actualizado'); modal.style.display='none'; }
      catch(err){ alert('Error al guardar: ' + (err.code||err.message)); }
    };

    async function eliminar(id){
      if (!confirm('¿Eliminar este viaje?')) return;
      try{ await deleteDoc(doc(db,'viajes',id)); }
      catch(err){ alert('No se pudo eliminar: ' + (err.code||err.message)); }
    }

    // Eventos
    $('q').addEventListener('input', render);
    $('orden').addEventListener('change', escuchar);

    onAuthStateChanged(auth, async (u)=>{
      if (!u){ location.href='login.html'; return; }
      miUid = u.uid;
      try{
        const snap = await getDoc(doc(db,'usuarios',u.uid));
        const p = snap.exists()? snap.data() : {};
        esAdmin = (p.rol||'').toLowerCase()==='admin';
        if (Array.isArray(p.patentes)) misPatentes = p.patentes.map(x=>up(x)).filter(Boolean);
        else if (p.patente) misPatentes = [ up(p.patente) ];
      }catch{ esAdmin=false; misPatentes=[]; }
      escuchar();
    });
  </script>
</body>
</html>
