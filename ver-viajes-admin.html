<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VER VIAJES – ADMIN</title>
  <style>
    body{margin:0;background:#FFD700;font-family:Arial,sans-serif;color:#fff;}
    .container{background:#000;max-width:900px;margin:40px auto;padding:24px;border-radius:12px;box-sizing:border-box;}
    h1{text-align:center;text-transform:uppercase;text-decoration:underline;margin:0 0 16px}

    /* Filtros: responsive, SIN desbordar */
    .filtros{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));
      gap:10px;
      margin:0 0 16px;
      width:100%;
      box-sizing:border-box;
    }
    .filtros input,.filtros select,.filtros button{
      padding:10px;
      border:1px solid #000;
      border-radius:6px;
      color:#000;
      background:#fff;
      box-sizing:border-box;
      font-weight:600;
    }

    .btn{padding:10px;border:1px solid #000;border-radius:6px;font-weight:bold;cursor:pointer;text-transform:uppercase}
    .btn-verde{background:green;color:#fff}
    .btn-naranja{background:orange;color:#000}
    .btn-rojo{background:red;color:#fff}
    .btn-volver{margin-top:16px}

    /* Lista centrada */
    .lista{display:grid;gap:12px}
    .item{
      background:#191919;
      border-radius:10px;
      padding:14px;
      text-align:center;             /* <- centrado */
    }
    .item p{margin:6px 0}

    .topline{
      display:inline-flex;            /* inline para respetar centrado */
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;         /* <- centrado */
    }
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:bold}
    .badge-rojo{background:#cc1d1d;color:#fff;border:1px solid #000}

    .acciones{
      margin-top:10px;
      display:flex;
      gap:10px;
      justify-content:center;        /* <- botón centrado */
      flex-wrap:wrap;
    }

    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center}
    .modal-content{background:#000;border-radius:12px;padding:16px;width:95%;max-width:600px}
    .edit-form{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .edit-form label{grid-column:span 2;font-weight:bold;text-transform:uppercase}
    .edit-form input,.edit-form textarea{padding:8px;border:1px solid #000;border-radius:4px;background:#fff;color:#000}
    .edit-form textarea{grid-column:span 2;height:70px;resize:vertical}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    @media (max-width:600px){
      .edit-form{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ver Viajes</h1>

    <!-- FILTROS -->
    <form class="filtros" id="formFiltros">
      <input type="date" id="desde" />
      <input type="date" id="hasta" />
      <select id="fChofer"><option value="">Todos los choferes</option></select>
      <select id="fPatente"><option value="">Todas las patentes</option></select>
      <input type="text" id="fCuit" placeholder="CUIT ORIGEN"/>
      <input type="text" id="buscar" placeholder="Buscar (origen, destino, obs)"/>
      <button type="button" class="btn btn-naranja" id="btnLimpiar">Limpiar</button>
    </form>

    <!-- LISTA -->
    <div id="lista" class="lista"></div>

    <button class="btn btn-naranja btn-volver" onclick="location.href='admin.html'">Volver</button>
  </div>

  <!-- MODAL DETALLE/EDICIÓN -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2 style="text-transform:uppercase;text-decoration:underline;margin-top:0">Detalle / Editar Viaje</h2>
      <form id="formEdit" class="edit-form">
        <label>Fecha</label>
        <input type="date" id="e_fecha"/>

        <label>Origen</label>
        <input type="text" id="e_origen"/>

        <label>Destino</label>
        <input type="text" id="e_destino"/>

        <label>Patente del camión</label>
        <input type="text" id="e_patente"/>

        <label>Chofer</label>
        <input type="text" id="e_chofer"/>

        <label>Tipo de carga</label>
        <input type="text" id="e_tipoCarga"/>

        <label>Peso / Kg cargados</label>
        <input type="number" id="e_peso"/>

        <label>Kg descargados</label>
        <input type="number" id="e_kgDescargados"/>

        <label>CUIT origen</label>
        <input type="text" id="e_cuit"/>

        <label>Adelanto ($)</label>
        <input type="number" id="e_adelanto"/>

        <label>Peaje ($)</label>
        <input type="number" id="e_peaje"/>

        <label>Entrada ($)</label>
        <input type="number" id="e_entrada"/>

        <label>Observaciones</label>
        <textarea id="e_observaciones"></textarea>
      </form>

      <div class="modal-actions">
        <button id="btnCombustible" class="btn btn-verde" type="button">Registrar combustible</button>
        <button id="btnGuardar" class="btn btn-verde" type="button">Guardar</button>
        <button id="btnEliminar" class="btn btn-rojo" type="button">Eliminar</button>
        <button id="btnCerrar" class="btn btn-naranja" type="button">Cerrar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
      authDomain: "transporte-mario-guizzo.firebaseapp.com",
      projectId: "transporte-mario-guizzo",
      storageBucket: "transporte-mario-guizzo.appspot.com",
      messagingSenderId: "465536166890",
      appId: "1:465536166890:web:f658690629b09eca8fa093"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const col = collection(db, "viajes");
    const lista = document.getElementById("lista");

    const fDesde = document.getElementById("desde");
    const fHasta = document.getElementById("hasta");
    const fChofer = document.getElementById("fChofer");
    const fPatente = document.getElementById("fPatente");
    const fCuit = document.getElementById("fCuit");
    const fBuscar = document.getElementById("buscar");
    const btnLimpiar = document.getElementById("btnLimpiar");

    let todos = [];
    let actualId = null;
    let actual = null;

    onSnapshot(col, (qs) => {
      todos = qs.docs.map(d => ({ id: d.id, ...d.data() }));
      // Orden por más reciente (timestamp si existe; si no, fecha)
      todos.sort((a,b) => {
        const ta = a.timestamp?.seconds ? a.timestamp.seconds : Date.parse(a.fecha || 0);
        const tb = b.timestamp?.seconds ? b.timestamp.seconds : Date.parse(b.fecha || 0);
        return tb - ta;
      });
      poblarSelects();
      render();
    });

    function poblarSelects(){
      const choferes = Array.from(new Set(todos.map(v => v.chofer).filter(Boolean))).sort();
      const patentes = Array.from(new Set(todos.map(v => v.patente).filter(Boolean))).sort();

      const chSel = fChofer.value, ptSel = fPatente.value;
      fChofer.innerHTML = '<option value="">Todos los choferes</option>' +
        choferes.map(c => `<option value="${c}">${c}</option>`).join('');
      fPatente.innerHTML = '<option value="">Todas las patentes</option>' +
        patentes.map(p => `<option value="${p}">${p}</option>`).join('');
      if (chSel) fChofer.value = chSel;
      if (ptSel) fPatente.value = ptSel;
    }

    function normalSiNo(val){
      if (typeof val === 'boolean') return val ? 'SI' : 'NO';
      if (typeof val === 'string') return val.trim().toLowerCase() ===
