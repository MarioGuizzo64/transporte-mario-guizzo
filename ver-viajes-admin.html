<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VER VIAJES – ADMIN</title>
  <style>
    body{margin:0;background:#FFD700;font-family:Arial,sans-serif;color:#fff;}
    .container{background:#000;max-width:900px;margin:40px auto;padding:24px;border-radius:12px;}
    h1{text-align:center;text-transform:uppercase;text-decoration:underline;margin:0 0 16px}

    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:0 0 10px}
    .btn{padding:10px;border:1px solid #000;border-radius:6px;font-weight:bold;cursor:pointer;text-transform:uppercase}
    .btn-verde{background:green;color:#fff}
    .btn-naranja{background:orange;color:#000}
    .btn-rojo{background:red;color:#fff}
    .btn-volver{margin-top:16px}

    .filtros{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));
      gap:10px;
      margin:0 0 16px;
      width:100%;
      box-sizing:border-box;
    }
    .filtros input,.filtros select {
      padding:10px;border:1px solid #000;border-radius:6px;color:#000;background:#fff;box-sizing:border-box;font-weight:600;
    }
    
    .lista{display:grid;gap:10px}
    .item{background:#191919;border-radius:10px;padding:12px}
    .item p{margin:3px 0}
    .topline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:bold}
    .badge-rojo{background:#cc1d1d;color:#fff;border:1px solid #000}
    .badge-amarillo{background:#ffbf00;color:#000;border:1px solid #000}

    .acciones{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center}
    /* Scrolleable y sin mover el fondo */
    .modal-content{
      background:#000;border-radius:12px;padding:16px;width:95%;max-width:600px;
      max-height:90vh;overflow-y:auto;
      box-shadow:0 10px 30px rgba(0,0,0,.5)
    }
    .edit-form{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .edit-form label{grid-column:span 2;font-weight:bold;text-transform:uppercase}
    .edit-form input,.edit-form textarea{padding:8px;border:1px solid #000;border-radius:4px;background:#fff;color:#000}
    .edit-form textarea{grid-column:span 2;height:70px;resize:vertical}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    /* Evitar scroll del fondo cuando el modal está abierto */
    body.modal-open{overflow:hidden}

    @media (max-width:900px){ .filtros{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:600px){
      .filtros{grid-template-columns:1fr}
      .edit-form{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ver Viajes</h1>

    <div class="toolbar">
      <button class="btn btn-verde" id="btnNuevo">Agregar viaje</button>
    </div>

    <form class="filtros" id="formFiltros">
      <input type="date" id="desde" />
      <input type="date" id="hasta" />
      <select id="fChofer"><option value="">Todos los choferes</option></select>
      <select id="fPatente"><option value="">Todas las patentes</option></select>
      <input type="text" id="fCuit" placeholder="CUIT ORIGEN"/>
      <input type="text" id="buscar" placeholder="Buscar (origen, destino, obs)"/>
      <button type="button" class="btn btn-naranja" id="btnLimpiar">Limpiar</button>
    </form>

    <div id="lista" class="lista"></div>

    <button class="btn btn-naranja btn-volver" onclick="location.href='admin.html'">Volver</button>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <h2 style="text-transform:uppercase;text-decoration:underline;margin-top:0">Detalle / Editar Viaje</h2>
      <form id="formEdit" class="edit-form">
        <label>Fecha</label><input type="date" id="e_fecha"/>
        <label>Origen</label><input type="text" id="e_origen"/>
        <label>Destino</label><input type="text" id="e_destino"/>
        <label>Patente del camión</label><input type="text" id="e_patente"/>
        <!-- Chofer removido del modal -->
        <label>Tipo de carga</label><input type="text" id="e_tipoCarga"/>
        <label>Peso / Kg cargados</label><input type="text" id="e_peso"/>
        <label>Kg descargados</label><input type="text" id="e_kgDescargados"/>
        <label>CUIT origen</label><input type="text" id="e_cuit"/>
        <label>Adelanto ($)</label><input type="text" id="e_adelanto"/>
        <label>Peaje ($)</label><input type="text" id="e_peaje"/>
        <label>Entrada ($)</label><input type="text" id="e_entrada"/>
        <label>Observaciones</label><textarea id="e_observaciones"></textarea>
      </form>

      <div class="modal-actions">
        <button id="btnCombustible" class="btn btn-verde" type="button">Registrar combustible</button>
        <button id="btnGuardar" class="btn btn-verde" type="button">Guardar</button>
        <button id="btnEliminar" class="btn btn-rojo" type="button">Eliminar</button>
        <button id="btnCerrar" class="btn btn-naranja" type="button">Cerrar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
      authDomain: "transporte-mario-guizzo.firebaseapp.com",
      projectId: "transporte-mario-guizzo",
      storageBucket: "transporte-mario-guizzo.appspot.com",
      messagingSenderId: "465536166890",
      appId: "1:465536166890:web:f658690629b09eca8fa093"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ---- Helpers ----
    // Acepta "1.234,56" o "1234.56" o "1234" -> Number
    const toNum = (v) => {
      if (v === null || v === undefined || v === '') return 0;
      if (typeof v === 'number' && isFinite(v)) return v;
      if (typeof v === 'string'){
        const s = v.replace(/\./g,'').replace(',','.');
        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
      }
      return 0;
    };
    const moneyOrEmpty = (v) => (v===undefined || v===null || v==='') ? '' : String(v);

    // ======= AUTH GATE =======
    onAuthStateChanged(auth, (user) => {
      if (!user) { window.location.href = "login.html"; return; }
      start(user);
    });

    function start(user){
      const col = collection(db, "viajes");
      const lista = document.getElementById("lista");

      const fDesde = document.getElementById("desde");
      const fHasta = document.getElementById("hasta");
      const fChofer = document.getElementById("fChofer");
      const fPatente = document.getElementById("fPatente");
      const fCuit = document.getElementById("fCuit");
      const fBuscar = document.getElementById("buscar");
      const btnLimpiar = document.getElementById("btnLimpiar");
      const btnNuevo = document.getElementById("btnNuevo");

      let todos = [];
      let actualId = null;
      let actual = null;
      let isNew = false;

      onSnapshot(col, (qs) => {
        todos = qs.docs.map(d => ({ id: d.id, ...d.data() }));
        todos.sort((a,b) => {
          const ta = a.timestamp?.seconds ? a.timestamp.seconds : Date.parse(a.fecha || 0);
          const tb = b.timestamp?.seconds ? b.timestamp.seconds : Date.parse(b.fecha || 0);
          return tb - ta;
        });
        poblarSelects();
        render();
      });

      function poblarSelects(){
        const choferes = Array.from(new Set(todos.map(v => v.chofer).filter(Boolean))).sort();
        const patentes = Array.from(new Set(todos.map(v => v.patente).filter(Boolean))).sort();
        const chSel = fChofer.value, ptSel = fPatente.value;
        fChofer.innerHTML = '<option value="">Todos los choferes</option>' + choferes.map(c => `<option value="${c}">${c}</option>`).join('');
        fPatente.innerHTML = '<option value="">Todas las patentes</option>' + patentes.map(p => `<option value="${p}">${p}</option>`).join('');
        if (chSel) fChofer.value = chSel;
        if (ptSel) fPatente.value = ptSel;
      }

      function normalSiNo(val){
        if (typeof val === 'boolean') return val ? 'SI' : 'NO';
        if (typeof val === 'string') return val.trim().toLowerCase() === 'si' ? 'SI' : (val.trim().toLowerCase() === 'no' ? 'NO' : '-');
        return '-';
      }

      function pasaFiltros(v){
        const vf = String(v.fecha || '');
        if (fDesde.value && vf < fDesde.value) return false;
        if (fHasta.value && vf > fHasta.value) return false;
        if (fChofer.value && v.chofer !== fChofer.value) return false;
        if (fPatente.value && v.patente !== fPatente.value) return false;
        const cuitOrigen = (v.cuitOrigen || v.cuit || '').toString();
        const qCuit = fCuit.value.trim();
        if (qCuit && !cuitOrigen.includes(qCuit)) return false;
        const q = fBuscar.value.trim().toLowerCase();
        if (q){
          const blob = [ v.origen, v.destino, v.observaciones, v.tipoCarga, v.tipoCereal, v.patente, v.chofer ]
            .map(x => (x||'') + '').join(' ').toLowerCase();
          if (!blob.includes(q)) return false;
        }
        return true;
      }

      function render(){
        const datos = todos.filter(pasaFiltros);
        lista.innerHTML = '';
        if (!datos.length){
          lista.innerHTML = '<div class="item"><p>No hay viajes para los filtros seleccionados.</p></div>';
          return;
        }
        for (const v of datos){
          const kgCargados = (v.kgLlevados ?? v.peso ?? '-') + (v.kgLlevados || v.peso ? ' kg' : '');
          const kgDesc = (v.kgDescargados ?? '-') + (v.kgDescargados ? ' kg' : (v.kgDescargados===0?' kg':''));
          const comb = v.hasOwnProperty('cargoCombustible') ? normalSiNo(v.cargoCombustible) : '-';
          const hayObs = !!(v.observaciones && String(v.observaciones).trim());
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <div class="topline">
              <p style="margin:0"><strong>Fecha:</strong> ${v.fecha || '-'}</p>
              ${hayObs ? '<span class="badge badge-rojo">OBSERVACIONES</span>' : ''}
            </div>
            <p><strong>Chofer:</strong> ${v.chofer || '-'}</p>
            <p><strong>Patente:</strong> ${v.patente || '-'}</p>
            <p><strong>Origen → Destino:</strong> ${v.origen || '-'} → ${v.destino || '-'}</p>
            <p><strong>Kg cargados:</strong> ${kgCargados} &nbsp; | &nbsp; <strong>Kg descargados:</strong> ${kgDesc}</p>
            <p><strong>Cargó combustible:</strong> ${comb}</p>
            <div class="acciones">
              <button class="btn btn-verde" onclick="window._abrir('${v.id}')">Ver / Editar</button>
            </div>
          `;
          lista.appendChild(div);
        }
      }

      [fDesde,fHasta,fChofer,fPatente,fCuit,fBuscar].forEach(el => el.addEventListener('input', render));
      btnLimpiar.addEventListener('click', () => {
        fDesde.value=''; fHasta.value=''; fChofer.value=''; fPatente.value=''; fCuit.value=''; fBuscar.value='';
        render();
      });

      // ---- Modal ----
      const modal = document.getElementById('modal');
      const get = id => document.getElementById(id);

      // Evitar scroll del fondo y evitar que el overlay mueva la página
      const abrirModal = () => {
        modal.style.display = 'flex';
        document.body.classList.add('modal-open');
      };
      const cerrarModal = () => {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
      };
      // Si se hace wheel sobre el overlay (no sobre el contenido), no scrollear el body
      modal.addEventListener('wheel', (e)=>{
        if (e.target === modal){ e.preventDefault(); }
      }, {passive:false});

      // ---- Abrir en modo EDITAR ----
      window._abrir = (id) => {
        const v = todos.find(x => x.id === id);
        if (!v) return;
        actualId = id; actual = v; isNew = false;

        abrirModal();

        get('e_fecha').value = v.fecha || '';
        get('e_origen').value = v.origen || '';
        get('e_destino').value = v.destino || '';
        get('e_patente').value = v.patente || '';
        get('e_tipoCarga').value = (v.tipoCereal || v.tipoCarga || '');
        get('e_peso').value = moneyOrEmpty(v.kgLlevados ?? v.peso);
        get('e_kgDescargados').value = moneyOrEmpty(v.kgDescargados);
        get('e_cuit').value = (v.cuitOrigen || v.cuit || '');

        // Importes desde cualquier nombre
        const readMoney = (obj, base) => {
          if (obj[base] !== undefined && obj[base] !== null) return obj[base];
          if (obj[base + 'Monto'] !== undefined && obj[base + 'Monto'] !== null) return obj[base + 'Monto'];
          return '';
        };
        get('e_adelanto').value = moneyOrEmpty(readMoney(v,'adelanto'));
        get('e_peaje').value    = moneyOrEmpty(readMoney(v,'peaje'));
        get('e_entrada').value  = moneyOrEmpty(readMoney(v,'entrada'));

        get('e_observaciones').value = v.observaciones || '';
      };

      // ---- Abrir en modo NUEVO ----
      btnNuevo.addEventListener('click', ()=>{
        isNew = true; actualId = null; actual = null;
        get('e_fecha').value = new Date().toISOString().slice(0,10);
        get('e_origen').value = '';
        get('e_destino').value = '';
        get('e_patente').value = '';
        get('e_tipoCarga').value = '';
        get('e_peso').value = '';
        get('e_kgDescargados').value = '';
        get('e_cuit').value = '';
        get('e_adelanto').value = '';
        get('e_peaje').value = '';
        get('e_entrada').value = '';
        get('e_observaciones').value = '';
        abrirModal();
      });

      get('btnCerrar').onclick = cerrarModal;

      // ---- Guardar (crear o actualizar) ----
      get('btnGuardar').onclick = async () => {
        const adelanto = toNum(get('e_adelanto').value);
        const peaje    = toNum(get('e_peaje').value);
        const entrada  = toNum(get('e_entrada').value);

        const baseData = {
          fecha: get('e_fecha').value || null,
          origen: get('e_origen').value.trim(),
          destino: get('e_destino').value.trim(),
          patente: get('e_patente').value.trim(),
          // chofer no se toca (fuera del modal)
          tipoCereal: get('e_tipoCarga').value.trim(),
          tipoCarga: get('e_tipoCarga').value.trim(),
          kgLlevados: toNum(get('e_peso').value),
          peso: toNum(get('e_peso').value),
          kgDescargados: toNum(get('e_kgDescargados').value),
          cuitOrigen: get('e_cuit').value.trim(),
          cuit: get('e_cuit').value.trim(),

          // Escribir ambos nombres + flags
          adelanto: adelanto,              adelantoMonto: adelanto,  adelantoAplica: adelanto > 0,
          peaje: peaje,                    peajeMonto: peaje,        peajeAplica: peaje > 0,
          entrada: entrada,                entradaMonto: entrada,    entradaAplica: entrada > 0,

          observaciones: get('e_observaciones').value.trim(),
        };

        try{
          if (isNew){
            await addDoc(col, { ...baseData, uidCreador: auth.currentUser?.uid || null, timestamp: serverTimestamp() });
            alert('Viaje creado');
          }else{
            await updateDoc(doc(db,'viajes', actualId), baseData);
            alert('Viaje actualizado');
          }
          cerrarModal();
        }catch(err){
          alert('Error al guardar: ' + err.message);
        }
      };

      // ---- Eliminar ----
      get('btnEliminar').onclick = async () => {
        if (isNew) { cerrarModal(); return; }
        if (!confirm('¿Eliminar este viaje?')) return;
        try{
          await deleteDoc(doc(db,'viajes', actualId));
          cerrarModal();
        }catch(err){
          alert('Error al eliminar: ' + err.message);
        }
      };

      // ---- Ir a registrar combustible con datos precargados ----
      get('btnCombustible').onclick = () => {
        const q = new URLSearchParams({ patente: get('e_patente').value, fecha: get('e_fecha').value });
        window.location.href = 'agregar-combustible.html?' + q.toString();
      };

      // Cerrar modal con ESC o click fuera
      window.addEventListener('keydown', (e)=>{ if (e.key==='Escape') cerrarModal(); });
      modal.addEventListener('click', (e)=>{ if (e.target===modal) cerrarModal(); });
    }
  </script>
</body>
</html>
