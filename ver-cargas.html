<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VER CARGAS</title>
  <style>
    body{margin:0;background:#FFD700;font-family:Arial,Helvetica,sans-serif;color:#fff}
    .wrap{max-width:900px;margin:36px auto;background:#000;border-radius:12px;padding:20px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 14px;text-align:center;text-transform:uppercase;text-decoration:underline}
    .top{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center}
    .top input,.top select{padding:9px;border:1px solid #000;border-radius:6px;background:#fff;color:#000}
    .btn{padding:10px 12px;border:1px solid #000;border-radius:8px;font-weight:bold;cursor:pointer}
    .btn-naranja{background:orange;color:#000}
    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:12px 0}
    .card{background:#0f1a0f;border:1px solid #1f3d1f;border-radius:8px;padding:10px;text-align:center}
    .card small{display:block;font-size:12px;opacity:.8}
    .card b{font-size:18px}
    .lista{display:grid;gap:10px}
    .item{background:#171717;border:1px solid #222;border-radius:10px;padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between}
    .pill{display:inline-block;background:#333;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}
    .foot{margin-top:6px;font-size:12px;opacity:.75}
    @media (max-width:720px){ .cards{grid-template-columns:1fr 1fr} .top{grid-template-columns:1fr 1fr;gap:6px} }
    @media (max-width:480px){ .cards{grid-template-columns:1fr} .top{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Viajes cargados — combustible</h1>

    <div class="top">
      <input id="buscar" placeholder="estación, patente, tipo, método, obs" />
      <select id="orden">
        <option value="fecha-desc">Fecha ↓</option>
        <option value="fecha-asc">Fecha ↑</option>
      </select>
      <button class="btn btn-naranja" onclick="location.href='index.html'">Volver</button>
    </div>

    <div class="cards">
      <div class="card"><small>Litros</small> <b id="kLitros">0</b></div>
      <div class="card"><small>Total $</small> <b id="kTotal">$ 0</b></div>
      <div class="card"><small>$/litro prom.</small> <b id="kProm">-</b></div>
      <div class="card"><small>Cargas</small> <b id="kCargas">0</b></div>
    </div>

    <div id="lista" class="lista"></div>

    <div id="dbg" class="foot"></div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
  authDomain: "transporte-mario-guizzo.firebaseapp.com",
  projectId: "transporte-mario-guizzo",
  storageBucket: "transporte-mario-guizzo.appspot.com",
  messagingSenderId: "465536166890",
  appId: "1:465536166890:web:f658690629b09eca8fa093"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

// ---------- helpers ----------
const fmt$ = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0));
const fmtN = n => new Intl.NumberFormat('es-AR',{maximumFractionDigits:0}).format(Number(n||0));
const canonPat = (p) => (p||'').toString().toUpperCase().replace(/[\s-]/g,'').trim();

function toISO(d){
  if (!d) return '';
  if (typeof d === 'string') {
    // acepta YYYY-MM-DD o DD/MM/AAAA
    if (/^\d{4}-\d{2}-\d{2}/.test(d)) return d.slice(0,10);
    const m = d.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if (m) { const [_,dd,mm,aa]=m; return new Date(+aa,+mm-1,+dd).toISOString().slice(0,10); }
    const t = Date.parse(d); return isNaN(t) ? '' : new Date(t).toISOString().slice(0,10);
  }
  if (d.seconds) return new Date(d.seconds*1000).toISOString().slice(0,10);
  try{ return d.toDate().toISOString().slice(0,10); }catch{ return ''; }
}
const toDMY = iso => iso ? `${iso.slice(8,10)}/${iso.slice(5,7)}/${iso.slice(0,4)}` : '-';

// Unificar doc → objeto común
function mapCarga(raw){
  const fechaISO = toISO(raw.fecha || raw.fechaCarga || raw.createdAt || raw.timestamp);
  const litros   = Number(raw.litros || 0);
  const precio   = Number(raw.precioPorLitro || raw.sl || 0);
  // Siempre priorizamos cálculo para evitar “00 de más”
  const total    = Math.round(litros * precio);
  return {
    id: raw.id || '',
    fechaISO,
    ts: fechaISO ? Date.parse(fechaISO) : (raw.timestamp?.seconds ? raw.timestamp.seconds*1000 : 0),
    estacion: raw.estacionServicio || raw.estacion || '',
    tipo: raw.tipoCombustible || raw.tipo || '',
    metodo: raw.metodoPago || raw.metodo || '',
    litros, precio, total,
    patente: (raw.patenteCamion || raw.patente || '').trim(),
    canon: canonPat(raw.patenteCamion || raw.patente || ''),
    obs: raw.observaciones || '',
    uid: raw.uid || raw.uidCreador || raw.usuarioUid || ''
  };
}

// ---------- estado UI ----------
const $lista  = document.getElementById('lista');
const $buscar = document.getElementById('buscar');
const $orden  = document.getElementById('orden');
const $kL     = document.getElementById('kLitros');
const $kT     = document.getElementById('kTotal');
const $kP     = document.getElementById('kProm');
const $kC     = document.getElementById('kCargas');
const $dbg    = document.getElementById('dbg');

let all = [];        // todas las cargas (de ambas colecciones)
let mine = [];       // filtradas por usuario
let myCanonPats = []; // patentes del usuario (normalizadas)
let me = null;

// ---------- auth gate ----------
onAuthStateChanged(auth, async (user)=>{
  if (!user){ location.href='login.html'; return; }
  me = user;

  // leer usuario → patentes asignadas
  try{
    const du = await getDoc(doc(db,'usuarios', user.uid));
    if (du.exists()){
      const d = du.data();
      const pats = [];
      if (Array.isArray(d.patentes)) pats.push(...d.patentes);
      if (d.patente) pats.push(d.patente);
      myCanonPats = [...new Set(pats.map(canonPat))].filter(Boolean);
    }else{
      myCanonPats = [];
    }
  }catch{ myCanonPats = []; }

  // escuchar ambas colecciones
  const stop1 = onSnapshot(collection(db,'cargas-combustible'),
    qs => {
      const arr = qs.docs.map(d => mapCarga({id:d.id, ...d.data()}));
      markAndMerge('cargas-combustible', arr);
    },
    err => markAndMerge('cargas-combustible', [], err)
  );

  const stop2 = onSnapshot(collection(db,'cargasCombustible'),
    qs => {
      const arr = qs.docs.map(d => mapCarga({id:d.id, ...d.data()}));
      markAndMerge('cargasCombustible', arr);
    },
    err => markAndMerge('cargasCombustible', [], err)
  );
});

const colState = { 'cargas-combustible': '…', 'cargasCombustible': '…' };
function markAndMerge(col, arr, err){
  colState[col] = err ? `error:${err.code||'x'}` : `ok:${arr.length}`;
  // reemplazar lo de esa colección
  const others = all.filter(x => x._from !== col);
  all = [...others, ...arr.map(x=>({...x, _from:col}))];
  render();
}

function passesOwner(c){
  // es mío si:
  // - uid del doc es mi uid
  // - o la patente del doc coincide con alguna asignada al usuario
  if (c.uid && me && c.uid === me.uid) return true;
  if (myCanonPats.length && c.canon && myCanonPats.includes(c.canon)) return true;
  // si no hay patentes definidas para el usuario, dejamos pasar SOLO por uid
  return false;
}

function render(){
  const q = ($buscar.value||'').trim().toLowerCase();
  mine = all.filter(passesOwner);

  // ordenar
  const ord = $orden.value;
  mine.sort((a,b)=> ord==='fecha-asc' ? (a.ts - b.ts) : (b.ts - a.ts));

  // buscar
  const rows = mine.filter(c=>{
    if (!q) return true;
    const blob = [
      c.estacion, c.tipo, c.metodo, c.patente, c.obs,
      toDMY(c.fechaISO)
    ].join(' ').toLowerCase();
    return blob.includes(q);
  });

  // totales
  const litros = rows.reduce((a,b)=>a+(b.litros||0),0);
  const total  = rows.reduce((a,b)=>a+(b.total || 0),0);
  const prom   = litros>0 ? (total/litros) : 0;

  $kL.textContent = fmtN(litros);
  $kT.textContent = fmt$(total);
  $kP.textContent = litros>0 ? new Intl.NumberFormat('es-AR',{maximumFractionDigits:0}).format(prom) : '-';
  $kC.textContent = rows.length;

  // lista
  if (!rows.length){
    $lista.innerHTML = `<div class="item">No hay cargas para mostrar.</div>`;
  }else{
    $lista.innerHTML = rows.map(c=>`
      <div class="item">
        <div class="row">
          <div><b>Fecha:</b> ${toDMY(c.fechaISO)}</div>
          <div><b>Patente:</b> ${c.patente || '-'}</div>
        </div>
        <div><b>Estación:</b> ${c.estacion || '-'}
             <span class="pill"><b>Tipo:</b> ${c.tipo || '-'}</span>
             <span class="pill"><b>Método:</b> ${c.metodo || '-'}</span>
        </div>
        <div style="margin-top:4px">
          <b>Litros:</b> ${fmtN(c.litros)} &nbsp;|&nbsp;
          <b>$/l:</b> ${fmtN(c.precio)} &nbsp;|&nbsp;
          <b>Total:</b> ${fmt$(c.total)}
        </div>
        ${c.obs ? `<div class="foot"><b>Obs:</b> ${c.obs}</div>` : ``}
      </div>
    `).join('');
  }

  // debug de colecciones leídas
  const dbgTxt = `colecciones → cargas-combustible: ${colState['cargas-combustible']} · cargasCombustible: ${colState['cargasCombustible']}`;
  $dbg.textContent = dbgTxt;
}

$buscar.addEventListener('input', render);
$orden.addEventListener('change', render);
</script>
</body>
</html>
