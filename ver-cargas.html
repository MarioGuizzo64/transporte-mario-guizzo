<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ver cargas de combustible</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Forzamos la estética como en index.html */
    :root{
      --amarillo:#FFD700;
      --negro:#000;
      --gris1:#111;
      --gris2:#1b1b1b;
      --gris3:#2a2a2a;
      --texto:#fff;
    }
    body{ background:var(--negro); color:var(--texto); font-family:Arial, sans-serif; margin:0; }
    header{ text-align:center; padding:20px 12px; }
    h1, h2{ text-transform:uppercase; margin:6px 0; }
    .wrap{
      max-width:950px; margin:0 auto; padding:20px 14px 40px;
    }
    .card{
      background:var(--gris1); border:1px solid var(--gris3);
      border-radius:12px; padding:18px; margin:0 auto;
    }
    .stats{
      display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-bottom:14px;
    }
    .pill{
      background:var(--amarillo); color:#000; font-weight:bold;
      border-radius:999px; padding:6px 12px; text-transform:uppercase; font-size:14px;
    }
    .list{ display:flex; flex-direction:column; gap:12px; }
    .item{
      background:var(--gris2); border:1px solid var(--gris3);
      border-radius:10px; padding:14px;
    }
    .item h3{ margin:0 0 8px 0; font-size:18px; text-transform:uppercase; }
    .grid{
      display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:6px 16px; font-size:14px;
    }
    .muted{ color:#bbb; }
    .center{ text-align:center; }
    .empty{ text-align:center; color:#bbb; padding:24px 8px; }

    /* Botón igual que tus .btn-naranja */
    .btn-naranja{
      display:inline-block; border:none; border-radius:8px; padding:10px 14px;
      background:var(--amarillo); color:#000; font-weight:bold; text-transform:uppercase;
      cursor:pointer;
    }

    @media (max-width:620px){ .grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>Transporte Mario Güizzo</h1>
    <h2>Ver cargas de combustible</h2>
  </header>

  <div class="wrap">
    <div class="card">
      <!-- Contadores -->
      <div class="stats">
        <div class="pill">Cargas: <span id="count">0</span></div>
        <!-- Si querés, puedo activar estos totales:
        <div class="pill">Litros: <span id="litrosTotal">0</span></div>
        <div class="pill">Total $: <span id="montoTotal">0</span></div> -->
      </div>

      <!-- Lista -->
      <div id="lista" class="list">
        <div class="empty">Cargando...</div>
      </div>

      <div class="center" style="margin-top:16px;">
        <button class="btn-naranja" onclick="location.href='index.html'">Volver</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
      authDomain: "transporte-mario-guizzo.firebaseapp.com",
      projectId: "transporte-mario-guizzo",
      storageBucket: "transporte-mario-guizzo.appspot.com",
      messagingSenderId: "465536166890",
      appId: "1:465536166890:web:f658690629b09eca8fa093"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const listaEl = document.getElementById('lista');
    const countEl = document.getElementById('count');
    // const litrosTotalEl = document.getElementById('litrosTotal');
    // const montoTotalEl = document.getElementById('montoTotal');

    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = 'login.html'; return; }
      await cargarCargas(user);
    });

    function toDateStr(v){
      try{
        if (!v) return '';
        if (typeof v === 'string') return v;
        if (v?.seconds) return new Date(v.seconds*1000).toISOString().slice(0,10);
        if (v instanceof Date) return v.toISOString().slice(0,10);
        return String(v);
      }catch{ return String(v ?? ''); }
    }

    async function cargarCargas(user){
      listaEl.innerHTML = '<div class="empty">Cargando...</div>';

      const col = collection(db, 'cargasCombustible'); // <-- cambia si tu colección se llama distinto
      let docs = [];

      // 1) Por uid
      try{
        const q1 = query(col, where('uid','==', user.uid));
        const s1 = await getDocs(q1);
        s1.forEach(d => docs.push({ id:d.id, ...d.data() }));
      }catch(e){ console.error('uid query', e); }

      // 2) Fallback por email en minúsculas (si guardaste email en vez de uid)
      if (docs.length === 0){
        try{
          const emailLower = (user.email || '').toLowerCase();
          const q2 = query(col, where('email','==', emailLower));
          const s2 = await getDocs(q2);
          s2.forEach(d => docs.push({ id:d.id, ...d.data() }));
        }catch(e){ console.error('email query', e); }
      }

      if (docs.length === 0){
        listaEl.innerHTML = '<div class="empty">No tenés cargas registradas.</div>';
        countEl.textContent = '0';
        return;
      }

      // Ordenar por fecha descendente si existe
      docs.sort((a,b) => {
        const fa = new Date(toDateStr(a.fechaCarga || a.fecha)).getTime() || 0;
        const fb = new Date(toDateStr(b.fechaCarga || b.fecha)).getTime() || 0;
        return fb - fa;
      });

      // Totales / contador
      countEl.textContent = String(docs.length);
      // let litrosTotal = 0, montoTotal = 0;

      // Render
      listaEl.innerHTML = '';
      docs.forEach(c => {
        const fecha = toDateStr(c.fechaCarga || c.fecha);
        const litros = Number(c.litros ?? c.cantidadLitros ?? c.cantidad ?? 0);
        const precio = Number(c.precioPorLitro ?? c.precio ?? 0);
        const total  = c.total ?? (litros && precio ? (litros * precio) : '');

        // litrosTotal += isFinite(litros) ? litros : 0;
        // montoTotal  += isFinite(total)  ? Number(total) : 0;

        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <h3>${fecha || 'Sin fecha'}</h3>
          <div class="grid">
            <div><span class="muted">Litros:</span> ${litros || '-'}</div>
            <div><span class="muted">Precio x litro:</span> ${precio ? '$ ' + precio : '-'}</div>
            <div><span class="muted">Total pagado:</span> ${total ? '$ ' + total : '-'}</div>
            <div><span class="muted">Estación:</span> ${c.estacion || c.estacionServicio || '-'}</div>
            <div><span class="muted">Tipo combustible:</span> ${c.tipo || c.tipoCombustible || '-'}</div>
            <div><span class="muted">Patente camión:</span> ${c.patente || c.patenteCamion || '-'}</div>
          </div>
        `;
        listaEl.appendChild(div);
      });

      // litrosTotalEl.textContent = String(litrosTotal);
      // montoTotalEl.textContent  = new Intl.NumberFormat('es-AR',{minimumFractionDigits:2}).format(montoTotal);
    }
  </script>
</body>
</html>
