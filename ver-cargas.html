<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>VER CARGAS</title>
  <style>
    body{margin:0;background:#FFD700;font-family:Arial,sans-serif;color:#fff}
    .wrap{max-width:950px;margin:40px auto;background:#0e0e0e;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 12px;text-align:center;text-transform:uppercase;text-decoration:underline}
    .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .bar input,.bar select{padding:8px;border:1px solid #000;border-radius:6px;background:#fff;color:#000}
    .pill-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;margin-bottom:10px}
    .pill{background:#0f1a0f;border:1px solid #1f3d1f;border-radius:10px;padding:10px;text-align:center}
    .pill .label{font-size:12px;color:#a0d8a0;text-transform:uppercase}
    .pill .val{font-weight:bold;font-size:18px}
    .card{background:#1b1b1b;border-radius:12px;padding:12px;margin-top:10px}
    .row{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .tag{display:inline-block;background:#2b2b2b;border:1px solid #3a3a3a;border-radius:999px;padding:2px 8px;margin-right:6px;font-size:12px}
    .actions{margin-top:8px;display:flex;gap:8px}
    .btn{padding:8px 12px;border:1px solid #000;border-radius:6px;cursor:pointer;font-weight:bold}
    .btn-back{background:orange;color:#000}
    .btn-green{background:#2e7d32;color:#fff}
    .btn-red{background:#c62828;color:#fff}
    .muted{opacity:.8}
    .foot{font-size:12px;color:#bbb;margin-top:6px}
    .empty{padding:14px;background:#141414;border:1px dashed #333;border-radius:10px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Viajes cargados — Combustible</h1>

    <div class="bar">
      <input id="q" placeholder="estación, patente, tipo, método, obs">
      <select id="ord">
        <option value="fecha_desc">Fecha ↓</option>
        <option value="fecha_asc">Fecha ↑</option>
        <option value="ts_desc">Creación ↓</option>
        <option value="ts_asc">Creación ↑</option>
      </select>
      <button class="btn btn-back" onclick="location.href='index.html'">Volver</button>
    </div>

    <div class="pill-row">
      <div class="pill"><div class="label">Litros</div><div id="p_litros" class="val">0</div></div>
      <div class="pill"><div class="label">Total $</div><div id="p_total" class="val">$ 0</div></div>
      <div class="pill"><div class="label">$ / litro prom.</div><div id="p_prom" class="val">-</div></div>
      <div class="pill"><div class="label">Cargas</div><div id="p_cant" class="val">0</div></div>
    </div>

    <div id="lista"></div>
    <div id="msg" class="empty" style="display:none">Cargando…</div>

    <div class="foot" id="debug"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, collection, query, where, onSnapshot, getDoc, doc, deleteDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // -------- Firebase --------
    const firebaseConfig = {
      apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
      authDomain: "transporte-mario-guizzo.firebaseapp.com",
      projectId: "transporte-mario-guizzo",
      storageBucket: "transporte-mario-guizzo.firebasestorage.app",
      messagingSenderId: "465536166890",
      appId: "1:465536166890:web:f658690629b09eca8fa093"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // -------- UI refs --------
    const qInp   = document.getElementById('q');
    const ordSel = document.getElementById('ord');
    const lista  = document.getElementById('lista');
    const msg    = document.getElementById('msg');
    const dbg    = document.getElementById('debug');
    const pLitros= document.getElementById('p_litros');
    const pTotal = document.getElementById('p_total');
    const pProm  = document.getElementById('p_prom');
    const pCant  = document.getElementById('p_cant');

    // -------- Helpers --------
    const normPat = s => (s||"").toString().toUpperCase().replace(/[^A-Z0-9]/g,''); // saca espacios/guiones
    const safeStr = v => (v ?? '').toString();

    function parseToDate(f){
      // acepta "YYYY-MM-DD", "DD/MM/YYYY" o timestamp ISO
      if (!f) return null;
      const s = String(f);
      if (/\d{4}-\d{2}-\d{2}/.test(s)) { const [y,m,d]=s.split('-'); return new Date(+y,+m-1,+d); }
      if (/\d{2}\/\d{2}\/\d{4}/.test(s)) { const [d,m,y]=s.split('/'); return new Date(+y,+m-1,+d); }
      const d = new Date(s); return isNaN(d)?null:d;
    }
    const fmtFechaAR = f => {
      const d = parseToDate(f); if (!d) return '-';
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    };

    // convierte string con "." o "," en número
    const nAR = (x) => {
      if (typeof x === 'number') return x;
      const s = (x ?? '').toString().trim();
      if (!s) return 0;
      const clean = s.replace(/\./g,'').replace(/,/g,'.');
      const n = Number(clean);
      return isNaN(n) ? 0 : n;
    };

    // Normaliza posibles **centavos** guardados como enteros grandes (×100)
    const normalizaPrecio = (p) => {
      let n = nAR(p);
      // si parece estar en centavos (ej: 145000), dividir por 100
      if (n >= 20000) n = Math.round(n / 100);
      return n;
    };
    const normalizaTotal = (t) => {
      let n = nAR(t);
      // totales reales suelen ser < 5.000.000; si viene con 2 ceros de más, dividir
      if (n >= 2_000_000) n = Math.round(n / 100);
      return n;
    };

    const money0 = n => (n||0).toLocaleString('es-AR', {maximumFractionDigits:0});
    const num2   = n => (n||0).toLocaleString('es-AR', {maximumFractionDigits:2});

    // estado
    let uid = null;
    let patentesUser = [];   // normalizadas (sin espacios)
    let datos = [];          // cargas combinadas
    let unsubAll = [];       // listeners activos

    function clearListeners(){
      unsubAll.forEach(fn=>{ try{fn();}catch{} });
      unsubAll = [];
    }
    function addListener(fn){ unsubAll.push(fn); }

    function calcAndRender(){
      // ordenar en memoria
      const ord = ordSel.value;
      const byFecha = (a,b)=> safeStr(a.fecha).localeCompare(safeStr(b.fecha));
      const byTs = (a,b)=> (a.timestamp?.seconds||0) - (b.timestamp?.seconds||0);
      let arr = [...datos];
      if (ord==='fecha_asc') arr.sort(byFecha);
      if (ord==='fecha_desc') arr.sort(byFecha).reverse();
      if (ord==='ts_asc') arr.sort(byTs);
      if (ord==='ts_desc') arr.sort(byTs).reverse();

      // filtro de búsqueda
      const q = qInp.value.trim().toLowerCase();
      if (q){
        arr = arr.filter(c=>{
          const blob = [
            c.estacion || c.estacionServicio,
            c.patente, c.patenteCamion, c.tipoCombustible, c.metodoPago,
            c.observaciones
          ].map(s=>safeStr(s).toLowerCase()).join(' ');
          return blob.includes(q);
        });
      }

      // totales
      let L=0, TOTAL=0;
      for (const c of arr){
        const litros = nAR(c.litros);
        const precio = normalizaPrecio(c.precioPorLitro);
        const total  = (c.totalPagado!=null && c.totalPagado!=="")
          ? normalizaTotal(c.totalPagado)
          : precio * litros;
        L += litros;
        TOTAL += total;
      }
      const prom = L>0 ? TOTAL/L : 0;
      pLitros.textContent = num2(L);
      pTotal.textContent  = '$ ' + money0(TOTAL);
      pProm.textContent   = L>0 ? num2(prom) : '-';
      pCant.textContent   = arr.length.toString();

      // lista
      lista.innerHTML = "";
      if (arr.length===0){
        msg.style.display='block';
        msg.textContent='No hay cargas para mostrar.';
        return;
      }
      msg.style.display='none';

      for (const c of arr){
        const litros = nAR(c.litros);
        const precio = normalizaPrecio(c.precioPorLitro);
        const total  = (c.totalPagado!=null && c.totalPagado!=="")
          ? normalizaTotal(c.totalPagado)
          : precio * litros;
        const plitro = (litros>0)
          ? (precio || (total>0 ? total/litros : 0))
          : (precio||0);

        const yoSoyAutor = (c.uid === uid) || (c.uidCreador === uid) || (c.creadoPor===uid);

        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="row">
            <div><strong>Fecha:</strong> ${fmtFechaAR(c.fecha)}</div>
            <div class="muted"><strong>Patente:</strong> ${c.patente || c.patenteCamion || '-'}</div>
          </div>
          <div class="muted" style="margin-top:4px">
            <strong>Estación:</strong> ${c.estacion || c.estacionServicio || '-'}
            &nbsp; | &nbsp; <strong>Tipo:</strong> ${c.tipoCombustible || '-'}
            &nbsp; | &nbsp; <strong>Método:</strong> ${c.metodoPago || '-'}
          </div>
          <div style="margin-top:6px">
            <span class="tag">Litros: ${num2(litros)}</span>
            <span class="tag">$/l: ${plitro ? num2(plitro) : '-'}</span>
            <span class="tag">Total: $ ${money0(total)}</span>
          </div>
          <div class="actions" ${yoSoyAutor? '' : 'style="display:none"'} >
            <button class="btn btn-green" data-edit="${c.__id}" data-col="${c.__col}">Editar</button>
            <button class="btn btn-red" data-del="${c.__id}" data-col="${c.__col}">Eliminar</button>
          </div>
        `;
        lista.appendChild(div);
      }

      // wire botones
      lista.querySelectorAll('[data-del]').forEach(b=>{
        b.onclick = ()=> eliminar(b.getAttribute('data-col'), b.getAttribute('data-del'));
      });
      lista.querySelectorAll('[data-edit]').forEach(b=>{
        b.onclick = ()=> editar(b.getAttribute('data-col'), b.getAttribute('data-edit'));
      });
    }

    async function eliminar(col, id){
      if (!confirm('¿Eliminar esta carga?')) return;
      try{
        await deleteDoc(doc(db, col, id));
      }catch(e){
        alert('No se pudo eliminar: ' + (e.code||e.message));
      }
    }

    async function editar(col, id){
      const item = datos.find(x=>x.__id===id && x.__col===col);
      if (!item) return;
      const nuevaFecha = prompt('Fecha (dd/mm/aaaa):', fmtFechaAR(item.fecha));
      if (nuevaFecha===null) return;
      const nuevosLitros = prompt('Litros:', nAR(item.litros));
      if (nuevosLitros===null) return;
      const nuevoPrecio = prompt('Precio por litro:', normalizaPrecio(item.precioPorLitro));
      if (nuevoPrecio===null) return;

      // convertir fecha a ISO para guardar
      let iso = nuevaFecha;
      if (/\d{2}\/\d{2}\/\d{4}/.test(nuevaFecha)) {
        const [d,m,y] = nuevaFecha.split('/');
        iso = `${y}-${m}-${d}`;
      }

      try{
        await updateDoc(doc(db, col, id), {
          fecha: iso,
          litros: nAR(nuevosLitros),
          precioPorLitro: nAR(nuevoPrecio)
        });
      }catch(e){
        alert('No se pudo actualizar: ' + (e.code||e.message));
      }
    }

    function watchCollection(colName, patentesUser){
      const colRef = collection(db, colName);

      // Por UID (actual y compat histórica)
      addListener(onSnapshot(query(colRef, where('uid','==', uid)), snap=>{
        upsertFromSnapshot(colName, snap); calcAndRender();
      }, onSnapError));

      addListener(onSnapshot(query(colRef, where('uidCreador','==', uid)), snap=>{
        upsertFromSnapshot(colName, snap); calcAndRender();
      }, onSnapError));

      // Por patentes – hasta 10
      if (patentesUser.length>0 && patentesUser.length<=10){
        addListener(onSnapshot(query(colRef, where('patente','in', patentesUser)), snap=>{
          upsertFromSnapshot(colName, snap); calcAndRender();
        }, onSnapError));

        addListener(onSnapshot(query(colRef, where('patenteCamion','in', patentesUser)), snap=>{
          upsertFromSnapshot(colName, snap); calcAndRender();
        }, onSnapError));
      }
    }

    function onSnapError(err){
      console.error(`[SNAP ERROR]`, err);
      msg.style.display = 'block';
      msg.textContent = 'No se pudieron cargar las cargas (' + (err.code||err.message) + ').';
    }

    function upsertFromSnapshot(colName, snap){
      const map = new Map(datos.map(d => [d.__col+'|'+d.__id, d]));
      snap.docChanges().forEach(ch=>{
        const key = colName + '|' + ch.doc.id;
        if (ch.type==='removed'){
          map.delete(key);
        } else {
          const d = ch.doc.data();
          map.set(key, { __id: ch.doc.id, __col: colName, ...d });
        }
      });
      datos = Array.from(map.values());
    }

    // eventos UI
    qInp.addEventListener('input', calcAndRender);
    ordSel.addEventListener('change', calcAndRender);

    onAuthStateChanged(auth, async (u)=>{
      if (!u){ location.href='login.html'; return; }
      uid = u.uid;

      // leo perfil (para patentes)
      let patentes = [];
      try{
        const ps = await getDoc(doc(db,'usuarios', uid));
        if (ps.exists()){
          const p = ps.data();
          if (Array.isArray(p.patentes) && p.patentes.length){
            patentes = p.patentes;
          }else if (p.patente){
            patentes = [ p.patente ];
          }
        }
      }catch(e){ console.warn('perfil usuario:', e); }

      const patNorm = patentes.map(normPat).filter(Boolean);

      // comienzo listeners
      clearListeners();
      watchCollection('cargas-combustible', patNorm);
      watchCollection('cargasCombustible',  patNorm);

      // mini-debug
      dbg.textContent = `colecciones → cargas-combustible ✓  •  cargasCombustible ✓`;
      msg.style.display='block'; msg.textContent='Cargando…';
    });
  </script>
</body>
</html>
