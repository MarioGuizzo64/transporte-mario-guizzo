<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VER CARGAS</title>
  <style>
    :root{--yellow:#FFD700;--black:#0b0b0b;--panel:#151515;--soft:#1e1e1e;--line:#2a2a2a;--green:#2e7d32;--red:#c62828;--blue:#1976d2;}
    body{margin:0;background:var(--yellow);font-family:Arial,Helvetica,sans-serif;color:#fff}
    .wrap{max-width:900px;margin:42px auto;background:#000;border-radius:14px;box-shadow:0 14px 32px rgba(0,0,0,.35);padding:22px}
    h1{margin:0 0 16px;text-align:center;text-transform:uppercase;text-decoration:underline}

    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin:0 0 12px}
    .search{flex:1;min-width:220px;display:flex;gap:8px;align-items:center}
    .search input{flex:1;padding:10px;border-radius:8px;border:1px solid #000;background:#fff;color:#000}
    .order{display:flex;gap:8px;align-items:center}
    .order select{padding:10px;border-radius:8px;border:1px solid #000;background:#fff;color:#000}
    .btn{padding:10px 12px;border:1px solid #000;border-radius:8px;background:orange;color:#000;font-weight:bold;cursor:pointer}

    /* Resumen */
    .resumen{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:6px 0 16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center}
    .card small{opacity:.8}
    .card b{display:block;margin-top:6px;font-size:18px}

    /* Lista */
    .lista{display:grid;gap:10px}
    .item{background:#191919;border:1px solid #232323;border-radius:12px;padding:12px}
    .item h3{margin:0 0 6px;font-size:16px}
    .meta{display:flex;gap:14px;flex-wrap:wrap;opacity:.9}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#2d2d2d;font-size:12px;margin-right:6px;border:1px solid #000}
    .pill.warn{background:#8d2323}
    .note{font-size:12px;opacity:.8;margin-top:8px}
    .volver{margin-top:14px}
    @media (max-width:720px){ .resumen{grid-template-columns:1fr 1fr} }
    @media (max-width:460px){ .resumen{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Viajes cargados — Combustible</h1>

    <div class="topbar">
      <div class="search">
        <label for="q" style="opacity:.85">Buscar:</label>
        <input id="q" placeholder="estación, patente, tipo, método, obs"/>
      </div>
      <div class="order">
        <label for="orden" style="opacity:.85">Ordenar por:</label>
        <select id="orden">
          <option value="fecha-desc">Fecha ↓</option>
          <option value="fecha-asc">Fecha ↑</option>
          <option value="total-desc">Total $ ↓</option>
          <option value="total-asc">Total $ ↑</option>
          <option value="litros-desc">Litros ↓</option>
          <option value="litros-asc">Litros ↑</option>
        </select>
        <button class="btn" id="btnVolver">Volver</button>
      </div>
    </div>

    <!-- RESUMEN -->
    <div class="resumen">
      <div class="card"><small>Litros</small>      <b id="kLitros">-</b></div>
      <div class="card"><small>Total $</small>     <b id="kTotal">$ -</b></div>
      <div class="card"><small>$/litro prom.</small><b id="kProm">-</b></div>
      <div class="card"><small>Cargas</small>      <b id="kCargas">-</b></div>
    </div>

    <div class="lista" id="lista"></div>

    <button class="btn volver" onclick="location.href='index.html'">Volver</button>

    <div class="note" id="dbg" style="margin-top:10px;opacity:.7"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /* ========= Firebase ========= */
    const firebaseConfig = {
      apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
      authDomain: "transporte-mario-guizzo.firebaseapp.com",
      projectId: "transporte-mario-guizzo",
      storageBucket: "transporte-mario-guizzo.appspot.com",
      messagingSenderId: "465536166890",
      appId: "1:465536166890:web:f658690629b09eca8fa093"
    };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ========= Utils ========= */
    const $ = (id)=> document.getElementById(id);
    const fmtMoney = (n)=> new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0}).format(Number(n||0));
    const fmtInt   = (n)=> new Intl.NumberFormat("es-AR",{maximumFractionDigits:0}).format(Number(n||0));
    function toNumber(v){
      if (typeof v === "number") return v;
      if (v==null || v==="")   return 0;
      // "1.450"->1450 ; "499.356"->499356 ; "1,50"->1.5
      const s = String(v).trim().replace(/\./g,"").replace(/,/g,".");
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }
    function parseFecha(f){
      if (!f) return null;
      if (typeof f === "string"){
        if (/^\d{4}-\d{2}-\d{2}/.test(f)) return new Date(f);
        if (/^\d{2}\/\d{2}\/\d{4}/.test(f)){ const [dd,mm,aa]=f.split("/"); return new Date(+aa,+mm-1,+dd); }
      }
      if (f.seconds) return new Date(f.seconds*1000);
      const d = new Date(f); return isNaN(d) ? null : d;
    }
    const dmy = (f)=>{
      const d = parseFecha(f); if (!d) return "-";
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const aa = d.getFullYear();
      return `${dd}/${mm}/${aa}`;
    };

    // Normalizadores (ambas colecciones)
    const combPatente  = (c) => (c.patenteCamion || c.patente || "").trim();
    const combEstacion = (c) => c.estacionServicio || c.estacion || "";
    const combMetodo   = (c) => c.metodoPago || c.metodo || "";
    const combTipo     = (c) => c.tipoCombustible || c.tipo || "";
    const combFecha    = (c) => c.fecha || c.fechaCarga || c.fechaCompra || "";
    const combLitros   = (c) => toNumber(c.litros);
    const combTotal    = (c) => {
      // Si hay totalPagado válido lo uso, si no, Litros * PrecioPorLitro
      const L = combLitros(c);
      const P = toNumber(c.precioPorLitro ?? c.sl);
      const T = (c.totalPagado==="" || c.totalPagado==null) ? (L>0 && P>0 ? L*P : 0) : toNumber(c.totalPagado);
      return T;
    };

    /* ========= Estado ========= */
    let MIS_PATENTES = new Set();  // desde usuarios/{uid}
    let todas = [];                // merge de ambas colecciones
    let cargadasA = false, cargadasB = false;
    let lastErr = "";

    /* ========= UI refs ========= */
    const q = $("q");
    const orden = $("orden");
    const kLitros=$("kLitros"), kTotal=$("kTotal"), kProm=$("kProm"), kCargas=$("kCargas");
    const lista = $("lista");
    const dbg = $("dbg");
    $("btnVolver").onclick = ()=> history.back();

    /* ========= Auth ========= */
    onAuthStateChanged(auth, async (user) => {
      if (!user){ location.href = "login.html"; return; }

      // Traer patentes asignadas al chofer
      try{
        const snap = await getDoc(doc(db, "usuarios", user.uid));
        if (snap.exists()){
          const u = snap.data();
          if (Array.isArray(u.patentes)) u.patentes.forEach(p=>MIS_PATENTES.add(String(p).trim()));
          if (u.patente) MIS_PATENTES.add(String(u.patente).trim());
        }
      }catch(e){ console.warn("usuarios/{uid} no disponible", e); }

      // Suscribirse a ambas colecciones
      onSnapshot(collection(db,"cargas-combustible"), (qs)=>{
        cargadasA = true;
        const arr = qs.docs.map(d => ({id:d.id, src:"a", ...d.data()}));
        todas = [ ...arr, ...todas.filter(x => x.src!=="a") ];
        sortAndRender();
      }, (err)=>{ lastErr = err.code||err.message; sortAndRender(); });

      onSnapshot(collection(db,"cargasCombustible"), (qs)=>{
        cargadasB = true;
        const arr = qs.docs.map(d => ({id:d.id, src:"b", ...d.data()}));
        todas = [ ...todas.filter(x => x.src!=="b"), ...arr ];
        sortAndRender();
      }, (err)=>{ lastErr = err.code||err.message; sortAndRender(); });
    });

    /* ========= Render ========= */
    function pasaFiltroTexto(c){
      const s = (q.value||"").trim().toLowerCase();
      if (!s) return true;
      const blob = [
        combEstacion(c), combTipo(c), combMetodo(c), combPatente(c), c.observaciones
      ].map(x => (x||"")+"").join(" ").toLowerCase();
      return blob.includes(s);
    }

    function datosFiltrados(){
      // restringir por patentes del chofer (si existen)
      let arr = todas.filter(c=>{
        const p = combPatente(c);
        if (MIS_PATENTES.size && !MIS_PATENTES.has(p)) return false;
        return true;
      }).filter(pasaFiltroTexto);

      // ordenar
      const key = orden.value;
      arr.sort((a,b)=>{
        if (key==="fecha-desc") return (parseFecha(combFecha(b))||0) - (parseFecha(combFecha(a))||0);
        if (key==="fecha-asc")  return (parseFecha(combFecha(a))||0) - (parseFecha(combFecha(b))||0);
        if (key==="total-desc") return combTotal(b) - combTotal(a);
        if (key==="total-asc")  return combTotal(a) - combTotal(b);
        if (key==="litros-desc")return combLitros(b) - combLitros(a);
        if (key==="litros-asc") return combLitros(a) - combLitros(b);
        return 0;
      });
      return arr;
    }

    function actualizarResumen(arr){
      const cargas = arr.length;
      let litros = 0, total = 0;
      for (const c of arr){ litros += combLitros(c); total += combTotal(c); }
      const prom = litros>0 ? total/litros : 0;
      kLitros.textContent = fmtInt(litros) + " l";
      kTotal.textContent  = fmtMoney(total);
      kProm.textContent   = litros>0 ? fmtInt(prom) : "-";
      kCargas.textContent = String(cargas);
    }

    function renderLista(arr){
      lista.innerHTML = "";
      if (!arr.length){
        const m = document.createElement("div");
        m.className = "item";
        m.innerHTML = "<p>No hay cargas para mostrar.</p>";
        lista.appendChild(m);
        return;
      }
      for (const c of arr){
        const litros = combLitros(c);
        const total  = combTotal(c);
        const pl     = litros>0 ? total/litros : 0;
        const obs    = (c.observaciones && String(c.observaciones).trim()) ? `<span class="pill warn">OBSERVACIONES</span>` : "";

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="row">
            <h3>${combEstacion(c) || "—"}</h3>
            <div class="meta"><span>Fecha: <b>${dmy(combFecha(c))}</b></span> · <span>Patente: <b>${combPatente(c)||"—"}</b></span></div>
          </div>
          <div class="meta" style="margin-top:6px">
            <span>Tipo: <b>${combTipo(c)||"—"}</b></span>
            <span>Método: <b>${combMetodo(c)||"—"}</b></span>
          </div>
          <div style="margin-top:8px">
            <span class="pill">Litros: ${fmtInt(litros)} l</span>
            <span class="pill">$/l: ${pl? fmtInt(pl) : "-"}</span>
            <span class="pill">Total: ${fmtMoney(total)}</span>
            ${obs}
          </div>
        `;
        lista.appendChild(el);
      }
    }

    function sortAndRender(){
      const arr = datosFiltrados();
      actualizarResumen(arr);
      renderLista(arr);
      const a = cargadasA?"ok":"—", b=cargadasB?"ok":"—";
      dbg.textContent = `colecciones → cargas-combustible:${a} · cargasCombustible:${b}${lastErr?` · ERROR: ${lastErr}`:""}`;
    }

    q.addEventListener("input", sortAndRender);
    orden.addEventListener("change", sortAndRender);
  </script>
</body>
</html>
