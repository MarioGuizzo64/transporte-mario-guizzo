<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VER COMBUSTIBLE – ADMIN</title>
  <style>
    body{margin:0;background:#FFD700;font-family:Arial,sans-serif;color:#fff;}
    .container{
      background:#000;
      max-width:980px;
      margin:40px auto;
      padding:24px;
      border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    h1{text-align:center;text-transform:uppercase;text-decoration:underline;margin:0 0 16px}
    .btn{padding:10px;border:1px solid #000;border-radius:6px;font-weight:bold;cursor:pointer;text-transform:uppercase}
    .btn-verde{background:green;color:#fff}
    .btn-naranja{background:orange;color:#000}
    .btn-rojo{background:red;color:#fff}
    .btn-azul{background:#1e40af;color:#fff}
    .filtros{display:grid;grid-template-columns:repeat(auto-fit, minmax(160px,1fr));gap:8px;margin:0 0 16px 0;align-items:center}
    .filtros input,.filtros select{padding:8px;border:1px solid #000;border-radius:4px;color:#000;background:#fff}
    .lista{display:grid;gap:10px}
    .item{background:#191919;border-radius:10px;padding:12px}
    .item p{margin:3px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{display:inline-block;background:#333;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:8px}
    .resumen{background:#111;border:1px solid #222;border-radius:10px;padding:10px 12px;margin:0 0 16px 0;display:grid;grid-template-columns:repeat(auto-fit, minmax(160px,1fr));gap:8px;}
    .resumen .card{background:#0f1a0f;border:1px solid #1f3d1f;border-radius:8px;padding:10px;text-align:center;}
    .resumen .card .label{font-size:12px;color:#a0d8a0;text-transform:uppercase}
    .resumen .card .value{font-weight:bold;font-size:18px}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center}
    .modal-content{background:#000;border-radius:12px;padding:16px;width:95%;max-width:650px;box-shadow:0 10px 30px rgba(0,0,0,.5)}
    .modal-content h2{margin:0 0 12px;text-transform:uppercase;text-decoration:underline}
    .edit-form{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .edit-form label{grid-column:span 2;font-weight:bold;text-transform:uppercase}
    .edit-form input,.edit-form select,.edit-form textarea{padding:8px;border:1px solid #000;border-radius:4px;background:#fff;color:#000}
    .edit-form textarea{grid-column:span 2;height:70px;resize:vertical}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    @media (max-width:800px){ .edit-form{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ver Combustible</h1>

    <!-- FILTROS -->
    <form class="filtros" id="formFiltros">
      <button type="button" class="btn btn-verde" id="btnNueva">Nueva carga</button>
      <input type="date" id="desde"/>
      <input type="date" id="hasta"/>
      <select id="rangoRapido">
        <option value="">Período…</option>
        <option value="mes-actual">Mes actual</option>
        <option value="mes-pasado">Mes pasado</option>
        <option value="ultimos-30">Últimos 30 días</option>
        <option value="todo">Todo</option>
      </select>
      <select id="fPatente"><option value="">Todas las patentes</option></select>
      <select id="fTipo"><option value="">Todos los tipos</option></select>
      <select id="fMetodo"><option value="">Todos los métodos</option></select>
      <input type="text" id="fCuitOrigen" placeholder="CUIT origen (opcional)"/>
      <input type="text" id="buscar" placeholder="Buscar (estación, patente, obs)"/>
      <button type="button" class="btn btn-naranja" id="btnLimpiar">Limpiar</button>
      <button type="button" class="btn btn-azul" id="btnImprimir">Imprimir</button>
    </form>

    <!-- RESUMEN -->
    <div id="resumen" class="resumen">
      <div class="card"><div class="label">Litros</div><div class="value" id="r_litros">-</div></div>
      <div class="card"><div class="label">Total $</div><div class="value" id="r_total">$ -</div></div>
      <div class="card"><div class="label">$/Litro prom.</div><div class="value" id="r_promedio">-</div></div>
      <div class="card"><div class="label">Cargas</div><div class="value" id="r_cargas">-</div></div>
    </div>

    <!-- LISTA -->
    <div id="lista" class="lista"></div>

    <button class="btn btn-naranja" onclick="location.href='admin.html'">Volver</button>
  </div>

  <!-- MODAL DETALLE/EDICIÓN -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2>Detalle / Editar carga</h2>
      <form id="formEdit" class="edit-form">
        <label>Fecha</label><input type="date" id="e_fecha"/>
        <label>Patente del camión</label><input type="text" id="e_patente"/>
        <label>Litros cargados</label><input type="number" step="0.01" id="e_litros"/>
        <label>Precio por litro</label><input type="number" step="0.01" id="e_precioLitro"/>
        <label>Importe total</label><input type="number" step="0.01" id="e_total"/>
        <label>Estación de servicio</label><input type="text" id="e_estacion"/>
        <label>Tipo de combustible</label>
        <select id="e_tipo">
          <option value="">Seleccionar…</option>
          <option>Nafta</option>
          <option>Gasoil</option>
          <option>Euro</option>
          <option>Otro</option>
        </select>
        <label>Método de pago</label>
        <select id="e_metodo">
          <option value="">Seleccionar…</option>
          <option>Efectivo</option>
          <option>Tarjeta</option>
          <option>Cuenta corriente</option>
          <option>Transferencia</option>
        </select>
        <label>Observaciones</label><textarea id="e_obs"></textarea>
      </form>
      <div class="modal-actions">
        <button id="btnGuardar" class="btn btn-verde" type="button">Guardar</button>
        <button id="btnEliminar" class="btn btn-rojo" type="button">Eliminar</button>
        <button id="btnCerrar" class="btn btn-naranja" type="button">Cerrar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDGqynxRT1kEafI3xFdo9dM1gu2RIqWxxU",
      authDomain: "transporte-mario-guizzo.firebaseapp.com",
      projectId: "transporte-mario-guizzo",
      storageBucket: "transporte-mario-guizzo.appspot.com",
      messagingSenderId: "465536166890",
      appId: "1:465536166890:web:f658690629b09eca8fa093"
    };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Utils
    const fmt = (n, suf="") => (n ?? "") === "" ? "-" : `${Number(n).toLocaleString("es-AR",{maximumFractionDigits:2})}${suf}`;
    const fmtDMY = (f) => {
      if(!f) return '—';
      const d = new Date(f);
      if (isNaN(d)) return '—';
      const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yy=d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    };
    const parseFecha = (f) => {
      if (!f) return null;
      if (f.includes("-")) return new Date(f);
      if (f.includes("/")) { const [dd,mm,aa] = f.split("/"); return new Date(+aa, +mm-1, +dd); }
      const d = new Date(f); return isNaN(d) ? null : d;
    };

    onAuthStateChanged(auth, (user) => {
      if (!user) { window.location.href = "login.html"; return; }
      start(user);
    });

    function start(user){
      const lista = document.getElementById("lista");
      const fDesde = document.getElementById("desde");
      const fHasta = document.getElementById("hasta");
      const rangoRapido = document.getElementById("rangoRapido");
      const fPatente = document.getElementById("fPatente");
      const fTipo = document.getElementById("fTipo");
      const fMetodo = document.getElementById("fMetodo");
      const fBuscar = document.getElementById("buscar");
      const fCuitOrigen = document.getElementById("fCuitOrigen");
      const btnLimpiar = document.getElementById("btnLimpiar");
      const btnImprimir = document.getElementById("btnImprimir");
      const btnNueva = document.getElementById("btnNueva");

      const rLitros = document.getElementById("r_litros");
      const rTotal  = document.getElementById("r_total");
      const rProm   = document.getElementById("r_promedio");
      const rCargas = document.getElementById("r_cargas");

      let todas = [];         // merge de ambas colecciones
      let actualId = null;    // id del doc abierto
      let actualCol = null;   // nombre de colección del doc abierto

      // Escuchar AMBAS colecciones y unificarlas
      let A = [], B = [];
      const refA = collection(db, "cargas-combustible");
      const refB = collection(db, "cargasCombustible");

      const rebuild = () => {
        todas = [...A, ...B];
        // ordenar por fecha/timestamp desc
        todas.sort((a,b)=> {
          const da = parseFecha(a.fecha) || (a.timestamp ? new Date(a.timestamp) : new Date(0));
          const dbb= parseFecha(b.fecha) || (b.timestamp ? new Date(b.timestamp) : new Date(0));
          return dbb - da;
        });
        poblarSelects();
        render();
      };

      onSnapshot(refA, (qs) => {
        A = qs.docs.map(d => ({ id:d.id, _col:'cargas-combustible', ...d.data() }));
        rebuild();
      });
      onSnapshot(refB, (qs) => {
        B = qs.docs.map(d => ({ id:d.id, _col:'cargasCombustible', ...d.data() }));
        rebuild();
      });

      function poblarSelects(){
        const patentes = Array.from(new Set(todas.map(x => x.patenteCamion).filter(Boolean))).sort();
        const tipos    = Array.from(new Set(todas.map(x => x.tipoCombustible).filter(Boolean))).sort();
        const metodos  = Array.from(new Set(todas.map(x => x.metodoPago).filter(Boolean))).sort();
        const pSel = fPatente.value, tSel = fTipo.value, mSel = fMetodo.value;
        fPatente.innerHTML = '<option value="">Todas las patentes</option>' + patentes.map(p=>`<option value="${p}">${p}</option>`).join('');
        fTipo.innerHTML    = '<option value="">Todos los tipos</option>' + tipos.map(t=>`<option value="${t}">${t}</option>`).join('');
        fMetodo.innerHTML  = '<option value="">Todos los métodos</option>' + metodos.map(m=>`<option value="${m}">${m}</option>`).join('');
        if (pSel) fPatente.value = pSel;
        if (tSel) fTipo.value = tSel;
        if (mSel) fMetodo.value = mSel;
      }

      function pasaFiltros(x){
        if (fDesde.value) { const d = parseFecha(x.fecha); if (!d || d < new Date(fDesde.value)) return false; }
        if (fHasta.value) { const d = parseFecha(x.fecha); if (!d || d > new Date(fHasta.value)) return false; }
        if (fPatente.value && x.patenteCamion !== fPatente.value) return false;
        if (fTipo.value && x.tipoCombustible !== fTipo.value) return false;
        if (fMetodo.value && x.metodoPago !== fMetodo.value) return false;
        if (fCuitOrigen.value) {
          const co = (x.cuitOrigen || "").toString();
          if (!co.includes(fCuitOrigen.value.trim())) return false;
        }
        const q = fBuscar.value.trim().toLowerCase();
        if (q){
          const blob = [ x.estacionServicio, x.patenteCamion, x.observaciones, x.tipoCombustible, x.metodoPago ]
            .map(s => (s||"")+"").join(" ").toLowerCase();
          if (!blob.includes(q)) return false;
        }
        return true;
      }

      function calcTotal(c){
        const L = Number(c.litros || 0);
        if (c.totalPagado==null || c.totalPagado===""){
          const ppl = (c.precioPorLitro!=null) ? Number(c.precioPorLitro) : null;
          return (ppl!=null && L>0) ? ppl*L : null;
        }
        return Number(c.totalPagado);
      }
      function precioPorLitro(c){
        const L = Number(c.litros || 0);
        if (c.precioPorLitro!=null) return Number(c.precioPorLitro);
        const tot = (c.totalPagado!=null)? Number(c.totalPagado) : null;
        return (L>0 && tot!=null) ? (tot/L) : null;
      }

      function actualizarResumen(datos){
        const cargas = datos.length;
        let totalLitros = 0, totalGasto  = 0;
        for (const c of datos){
          const L = Number(c.litros || 0);
          const T = calcTotal(c) ?? 0;
          totalLitros += L;
          totalGasto  += T;
        }
        const prom = (totalLitros>0) ? (totalGasto/totalLitros) : 0;
        rLitros.textContent = fmt(totalLitros, " l");
        rTotal.textContent  = "$ " + fmt(totalGasto);
        rProm.textContent   = (totalLitros>0)? fmt(prom) : "-";
        rCargas.textContent = cargas.toString();
      }

      function render(){
        const datos = todas.filter(pasaFiltros);
        actualizarResumen(datos);
        lista.innerHTML = "";
        if (!datos.length){
          lista.innerHTML = '<div class="item"><p>No hay cargas para los filtros seleccionados.</p></div>';
          return;
        }
        for (const c of datos){
          const L = Number(c.litros || 0);
          const tot = calcTotal(c);
          const plitro = precioPorLitro(c);
          const obsPill = c.observaciones ? '<span class="pill" style="background:#b71c1c">OBSERVACIONES</span>' : '';
          const key = `${c._col}|${c.id}`;
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <div class="row">
              <div><strong>Fecha:</strong> ${fmtDMY(c.fecha)} ${obsPill}</div>
              <div><strong>Patente:</strong> ${c.patenteCamion || '-'}</div>
            </div>
            <p><strong>Estación:</strong> ${c.estacionServicio || '-'}
               &nbsp;|&nbsp; <strong>Tipo:</strong> ${c.tipoCombustible || '-'}
               &nbsp;|&nbsp; <strong>Método:</strong> ${c.metodoPago || '-'}</p>
            <p><strong>Litros:</strong> ${fmt(L,' l')}
               &nbsp;|&nbsp; <strong>$/l:</strong> ${plitro!=null?fmt(plitro):'-'}
               &nbsp;|&nbsp; <strong>Total:</strong> ${tot!=null? '$ '+fmt(tot) : '-'}</p>
            <div style="display:flex;justify-content:flex-end;">
              <button class="btn btn-verde" onclick="window._abrir('${key}')">Ver / Editar</button>
            </div>
          `;
          lista.appendChild(div);
        }
      }

      // Rango rápido
      rangoRapido.addEventListener('change', ()=>{
        const now = new Date();
        const y = now.getFullYear(), m = now.getMonth();
        if (rangoRapido.value==='mes-actual'){
          fDesde.value = new Date(y,m,1).toISOString().slice(0,10);
          fHasta.value = new Date(y,m+1,0).toISOString().slice(0,10);
        }else if (rangoRapido.value==='mes-pasado'){
          fDesde.value = new Date(y,m-1,1).toISOString().slice(0,10);
          fHasta.value = new Date(y,m,0).toISOString().slice(0,10);
        }else if (rangoRapido.value==='ultimos-30'){
          const d = new Date(); d.setDate(d.getDate()-30);
          fDesde.value = d.toISOString().slice(0,10);
          fHasta.value = new Date().toISOString().slice(0,10);
        }else if (rangoRapido.value==='todo'){
          fDesde.value=''; fHasta.value='';
        }else{
          fDesde.value=''; fHasta.value='';
        }
        render();
      });

      [fDesde,fHasta,fPatente,fTipo,fMetodo,fCuitOrigen,fBuscar].forEach(el => el.addEventListener('input', render));
      btnLimpiar.addEventListener('click', ()=>{ fDesde.value=''; fHasta.value=''; rangoRapido.value=''; fPatente.value=''; fTipo.value=''; fMetodo.value=''; fCuitOrigen.value=''; fBuscar.value=''; render(); });
      btnNueva.addEventListener('click', ()=>{ window.location.href='agregar-combustible.html'; });

      /* ====== IMPRIMIR ====== */
      btnImprimir.addEventListener('click', ()=>{
        const datos = todas.filter(pasaFiltros);
        let tLitros=0, tTotal=0;
        for (const c of datos){
          const L = Number(c.litros || 0);
          const T = calcTotal(c) ?? 0;
          tLitros += L; tTotal += T;
        }
        const tProm = tLitros>0 ? (tTotal/tLitros) : 0;
        const rows = datos.map(c=>{
          const L = Number(c.litros || 0);
          const T = calcTotal(c);
          const P = precioPorLitro(c);
          return `
            <tr>
              <td>${fmtDMY(c.fecha)}</td>
              <td>${c.patenteCamion || '-'}</td>
              <td>${c.estacionServicio || '-'}</td>
              <td>${c.tipoCombustible || '-'}</td>
              <td>${c.metodoPago || '-'}</td>
              <td class="r">${fmt(L)}</td>
              <td class="r">${P!=null?fmt(P):'-'}</td>
              <td class="r">${T!=null?fmt(T):'-'}</td>
            </tr>`;
        }).join('');

        const html = `
<!DOCTYPE html><html><head><meta charset="utf-8"><title>Cargas de combustible</title>
<style>
  body{font-family:Arial;margin:24px;color:#111}
  h2{margin:0 0 10px}
  .note{font-size:12px;color:#555;margin-bottom:8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  th{background:#f5f5f5}
  .r{text-align:right}
  tfoot td{font-weight:bold;background:#fafafa}
</style></head>
<body onload="window.print()">
  <h2>Cargas de combustible</h2>
  <div class="note">
    Rango: ${fDesde.value?fmtDMY(fDesde.value):'—'} a ${fHasta.value?fmtDMY(fHasta.value):'—'} ·
    Patente: ${fPatente.value||'Todas'} · Tipo: ${fTipo.value||'Todos'} · Método: ${fMetodo.value||'Todos'} ·
    CUIT: ${fCuitOrigen.value||'—'} · Búsqueda: ${fBuscar.value||'—'}
  </div>
  <table>
    <thead>
      <tr>
        <th>Fecha</th><th>Patente</th><th>Estación</th><th>Tipo</th><th>Método</th>
        <th class="r">Litros</th><th class="r">$/l</th><th class="r">Total $</th>
      </tr>
    </thead>
    <tbody>${rows || '<tr><td colspan="8">Sin datos</td></tr>'}</tbody>
    <tfoot>
      <tr>
        <td colspan="5">Totales</td>
        <td class="r">${fmt(tLitros)}</td>
        <td class="r">${tLitros>0?fmt(tProm):'-'}</td>
        <td class="r">${fmt(tTotal)}</td>
      </tr>
    </tfoot>
  </table>
</body></html>`;
        const w = window.open('', '_blank', 'width=900,height=1000');
        w.document.write(html); w.document.close(); w.focus();
      });

      // ------- MODAL -------
      const modal = document.getElementById("modal");
      const get = id => document.getElementById(id);

      window._abrir = (key) => {
        // key: "<col>|<id>"
        const [colName, id] = String(key).split('|');
        const c = todas.find(x => x.id === id && x._col === colName);
        if (!c) return;
        actualId = id; actualCol = colName;
        get('e_fecha').value = c.fecha || '';
        get('e_patente').value = c.patenteCamion || '';
        get('e_litros').value = c.litros || '';
        get('e_precioLitro').value = (c.precioPorLitro ?? '');
        get('e_total').value = (c.totalPagado ?? '');
        get('e_estacion').value = c.estacionServicio || '';
        get('e_tipo').value = c.tipoCombustible || '';
        get('e_metodo').value = c.metodoPago || '';
        get('e_obs').value = c.observaciones || '';
        modal.style.display = 'flex';
      };

      document.getElementById('btnCerrar').onclick = ()=> modal.style.display='none';

      document.getElementById('btnGuardar').onclick = async ()=>{
        const data = {
          fecha: get('e_fecha').value || null,
          patenteCamion: get('e_patente').value.trim(),
          litros: Number(get('e_litros').value || 0),
          precioPorLitro: get('e_precioLitro').value==='' ? null : Number(get('e_precioLitro').value),
          totalPagado: get('e_total').value==='' ? null : Number(get('e_total').value),
          estacionServicio: get('e_estacion').value.trim(),
          tipoCombustible: get('e_tipo').value,
          metodoPago: get('e_metodo').value,
          observaciones: get('e_obs').value.trim()
        };
        try{
          await updateDoc(doc(db, actualCol, actualId), data);
          alert('Carga actualizada');
          modal.style.display='none';
        }catch(err){
          alert('Error al guardar: ' + err.message);
        }
      };

      document.getElementById('btnEliminar').onclick = async ()=>{
        if (!confirm('¿Eliminar esta carga?')) return;
        try{
          await deleteDoc(doc(db, actualCol, actualId));
          modal.style.display='none';
        }catch(err){
          alert('Error al eliminar: ' + err.message);
        }
      };
    }
  </script>
</body>
</html>
